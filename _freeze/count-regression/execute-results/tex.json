{
  "hash": "d79219aa58a891eb422a5b610fc9f0ad",
  "result": {
    "engine": "knitr",
    "markdown": "---\nsubtitle: \"Poisson regression and variations\"\n---\n\n\n\n\n\n\n\n\n# Models for Count Outcomes\n\n---\n\n## Acknowledgements {.unnumbered}\n\nThis content is adapted from:\n\n-   @dobson4e, Chapter 9\n-   @vittinghoff2e, Chapter 8\n\n---\n\n\n<!-- ::: {.content-hidden when-format=\"revealjs\"} -->\n\n---\n\n### Configuring R {.unnumbered}\n\nFunctions from these packages will be used throughout this document:\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(conflicted) # check for conflicting function definitions\n# library(printr) # inserts help-file output into markdown output\nlibrary(rmarkdown) # Convert R Markdown documents into a variety of formats.\nlibrary(pander) # format tables for markdown\nlibrary(ggplot2) # graphics\nlibrary(ggeasy) # help with graphics\nlibrary(ggfortify) # help with graphics\nlibrary(dplyr) # manipulate data\nlibrary(tibble) # `tibble`s extend `data.frame`s\nlibrary(magrittr) # `%>%` and other additional piping tools\nlibrary(haven) # import Stata files\nlibrary(knitr) # format R output for markdown\nlibrary(tidyr) # Tools to help to create tidy data\nlibrary(plotly) # interactive graphics\nlibrary(dobson) # datasets from Dobson and Barnett 2018\nlibrary(parameters) # format model output tables for markdown\nlibrary(haven) # import Stata files\nlibrary(latex2exp) # use LaTeX in R code (for figures and tables)\nlibrary(fs) # filesystem path manipulations\nlibrary(survival) # survival analysis\nlibrary(survminer) # survival analysis graphics\nlibrary(KMsurv) # datasets from Klein and Moeschberger\nlibrary(parameters) # format model output tables for\nlibrary(webshot2) # convert interactive content to static for pdf\nlibrary(forcats) # functions for categorical variables (\"factors\")\nlibrary(stringr) # functions for dealing with strings\nlibrary(lubridate) # functions for dealing with dates and times\n```\n:::\n\n\n\n\n\n\n\nHere are some R settings I use in this document:\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrm(list = ls()) # delete any data that's already loaded into R\n\nconflicts_prefer(dplyr::filter)\nggplot2::theme_set(\n  ggplot2::theme_bw() + \n        # ggplot2::labs(col = \"\") +\n    ggplot2::theme(\n      legend.position = \"bottom\",\n      text = ggplot2::element_text(size = 12, family = \"serif\")))\n\nknitr::opts_chunk$set(message = FALSE)\noptions('digits' = 4)\n\npanderOptions(\"big.mark\", \",\")\npander::panderOptions(\"table.emphasize.rownames\", FALSE)\npander::panderOptions(\"table.split.table\", Inf)\nconflicts_prefer(dplyr::filter) # use the `filter()` function from dplyr() by default\nlegend_text_size = 9\n```\n:::\n\n\n\n\n\n\n\n<!-- ::: -->\n\n\n\n\\providecommand{\\cbl}[1]{\\left\\{#1\\right.}\n\\providecommand{\\cb}[1]{\\left\\{#1\\right\\}}\n\\providecommand{\\paren}[1]{\\left(#1\\right)}\n\\providecommand{\\sb}[1]{\\left[#1\\right]}\n\\def\\pr{\\text{p}}\n\\def\\am{\\arg \\max}\n\\def\\argmax{\\arg \\max}\n\\def\\p{\\text{p}}\n\\def\\P{\\text{P}}\n\\def\\ph{\\hat{\\text{p}}}\n\\def\\hp{\\hat{\\text{p}}}\n\\def\\ga{\\alpha}\n\\def\\b{\\beta}\n\\providecommand{\\floor}[1]{\\left \\lfloor{#1}\\right \\rfloor}\n\\providecommand{\\ceiling}[1]{\\left \\lceil{#1}\\right \\rceil}\n\\providecommand{\\ceil}[1]{\\left \\lceil{#1}\\right \\rceil}\n\\def\\Ber{\\text{Ber}}\n\\def\\Bernoulli{\\text{Bernoulli}}\n\\def\\Pois{\\text{Pois}}\n\\def\\Poisson{\\text{Poisson}}\n\\def\\Gaus{\\text{Gaussian}}\n\\def\\Normal{\\text{N}}\n\\def\\NB{\\text{NegBin}}\n\\def\\NegBin{\\text{NegBin}}\n\\def\\vbeta{\\vec \\beta}\n\\def\\vb{\\vec \\b}\n\\def\\v0{\\vec{0}}\n\\def\\gb{\\beta}\n\\def\\gg{\\gamma}\n\\def\\gd{\\delta}\n\\def\\eps{\\varepsilon}\n\\def\\om{\\omega}\n\\def\\m{\\mu}\n\\def\\s{\\sigma}\n\\def\\l{\\lambda}\n\\def\\gs{\\sigma}\n\\def\\gm{\\mu}\n\\def\\M{\\text{M}}\n\\def\\gM{\\text{M}}\n\\def\\Mu{\\text{M}}\n\\def\\cd{\\cdot}\n\\def\\cds{\\cdots}\n\\def\\lds{\\ldots}\n\\def\\eqdef{\\stackrel{\\text{def}}{=}}\n\\def\\defeq{\\stackrel{\\text{def}}{=}}\n\\def\\hb{\\hat \\beta}\n\\def\\hl{\\hat \\lambda}\n\\def\\hy{\\hat y}\n\\def\\yh{\\hat y}\n\\def\\V{{\\text{Var}}}\n\\def\\hs{\\hat \\sigma}\n\\def\\hsig{\\hat \\sigma}\n\\def\\hS{\\hat \\Sigma}\n\\def\\hSig{\\hat \\Sigma}\n\\def\\hSigma{\\hat \\Sigma}\n\\def\\hSurv{\\hat{S}}\n\\providecommand{\\hSurvf}[1]{\\hat{S}\\paren{#1}}\n\\def\\dist{\\ \\sim \\ }\n\\def\\ddist{\\ \\dot{\\sim} \\ }\n\\def\\dsim{\\ \\dot{\\sim} \\ }\n\\def\\za{z_{1 - \\frac{\\alpha}{2}}}\n\\def\\cirad{\\za \\cdot \\hse{\\hb}}\n\\def\\ci{\\hb {\\color{red}\\pm} \\cirad}\n\\def\\th{\\theta}\n\\def\\Th{\\Theta}\n\\def\\xbar{\\bar{x}}\n\\def\\hth{\\hat\\theta}\n\\def\\hthml{\\hth_{\\text{ML}}}\n\\def\\ba{\\begin{aligned}}\n\\def\\ea{\\end{aligned}}\n\\def\\ind{тлл}\n\\def\\indpt{тлл}\n\\def\\all{\\forall}\n\\def\\iid{\\text{iid}}\n\\def\\ciid{\\text{ciid}}\n\\def\\simind{\\ \\sim_{\\ind}\\ }\n\\def\\siid{\\ \\sim_{\\iid}\\ }\n\\def\\simiid{\\siid}\n\\def\\distiid{\\siid}\n\\def\\tf{\\therefore}\n\\def\\Lik{\\mathcal{L}}\n\\def\\llik{\\ell}\n\\providecommand{\\llikf}[1]{\\llik \\paren{#1}}\n\\def\\score{\\ell'}\n\\providecommand{\\scoref}[1]{\\score \\paren{#1}}\n\\def\\hess{\\ell''}\n\\def\\hessian{\\ell''}\n\\providecommand{\\hessf}[1]{\\hess \\paren{#1}}\n\\providecommand{\\hessianf}[1]{\\hess \\paren{#1}}\n\\providecommand{\\starf}[1]{#1^*}\n\\def\\lik{\\ell}\n\\providecommand{\\est}[1]{\\widehat{#1}}\n\\providecommand{\\esttmp}[1]{{\\widehat{#1}}^*}\n\\def\\esttmpl{\\esttmp{\\lambda}}\n\\def\\cR{\\mathcal{R}}\n\\def\\range{\\mathcal{R}}\n\\def\\Range{\\mathcal{R}}\n\\providecommand{\\rangef}[1]{\\cR(#1)}\n\\def\\~{\\approx}\n\\def\\dapp{\\dot\\approx}\n\\providecommand{\\red}[1]{{\\color{red}#1}}\n\\providecommand{\\deriv}[1]{\\frac{\\partial}{\\partial #1}}\n\\providecommand{\\derivf}[2]{\\frac{\\partial #1}{\\partial #2}}\n\\providecommand{\\blue}[1]{{\\color{blue}#1}}\n\\providecommand{\\green}[1]{{\\color{green}#1}}\n\\providecommand{\\hE}[1]{\\hat{\\text{E}}\\sb{#1}}\n\\providecommand{\\hExp}[1]{\\hat{\\text{E}}\\sb{#1}}\n\\providecommand{\\hmu}[1]{\\hat{\\mu}\\sb{#1}}\n\\def\\Expp{\\mathbb{E}}\n\\def\\Ep{\\mathbb{E}}\n\\def\\expit{\\text{expit}}\n\\providecommand{\\expitf}[1]{\\expit\\cb{#1}}\n\\providecommand{\\dexpitf}[1]{\\expit'\\cb{#1}}\n\\def\\logit{\\text{logit}}\n\\providecommand{\\logitf}[1]{\\logit\\cb{#1}}\n\\providecommand{\\E}[1]{\\mathbb{E}\\sb{#1}}\n\\providecommand{\\Ef}[1]{\\mathbb{E}\\sb{#1}}\n\\providecommand{\\Exp}[1]{\\mathbb{E}\\sb{#1}}\n\\providecommand{\\Expf}[1]{\\mathbb{E}\\sb{#1}}\n\\def\\Varr{\\text{Var}}\n\\providecommand{\\var}[1]{\\text{Var}\\paren{#1}}\n\\providecommand{\\varf}[1]{\\text{Var}\\paren{#1}}\n\\providecommand{\\Var}[1]{\\text{Var}\\paren{#1}}\n\\providecommand{\\Varf}[1]{\\text{Var}\\paren{#1}}\n\\def\\Covt{\\text{Cov}}\n\\providecommand{\\covh}[1]{\\widehat{\\text{Cov}}\\paren{#1}}\n\\providecommand{\\Cov}[1]{\\Covt \\paren{#1}}\n\\providecommand{\\Covf}[1]{\\Covt \\paren{#1}}\n\\def\\varht{\\widehat{\\text{Var}}}\n\\providecommand{\\varh}[1]{\\varht\\paren{#1}}\n\\providecommand{\\varhf}[1]{\\varht\\paren{#1}}\n\\providecommand{\\vc}[1]{\\boldsymbol{#1}}\n\\providecommand{\\sd}[1]{\\text{sd}\\paren{#1}}\n\\providecommand{\\SD}[1]{\\text{SD}\\paren{#1}}\n\\providecommand{\\hSD}[1]{\\widehat{\\text{SD}}\\paren{#1}}\n\\providecommand{\\se}[1]{\\text{se}\\paren{#1}}\n\\providecommand{\\hse}[1]{\\hat{\\text{se}}\\paren{#1}}\n\\providecommand{\\SE}[1]{\\text{SE}\\paren{#1}}\n\\providecommand{\\HSE}[1]{\\widehat{\\text{SE}}\\paren{#1}}\n\\renewcommand{\\log}[1]{\\text{log}\\cb{#1}}\n\\providecommand{\\logf}[1]{\\text{log}\\cb{#1}}\n\\def\\dlog{\\text{log}'}\n\\providecommand{\\dlogf}[1]{\\dlog \\cb{#1}}\n\\renewcommand{\\exp}[1]{\\text{exp}\\cb{#1}}\n\\providecommand{\\expf}[1]{\\exp{#1}}\n\\def\\dexp{\\text{exp}'}\n\\providecommand{\\dexpf}[1]{\\dexp \\cb{#1}}\n\\providecommand{\\e}[1]{\\text{e}^{#1}}\n\\providecommand{\\ef}[1]{\\text{e}^{#1}}\n\\providecommand{\\inv}[1]{\\paren{#1}^{-1}}\n\\providecommand{\\invf}[1]{\\paren{#1}^{-1}}\n\\def\\oinf{I}\n\\def\\Nat{\\mathbb{N}}\n\\providecommand{\\oinff}[1]{\\oinf\\paren{#1}}\n\\def\\einf{\\mathcal{I}}\n\\providecommand{\\einff}[1]{\\einf\\paren{#1}}\n\\def\\heinf{\\hat{\\einf}}\n\\providecommand{\\heinff}[1]{\\heinf \\paren{#1}}\n\\providecommand{\\1}[1]{\\mathbb{1}_{#1}}\n\\providecommand{\\set}[1]{\\cb{#1}}\n\\providecommand{\\pf}[1]{\\p \\paren{#1}}\n\\providecommand{\\Bias}[1]{\\text{Bias}\\paren{#1}}\n\\providecommand{\\bias}[1]{\\text{Bias}\\paren{#1}}\n\\def\\ss{\\sigma^2}\n\\providecommand{\\ssqf}[1]{\\sigma^2\\paren{#1}}\n\\providecommand{\\mselr}[1]{\\text{MSE}\\paren{#1}}\n\\providecommand{\\maelr}[1]{\\text{MAE}\\paren{#1}}\n\\providecommand{\\abs}[1]{\\left|#1\\right|}\n\\providecommand{\\sqf}[1]{\\paren{#1}^2}\n\\providecommand{\\sq}{^2}\n\\def\\err{\\eps}\n\\providecommand{\\erf}[1]{\\err\\paren{#1}}\n\\renewcommand{\\vec}[1]{\\tilde{#1}}\n\\providecommand{\\v}[1]{\\vec{#1}}\n\\providecommand{\\matr}[1]{\\mathbf{#1}}\n\\def\\mX{\\matr{X}}\n\\def\\mx{\\matr{x}}\n\\def\\vx{\\vec{x}}\n\\def\\vX{\\vec{X}}\n\\def\\vy{\\vec{y}}\n\\def\\vY{\\vec{Y}}\n\\def\\vpi{\\vec{\\pi}}\n\\providecommand{\\mat}[1]{\\mathbf{#1}}\n\\providecommand{\\dsn}[1]{#1_1, \\ldots, #1_n}\n\\def\\X1n{\\dsn{X}}\n\\def\\Xin{\\dsn{X}}\n\\def\\x1n{\\dsn{x}}\n\\def\\'{^{\\top}}\n\\def\\dpr{\\cdot}\n\\def\\Xx1n{X_1=x_1, \\ldots, X_n = x_n}\n\\providecommand{\\dsvn}[2]{#1_1=#2_1, \\ldots, #1_n = #2_n}\n\\providecommand{\\sumn}[1]{\\sum_{#1=1}^n}\n\\def\\sumin{\\sum_{i=1}^n}\n\\def\\sumi1n{\\sum_{i=1}^n}\n\\def\\prodin{\\prod_{i=1}^n}\n\\def\\prodi1n{\\prod_{i=1}^n}\n\\providecommand{\\lp}[2]{#1 \\' \\beta}\n\\def\\odds{\\omega}\n\\def\\OR{\\text{OR}}\n\\def\\logodds{\\eta}\n\\def\\oddst{\\text{odds}}\n\\def\\probst{\\text{probs}}\n\\def\\probt{\\text{probt}}\n\\def\\probit{\\text{probit}}\n\\providecommand{\\oddsf}[1]{\\oddst\\cb{#1}}\n\\providecommand{\\doddsf}[1]{{\\oddst}'\\cb{#1}}\n\\def\\oddsinv{\\text{invodds}}\n\\providecommand{\\oddsinvf}[1]{\\oddsinv\\cb{#1}}\n\\def\\invoddsf{\\oddsinvf}\n\\providecommand{\\doddsinvf}[1]{{\\oddsinv}'\\cb{#1}}\n\\def\\dinvoddsf{\\doddsinvf}\n\\def\\haz{h}\n\\def\\cuhaz{H}\n\\def\\incidence{\\bar{\\haz}}\n\\def\\phaz{\\Expf{\\haz}}\n\n\n\n\n\n\n\n\n\n```{=html}\n<style>\n.quarto-figure-center > figure {\ntext-align: center;\n}\n</style>\n```\n\n\n\n\n\n\n\n\n\n## Introduction\n\n::: notes\nThis chapter presents models for \n[count data](probability.qmd#sec-count-vars) outcomes.\nWith covariates,\nthe event rate $\\lambda$ \nbecomes a function of the covariates\n$\\vX = (X_1, \\dots,X_n)$.\nTypically, count data models use\na $\\log{}$ link function,\nand thus an $\\exp{}$ inverse-link function. \nThat is:\n:::\n\n$$\n\\begin{aligned}\n\\Expp[Y | \\vX = \\vx, T = t] &= \\mu(\\vx,t)\n\\\\ \\mu(\\vx,t) &= \\lambda(\\vx)\\cdot t\n\\\\ \\lambda(\\vx) &= \\exp{\\eta(\\vx)}\n\\\\ \\eta(\\vx) &= \\vx'\\tilde \\beta = \\beta_0 + \\beta_1 x_1 + \\dots + \\beta_p x_p\n\\end{aligned}\n$$\n\nTherefore,\n$$\n\\begin{aligned}\n\\logf{\\Expp[Y | \\vX = \\vx,T=t]}\n&= \\logf{\\mu(\\vx)}\\\\\n&=\\logf{\\lambda(\\vx) \\cdot t}\\\\\n&=\\logf{\\lambda(\\vx)} + \\log{t}\\\\\n&=\\logf{\\exp{\\eta(\\vx)}} + \\log{t}\\\\\n&=\\eta(\\vx) + \\log{t}\\\\\n&=\\vx'\\tilde\\beta + \\log{t}\\\\\n&=(\\beta_0 +\\beta_1 x_1+\\dots + \\beta_p x_p) + \\log{t}\\\\\n\\end{aligned}\n$$\n\nIn contrast with the other covariates (represented by $\\vX$), $T$ enters this expression with a $\\log{}$ transformation and without a corresponding $\\beta$ coefficient. \n\n:::{.callout-note}\nTerms that enter the linear component of a model without a coefficient, such as $\\log{t}$ here, are called **offsets**.\n:::\n\n### Rate ratios {.smaller}\n\n::: notes\nDifferences on the log-rate scale become ratios on the rate scale, \nbecause\n:::\n\n$$\\exp{a-b} = \\frac{\\exp{a}}{\\exp{b}}$$\n\n(recall from [Algebra 2](math-prereqs.qmd#cor-exp-sum))\n\nTherefore, according to this model, \n**differences of $\\delta$ in covariate $x_j$ correspond to rate ratios of $\\exp{\\beta_j \\cdot \\delta}$**.\n\nThat is, letting $\\vX_{-j}$ denote vector $\\vX$ with element $j$ removed: \n\n$$\n\\begin{aligned}\n&{\n\\left\\{\n    \\log{\\Expp[Y |{\\color{red}{X_j = a}}, \\vX_{-j}=\\vx_{-j},T=t]}\n    \\atop \n    {-\\log{\\Expp[Y |{\\color{red}{X_j = b}}, \\vX_{-j}=\\vx_{-j},T=t]}}\n    \\right\\}\n}\\\\\n&= \n{\\left\\{\n\\log{t} + \\beta_0 + \\beta_1 x_1 + ... + {\\color{red}{\\beta_j (a)}} + ...+\\beta_p x_p \n\\atop \n{-\\log{t} + \\beta_0 + \\beta_1 x_1 + ... + {\\color{red}{\\beta_j (b)}} + ...+\\beta_p x_p}\n\\right\\}}\\\\\n&= \\color{red}{\\beta_j(a-b)}\n\\end{aligned}\n$$\n\nAnd accordingly,\n\n$$\n\\begin{aligned}\n\\frac\n{\\mathbb{E}[Y |{\\color{red}{X_j = a}}, \\vX_{-j} = \\vx_{-j}, T = t]\n}\n{\n\\Expp[Y |{\\color{red}{X_j = b}}, \\vX_{-j}=\\vx_{-j},T=t]\n}\n= \n\\exp{{\\color{red}{\\beta_j(a-b)}}}\n\\end{aligned}\n$$\n\n## Inference for count regression models\n\n### Confidence intervals for regression coefficients and rate ratios\n\nAs usual:\n\n$$\n\\beta \\in \\left[\\ci \\right]\n$$\n\nRate ratios: exponentiate CI endpoints\n\n$$\n\\exp{\\beta} \\in \\left[\\exp{\\ci} \\right]\n$$\n\n### Hypothesis tests for regression coefficients\n\n$$\nt = \\frac{\\hat \\beta - \\beta_0}{\\hse{\\hb}}\n$$\n\nCompare $t$ or $|t|$ to the tails of the standard Gaussian distribution, according to the null hypothesis.\n\n### Comparing nested models\n\nlog(likelihood ratio) tests, as usual.\n\n## Prediction\n\n$$\n\\begin{aligned}\n\\hat y \n&\\eqdef \\hat{\\Expp}[Y|\\vX= \\vx,T=t]\\\\\n&=\\hat\\mu(\\vx, t)\\\\\n&=\\hat\\lambda(\\vx) \\cdot t\\\\\n&=\\exp{\\hat\\eta(\\vx)} \\cdot t\\\\\n&=\\exp{\\vx'\\hat{\\boldsymbol{\\beta}}} \\cdot t\n\\end{aligned}\n$$\n\n## Diagnostics\n\n### Residuals\n\n#### Observation residuals\n\n$$e \\eqdef y - \\hat y$$\n\n#### Pearson residuals\n\n$$r = \\frac{e}{\\hse{e}} \\approx \\frac{e}{\\sqrt{\\hat y}}$$\n\n#### Standardized Pearson residuals\n\n$$r_p = \\frac{r}{\\sqrt{1-h}}$$\nwhere $h$ is the \"leverage\" (which we will continue to leave undefined).\n\n#### Deviance residuals\n\n$$\nd_k = \\text{sign}(y - \\hat y)\\left\\{\\sqrt{2[\\ell_{\\text{full}}(y) - \\ell(\\hat\\beta; y)]}\\right\\}\n$$\n\n:::{.callout-note}\n\n$$\\text{sign}(x) \\eqdef \\frac{x}{|x|}$$\nIn other words:\n\n* $\\text{sign}(x) = -1$ if $x < 0$\n* $\\text{sign}(x) = 0$ if $x = 0$\n* $\\text{sign}(x) = 1$ if $x > 0$\n\n::::{.content-hidden}\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(sign,xlim = c(-1,1), xlab = \"x\", ylab = \"sign(x)\")\n```\n\n::: {.cell-output-display}\n![](count-regression_files/figure-pdf/unnamed-chunk-3-1.pdf)\n:::\n:::\n\n\n\n\n\n\n\n\n::::\n\n:::\n\n\n## Zero-inflation\n\n### Models for zero-inflated counts\n\nWe assume a latent (unobserved) binary variable, $Z$, which we model using logistic regression:\n\n$$P(Z=1|X=x) = \\pi(x) = \\expit(\\gamma_0 + \\gamma_1 x_1 +...)$$\n\nAccording to this model, if $Z=1$, then $Y$ will always be zero, regardless of $X$ and $T$:\n\n$$P(Y=0|Z=1,X=x,T=t) = 1$$\n\nOtherwise (if $Z=0$), $Y$ will have a Poisson distribution, conditional on $X$ and $T$, as above.\n\nEven though we never observe $Z$, we can estimate the parameters $\\gamma_0$-$\\gamma_p$, via maximum likelihood:\n\n$$\n\\begin{aligned}\nP(Y=y|X=x,T=t) &= P(Y=y,Z=1|...) + P(Y=y,Z=0|...)\n\\end{aligned}\n$$\n(by the Law of Total Probability)\n\nwhere \n$$\n\\begin{aligned}\nP(Y=y,Z=z|...) \n&= P(Y=y|Z=z,...)P(Z=z|...)\n\\end{aligned}\n$$\n\n---\n\n::: {#exr-zinf-pmf}\nExpand $P(Y=0|X=x,T=t)$, $P(Y=1|X=x,T=t)$ and $P(Y=y|X=x,T=t)$ into expressions involving $P(Z=1|X=x,T=t)$ and $P(Y=y|Z=0,X=x,T=t)$.\n:::\n\n---\n\n::: {#exr-zinf-moments}\n\nDerive the expected value and variance of $Y$, conditional on $X$ and $T$, as functions of $P(Z=1|X=x,T=t)$ and $\\Expp[Y|Z=0,X=x,T=t]$.\n:::\n\n## Over-dispersion\n\n---\n\n::: notes\n\nThe Poisson distribution model **forces** the variance to equal the mean. \nIn practice, many count distributions will have a variance substantially larger than the mean (or occasionally, smaller).\n\n:::\n\n:::: {#def-overdispersion}\n#### Overdispersion\n\nA random variable $X$ is **overdispersed** \nrelative to a model $\\p(X=x)$ if\nif its empirical variance in a dataset is larger than \nthe value is predicted by the fitted model $\\hat{\\p}(X=x)$.\n\n::::\n\n::: notes\n\nc.f. \n@dobson4e ┬з3.2.1, 7.7, 9.8; \n@vittinghoff2e ┬з8.1.5; \nand <https://en.wikipedia.org/wiki/Overdispersion>.\n\nWhen we encounter overdispersion, \nwe can try to reduce the residual variance \nby adding more covariates. \n\n:::\n\n### Negative binomial models\n\nThere are alternatives to the Poisson model.\nMost notably, \nthe [negative binomial model](probability.qmd#sec-nb-dist).\n\nWe can still model $\\mu$ as a function of $X$ and $T$ as before, \nand we can combine this model with zero-inflation \n(as the conditional distribution for the non-zero component).\n\n### Quasipoisson\n\nAn alternative to Negative binomial is the \"quasipoisson\" distribution. I've never used it, but it seems to be a method-of-moments type approach rather than maximum likelihood. It models the variance as $\\Var{Y} = \\mu\\theta$, and estimates $\\theta$ accordingly.\n\nSee `?quasipoisson` in R for more.\n\n## Example: needle-sharing\n\n(adapted from @vittinghoff2e, ┬з8)\n\n\n\n\n\n\n\n\n::: {#tbl-needle-data .cell tbl-cap='Needle-sharing data'}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(haven)\nneedles = \n  \"inst/extdata/needle_sharing.dta\" |> \n  read_dta() |>\n  as_tibble() |>\n  mutate(\n    hivstat =\n      hivstat |>\n      case_match(\n        1 ~ \"HIV+\",\n        0 ~ \"HIV-\") |> \n      factor() |> \n      relevel(ref = \"HIV-\"),\n    polydrug =\n      polydrug |>\n      case_match(\n        1 ~ \"multiple drugs used\",\n        0 ~ \"one drug used\") |>\n      factor() |>\n      relevel(ref = \"one drug used\"),\n    homeless = \n      homeless |> \n      case_match(\n        1 ~ \"homeless\", \n        0 ~ \"not homeless\") |>\n      factor() |>\n      relevel(ref = \"not homeless\"),\n    sex = sex |> factor() |> relevel(ref = \"M\"))\nneedles\n#> # A tibble: 128 x 17\n#>       id sex   ethn       age dprsn_dx sexabuse shared_syr hivstat hplsns nivdu\n#>    <dbl> <fct> <chr>    <dbl>    <dbl>    <dbl>      <dbl> <fct>    <dbl> <dbl>\n#>  1  2104 M     White       47        5        0          1 HIV-         6    90\n#>  2  2009 M     White       39        1        0          1 HIV+         2     4\n#>  3  2032 M     White       52        1        0          1 HIV-        18    90\n#>  4  2063 M     AA          47        1        1          1 HIV-         1   120\n#>  5  2059 M     Hispanic    32        1        0          2 HIV-        12   120\n#>  6  2077 M     Hispanic    54        1        0          2 HIV-        10   120\n#>  7  2042 F     White       32        5        0          2 HIV-         8    15\n#>  8  2017 M     White       26        5        0          2 HIV-        11   120\n#>  9  2119 M     White       54        1        0          3 HIV-         2    90\n#> 10  2085 F     White       19        5        0          3 HIV-         7    90\n#> # i 118 more rows\n#> # i 7 more variables: shsyryn <dbl>, sqrtnivd <dbl>, logshsyr <dbl>,\n#> #   polydrug <fct>, sqrtninj <dbl>, homeless <fct>, shsyr <dbl>\n```\n:::\n\n\n\n\n\n\n\n---\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\n\nneedles |> \n  ggplot(\n    aes(\n      x = age,\n      y = shared_syr,\n      shape = sex,\n      col = ethn\n    )\n  ) + \n  geom_point(\n    size = 3, \n    alpha = .5) +\n  facet_grid(\n    cols = vars(sex, polydrug), \n    rows = vars(homeless)) +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![Rates of needle sharing](count-regression_files/figure-pdf/fig-needles-1.pdf){#fig-needles}\n:::\n:::\n\n\n\n\n\n\n\n#### Covariate counts\n\n\n\n\n\n\n\n::: {#tbl-count-needles .cell tbl-cap='Counts of observations in `needles` dataset by sex, unhoused status, and multiple drug use'}\n\n```{.r .cell-code  code-fold=\"show\"}\nneedles |> \n  dplyr::select(sex, homeless, polydrug) |> \n  summary()\n#>     sex             homeless                 polydrug  \n#>  M    :97   not homeless:63   one drug used      :109  \n#>  F    :30   homeless    :61   multiple drugs used: 19  \n#>  Trans: 1   NA's        : 4\n```\n:::\n\n\n\n\n\n\n\n---\n\nThere's only one individual with `sex = Trans`, \nwhich unfortunately isn't enough data to analyze.\nWe will remove that individual:\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"remove singleton observation with sex == Trans\"}\nneedles = needles |> filter(sex != \"Trans\")\n\n```\n:::\n\n\n\n\n\n\n\n---\n\n### models {.smaller}\n\n\n\n\n\n\n\n\n\n::: {#tbl-needles-pois .cell tbl-cap='Poisson model for needle-sharing data'}\n\n```{.r .cell-code}\nglm1 = glm(\n  data = needles,\n  family = stats::poisson,\n  shared_syr ~ age + sex + homeless*polydrug\n)\n\nlibrary(parameters)\nglm1 |> parameters(exponentiate = TRUE) |> \n  print_md()\n```\n\n::: {.cell-output-display}\n\n\n|Parameter                                            |      IRR |       SE |       95% CI |     z |      p |\n|:----------------------------------------------------|:--------:|:--------:|:------------:|:-----:|:------:|\n|(Intercept)                                          |     4.52 |     1.15 | (2.74, 7.45) |  5.90 | < .001 |\n|age                                                  |     0.97 | 5.58e-03 | (0.96, 0.98) | -5.41 | < .001 |\n|sex (F)                                              |     1.98 |     0.23 | (1.58, 2.49) |  5.88 | < .001 |\n|homeless (homeless)                                  |     3.58 |     0.45 | (2.79, 4.59) | 10.06 | < .001 |\n|polydrug (multiple drugs used)                       | 1.45e-07 | 5.82e-05 |  (0.00, Inf) | -0.04 | 0.969  |\n|homeless (homeless) ├Ч polydrug (multiple drugs used) | 1.27e+06 | 5.12e+08 |  (0.00, Inf) |  0.03 | 0.972  |\n\n\n:::\n:::\n\n::: {#tbl-pois-model-diagnostics .cell tbl-cap='Diagnostics for Poisson model'}\n\n```{.r .cell-code}\nlibrary(ggfortify)\nautoplot(glm1)\n```\n\n::: {.cell-output-display}\n![](count-regression_files/figure-pdf/tbl-pois-model-diagnostics-1.pdf)\n:::\n:::\n\n\n\n\n\n\n\n--\n\n\n\n\n\n\n\n::: {#tbl-needles-nb .cell tbl-cap='Negative binomial model for needle-sharing data'}\n\n```{.r .cell-code}\nlibrary(MASS) #need this for glm.nb()\nglm1.nb = glm.nb(\n  data = needles,\n  shared_syr ~ age + sex + homeless*polydrug\n)\nsummary(glm1.nb)\n#> \n#> Call:\n#> glm.nb(formula = shared_syr ~ age + sex + homeless * polydrug, \n#>     data = needles, init.theta = 0.08436295825, link = log)\n#> \n#> Coefficients:\n#>                                               Estimate Std. Error z value\n#> (Intercept)                                   9.91e-01   1.71e+00    0.58\n#> age                                          -2.76e-02   3.82e-02   -0.72\n#> sexF                                          1.06e+00   8.07e-01    1.32\n#> homelesshomeless                              1.65e+00   7.22e-01    2.29\n#> polydrugmultiple drugs used                  -2.46e+01   3.61e+04    0.00\n#> homelesshomeless:polydrugmultiple drugs used  2.32e+01   3.61e+04    0.00\n#>                                              Pr(>|z|)  \n#> (Intercept)                                     0.563  \n#> age                                             0.469  \n#> sexF                                            0.187  \n#> homelesshomeless                                0.022 *\n#> polydrugmultiple drugs used                     0.999  \n#> homelesshomeless:polydrugmultiple drugs used    0.999  \n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for Negative Binomial(0.0844) family taken to be 1)\n#> \n#>     Null deviance: 69.193  on 119  degrees of freedom\n#> Residual deviance: 57.782  on 114  degrees of freedom\n#>   (7 observations deleted due to missingness)\n#> AIC: 315.5\n#> \n#> Number of Fisher Scoring iterations: 1\n#> \n#> \n#>               Theta:  0.0844 \n#>           Std. Err.:  0.0197 \n#> \n#>  2 x log-likelihood:  -301.5060\n```\n:::\n\n::: {#tbl-compare-poisson-nb .cell tbl-cap='Poisson versus Negative Binomial Regression coefficient estimates'}\n\n```{.r .cell-code}\ntibble(name = names(coef(glm1)), poisson = coef(glm1), nb = coef(glm1.nb))\n#> # A tibble: 6 x 3\n#>   name                                          poisson       nb\n#>   <chr>                                           <dbl>    <dbl>\n#> 1 (Intercept)                                    1.51     0.991 \n#> 2 age                                           -0.0311  -0.0276\n#> 3 sexF                                           0.684    1.06  \n#> 4 homelesshomeless                               1.27     1.65  \n#> 5 polydrugmultiple drugs used                  -15.7    -24.6   \n#> 6 homelesshomeless:polydrugmultiple drugs used  14.1     23.2\n```\n:::\n\n\n\n\n\n\n\n#### zero-inflation\n\n\n\n\n\n\n\n::: {#tbl-zeroinf-poisson .cell tbl-cap='Zero-inflated poisson model'}\n\n```{.r .cell-code}\nlibrary(glmmTMB)\nzinf_fit1 = glmmTMB(\n  family = \"poisson\",\n  data  = needles,\n  formula = shared_syr ~ age + sex + homeless*polydrug,\n  ziformula = ~ age + sex + homeless + polydrug # fit won't converge with interaction\n)\n\nzinf_fit1 |> \n  parameters(exponentiate = TRUE) |> \n  print_md()\n```\n\n::: {.cell-output-display}\n\n\nTable: # Fixed Effects\n\n|Parameter                                            |      IRR |       SE |       95% CI |         z |      p |\n|:----------------------------------------------------|:--------:|:--------:|:------------:|:---------:|:------:|\n|(Intercept)                                          |     3.16 |     0.82 | (1.90, 5.25) |      4.44 | < .001 |\n|age                                                  |     1.01 | 5.88e-03 | (1.00, 1.02) |      1.74 | 0.081  |\n|sex [F]                                              |     3.43 |     0.44 | (2.67, 4.40) |      9.68 | < .001 |\n|homeless [homeless]                                  |     3.44 |     0.47 | (2.63, 4.50) |      9.03 | < .001 |\n|polydrug [multiple drugs used]                       | 1.85e-09 | 1.21e-05 |  (0.00, Inf) | -3.08e-03 | 0.998  |\n|homeless [homeless] ├Ч polydrug [multiple drugs used] | 1.38e+08 | 9.04e+11 |  (0.00, Inf) |  2.87e-03 | 0.998  |\n\nTable: # Zero-Inflation\n\n|Parameter                      | Odds Ratio |   SE |       95% CI |     z |     p |\n|:------------------------------|:----------:|:----:|:------------:|:-----:|:-----:|\n|(Intercept)                    |       0.49 | 0.54 | (0.06, 4.25) | -0.65 | 0.514 |\n|age                            |       1.05 | 0.03 | (1.00, 1.10) |  1.95 | 0.051 |\n|sex [F]                        |       1.44 | 0.84 | (0.46, 4.50) |  0.62 | 0.533 |\n|homeless [homeless]            |       0.68 | 0.34 | (0.26, 1.80) | -0.78 | 0.436 |\n|polydrug [multiple drugs used] |       1.15 | 0.91 | (0.24, 5.43) |  0.18 | 0.858 |\n\n\n:::\n:::\n\n\n\n\n\n\n\n::: notes\n\nAnother R package for zero-inflated models is [`pscl`](https://cran.r-project.org/web/packages/pscl/index.html) (@pscl08).\n\n:::\n\n#### zero-inflated negative binomial model\n\n\n\n\n\n\n\n::: {#tbl-zeroinf-nb .cell tbl-cap='Zero-inflated negative binomial model'}\n\n```{.r .cell-code}\nlibrary(glmmTMB)\nzinf_fit1 = glmmTMB(\n  family = nbinom2,\n  data  = needles,\n  formula = shared_syr ~ age + sex + homeless*polydrug,\n  ziformula = ~ age + sex + homeless + polydrug # fit won't converge with interaction\n)\n\nzinf_fit1 |> \n  parameters(exponentiate = TRUE) |> \n  print_md()\n```\n\n::: {.cell-output-display}\n\n\nTable: # Fixed Effects\n\n|Parameter                                            |      IRR |       SE |        95% CI |         z |     p |\n|:----------------------------------------------------|:--------:|:--------:|:-------------:|:---------:|:-----:|\n|(Intercept)                                          |     1.06 |     1.48 | (0.07, 16.52) |      0.04 | 0.969 |\n|age                                                  |     1.02 |     0.03 |  (0.96, 1.08) |      0.53 | 0.599 |\n|sex [F]                                              |     6.86 |     6.36 | (1.12, 42.16) |      2.08 | 0.038 |\n|homeless [homeless]                                  |     6.44 |     4.59 | (1.60, 26.01) |      2.62 | 0.009 |\n|polydrug [multiple drugs used]                       | 8.25e-10 | 7.07e-06 |   (0.00, Inf) | -2.44e-03 | 0.998 |\n|homeless [homeless] ├Ч polydrug [multiple drugs used] | 2.36e+08 | 2.02e+12 |   (0.00, Inf) |  2.25e-03 | 0.998 |\n\nTable: # Zero-Inflation\n\n|Parameter                      | Odds Ratio |   SE |           95% CI |     z |     p |\n|:------------------------------|:----------:|:----:|:----------------:|:-----:|:-----:|\n|(Intercept)                    |       0.10 | 0.20 | (1.47e-03, 6.14) | -1.11 | 0.269 |\n|age                            |       1.07 | 0.04 |     (0.99, 1.15) |  1.78 | 0.075 |\n|sex [F]                        |       2.72 | 2.40 |    (0.48, 15.33) |  1.13 | 0.258 |\n|homeless [homeless]            |       1.15 | 0.86 |     (0.27, 4.96) |  0.19 | 0.853 |\n|polydrug [multiple drugs used] |       0.75 | 0.86 |     (0.08, 7.12) | -0.25 | 0.799 |\n\nTable: # Dispersion\n\n|Parameter   | Coefficient |       95% CI |\n|:-----------|:-----------:|:------------:|\n|(Intercept) |        0.44 | (0.11, 1.71) |\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n## More on count regression\n\n- <https://bookdown.org/roback/bookdown-BeyondMLR/ch-poissonreg.html>\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}