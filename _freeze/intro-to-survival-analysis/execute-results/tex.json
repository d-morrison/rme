{
  "hash": "003c08365b94d7fd9203d9ebbef67740",
  "result": {
    "engine": "knitr",
    "markdown": "# Introduction to Survival Analysis\n\n\n<!-- ::: {.content-hidden when-format=\"revealjs\"} -->\n\n---\n\n### Configuring R {.unnumbered}\n\nFunctions from these packages will be used throughout this document:\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(conflicted) # check for conflicting function definitions\n# library(printr) # inserts help-file output into markdown output\nlibrary(rmarkdown) # Convert R Markdown documents into a variety of formats.\nlibrary(pander) # format tables for markdown\nlibrary(ggplot2) # graphics\nlibrary(ggeasy) # help with graphics\nlibrary(ggfortify) # help with graphics\nlibrary(dplyr) # manipulate data\nlibrary(tibble) # `tibble`s extend `data.frame`s\nlibrary(magrittr) # `%>%` and other additional piping tools\nlibrary(haven) # import Stata files\nlibrary(knitr) # format R output for markdown\nlibrary(tidyr) # Tools to help to create tidy data\nlibrary(plotly) # interactive graphics\nlibrary(dobson) # datasets from Dobson and Barnett 2018\nlibrary(parameters) # format model output tables for markdown\nlibrary(haven) # import Stata files\nlibrary(latex2exp) # use LaTeX in R code (for figures and tables)\nlibrary(fs) # filesystem path manipulations\nlibrary(survival) # survival analysis\nlibrary(survminer) # survival analysis graphics\nlibrary(KMsurv) # datasets from Klein and Moeschberger\nlibrary(parameters) # format model output tables for\nlibrary(webshot2) # convert interactive content to static for pdf\nlibrary(forcats) # functions for categorical variables (\"factors\")\nlibrary(stringr) # functions for dealing with strings\nlibrary(lubridate) # functions for dealing with dates and times\n```\n:::\n\n\n\n\n\n\n\nHere are some R settings I use in this document:\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrm(list = ls()) # delete any data that's already loaded into R\n\nconflicts_prefer(dplyr::filter)\nggplot2::theme_set(\n  ggplot2::theme_bw() + \n        # ggplot2::labs(col = \"\") +\n    ggplot2::theme(\n      legend.position = \"bottom\",\n      text = ggplot2::element_text(size = 12, family = \"serif\")))\n\nknitr::opts_chunk$set(message = FALSE)\noptions('digits' = 4)\n\npanderOptions(\"big.mark\", \",\")\npander::panderOptions(\"table.emphasize.rownames\", FALSE)\npander::panderOptions(\"table.split.table\", Inf)\nconflicts_prefer(dplyr::filter) # use the `filter()` function from dplyr() by default\nlegend_text_size = 9\n```\n:::\n\n\n\n\n\n\n\n<!-- ::: -->\n\n\n\n\\providecommand{\\cbl}[1]{\\left\\{#1\\right.}\n\\providecommand{\\cb}[1]{\\left\\{#1\\right\\}}\n\\providecommand{\\paren}[1]{\\left(#1\\right)}\n\\providecommand{\\sb}[1]{\\left[#1\\right]}\n\\def\\pr{\\text{p}}\n\\def\\am{\\arg \\max}\n\\def\\argmax{\\arg \\max}\n\\def\\p{\\text{p}}\n\\def\\P{\\text{P}}\n\\def\\ph{\\hat{\\text{p}}}\n\\def\\hp{\\hat{\\text{p}}}\n\\def\\ga{\\alpha}\n\\def\\b{\\beta}\n\\providecommand{\\floor}[1]{\\left \\lfloor{#1}\\right \\rfloor}\n\\providecommand{\\ceiling}[1]{\\left \\lceil{#1}\\right \\rceil}\n\\providecommand{\\ceil}[1]{\\left \\lceil{#1}\\right \\rceil}\n\\def\\Ber{\\text{Ber}}\n\\def\\Bernoulli{\\text{Bernoulli}}\n\\def\\Pois{\\text{Pois}}\n\\def\\Poisson{\\text{Poisson}}\n\\def\\Gaus{\\text{Gaussian}}\n\\def\\Normal{\\text{N}}\n\\def\\NB{\\text{NegBin}}\n\\def\\NegBin{\\text{NegBin}}\n\\def\\vbeta{\\vec \\beta}\n\\def\\vb{\\vec \\b}\n\\def\\v0{\\vec{0}}\n\\def\\gb{\\beta}\n\\def\\gg{\\gamma}\n\\def\\gd{\\delta}\n\\def\\eps{\\varepsilon}\n\\def\\om{\\omega}\n\\def\\m{\\mu}\n\\def\\s{\\sigma}\n\\def\\l{\\lambda}\n\\def\\gs{\\sigma}\n\\def\\gm{\\mu}\n\\def\\M{\\text{M}}\n\\def\\gM{\\text{M}}\n\\def\\Mu{\\text{M}}\n\\def\\cd{\\cdot}\n\\def\\cds{\\cdots}\n\\def\\lds{\\ldots}\n\\def\\eqdef{\\stackrel{\\text{def}}{=}}\n\\def\\defeq{\\stackrel{\\text{def}}{=}}\n\\def\\hb{\\hat \\beta}\n\\def\\hl{\\hat \\lambda}\n\\def\\hy{\\hat y}\n\\def\\yh{\\hat y}\n\\def\\V{{\\text{Var}}}\n\\def\\hs{\\hat \\sigma}\n\\def\\hsig{\\hat \\sigma}\n\\def\\hS{\\hat \\Sigma}\n\\def\\hSig{\\hat \\Sigma}\n\\def\\hSigma{\\hat \\Sigma}\n\\def\\hSurv{\\hat{S}}\n\\providecommand{\\hSurvf}[1]{\\hat{S}\\paren{#1}}\n\\def\\dist{\\ \\sim \\ }\n\\def\\ddist{\\ \\dot{\\sim} \\ }\n\\def\\dsim{\\ \\dot{\\sim} \\ }\n\\def\\za{z_{1 - \\frac{\\alpha}{2}}}\n\\def\\cirad{\\za \\cdot \\hse{\\hb}}\n\\def\\ci{\\hb {\\color{red}\\pm} \\cirad}\n\\def\\th{\\theta}\n\\def\\Th{\\Theta}\n\\def\\xbar{\\bar{x}}\n\\def\\hth{\\hat\\theta}\n\\def\\hthml{\\hth_{\\text{ML}}}\n\\def\\ba{\\begin{aligned}}\n\\def\\ea{\\end{aligned}}\n\\def\\ind{тлл}\n\\def\\indpt{тлл}\n\\def\\all{\\forall}\n\\def\\iid{\\text{iid}}\n\\def\\ciid{\\text{ciid}}\n\\def\\simind{\\ \\sim_{\\ind}\\ }\n\\def\\siid{\\ \\sim_{\\iid}\\ }\n\\def\\simiid{\\siid}\n\\def\\distiid{\\siid}\n\\def\\tf{\\therefore}\n\\def\\Lik{\\mathcal{L}}\n\\def\\llik{\\ell}\n\\providecommand{\\llikf}[1]{\\llik \\paren{#1}}\n\\def\\score{\\ell'}\n\\providecommand{\\scoref}[1]{\\score \\paren{#1}}\n\\def\\hess{\\ell''}\n\\def\\hessian{\\ell''}\n\\providecommand{\\hessf}[1]{\\hess \\paren{#1}}\n\\providecommand{\\hessianf}[1]{\\hess \\paren{#1}}\n\\providecommand{\\starf}[1]{#1^*}\n\\def\\lik{\\ell}\n\\providecommand{\\est}[1]{\\widehat{#1}}\n\\providecommand{\\esttmp}[1]{{\\widehat{#1}}^*}\n\\def\\esttmpl{\\esttmp{\\lambda}}\n\\def\\cR{\\mathcal{R}}\n\\def\\range{\\mathcal{R}}\n\\def\\Range{\\mathcal{R}}\n\\providecommand{\\rangef}[1]{\\cR(#1)}\n\\def\\~{\\approx}\n\\def\\dapp{\\dot\\approx}\n\\providecommand{\\red}[1]{{\\color{red}#1}}\n\\providecommand{\\deriv}[1]{\\frac{\\partial}{\\partial #1}}\n\\providecommand{\\derivf}[2]{\\frac{\\partial #1}{\\partial #2}}\n\\providecommand{\\blue}[1]{{\\color{blue}#1}}\n\\providecommand{\\green}[1]{{\\color{green}#1}}\n\\providecommand{\\hE}[1]{\\hat{\\text{E}}\\sb{#1}}\n\\providecommand{\\hExp}[1]{\\hat{\\text{E}}\\sb{#1}}\n\\providecommand{\\hmu}[1]{\\hat{\\mu}\\sb{#1}}\n\\def\\Expp{\\mathbb{E}}\n\\def\\Ep{\\mathbb{E}}\n\\def\\expit{\\text{expit}}\n\\providecommand{\\expitf}[1]{\\expit\\cb{#1}}\n\\providecommand{\\dexpitf}[1]{\\expit'\\cb{#1}}\n\\def\\logit{\\text{logit}}\n\\providecommand{\\logitf}[1]{\\logit\\cb{#1}}\n\\providecommand{\\E}[1]{\\mathbb{E}\\sb{#1}}\n\\providecommand{\\Ef}[1]{\\mathbb{E}\\sb{#1}}\n\\providecommand{\\Exp}[1]{\\mathbb{E}\\sb{#1}}\n\\providecommand{\\Expf}[1]{\\mathbb{E}\\sb{#1}}\n\\def\\Varr{\\text{Var}}\n\\providecommand{\\var}[1]{\\text{Var}\\paren{#1}}\n\\providecommand{\\varf}[1]{\\text{Var}\\paren{#1}}\n\\providecommand{\\Var}[1]{\\text{Var}\\paren{#1}}\n\\providecommand{\\Varf}[1]{\\text{Var}\\paren{#1}}\n\\def\\Covt{\\text{Cov}}\n\\providecommand{\\covh}[1]{\\widehat{\\text{Cov}}\\paren{#1}}\n\\providecommand{\\Cov}[1]{\\Covt \\paren{#1}}\n\\providecommand{\\Covf}[1]{\\Covt \\paren{#1}}\n\\def\\varht{\\widehat{\\text{Var}}}\n\\providecommand{\\varh}[1]{\\varht\\paren{#1}}\n\\providecommand{\\varhf}[1]{\\varht\\paren{#1}}\n\\providecommand{\\vc}[1]{\\boldsymbol{#1}}\n\\providecommand{\\sd}[1]{\\text{sd}\\paren{#1}}\n\\providecommand{\\SD}[1]{\\text{SD}\\paren{#1}}\n\\providecommand{\\hSD}[1]{\\widehat{\\text{SD}}\\paren{#1}}\n\\providecommand{\\se}[1]{\\text{se}\\paren{#1}}\n\\providecommand{\\hse}[1]{\\hat{\\text{se}}\\paren{#1}}\n\\providecommand{\\SE}[1]{\\text{SE}\\paren{#1}}\n\\providecommand{\\HSE}[1]{\\widehat{\\text{SE}}\\paren{#1}}\n\\renewcommand{\\log}[1]{\\text{log}\\cb{#1}}\n\\providecommand{\\logf}[1]{\\text{log}\\cb{#1}}\n\\def\\dlog{\\text{log}'}\n\\providecommand{\\dlogf}[1]{\\dlog \\cb{#1}}\n\\renewcommand{\\exp}[1]{\\text{exp}\\cb{#1}}\n\\providecommand{\\expf}[1]{\\exp{#1}}\n\\def\\dexp{\\text{exp}'}\n\\providecommand{\\dexpf}[1]{\\dexp \\cb{#1}}\n\\providecommand{\\e}[1]{\\text{e}^{#1}}\n\\providecommand{\\ef}[1]{\\text{e}^{#1}}\n\\providecommand{\\inv}[1]{\\paren{#1}^{-1}}\n\\providecommand{\\invf}[1]{\\paren{#1}^{-1}}\n\\def\\oinf{I}\n\\def\\Nat{\\mathbb{N}}\n\\providecommand{\\oinff}[1]{\\oinf\\paren{#1}}\n\\def\\einf{\\mathcal{I}}\n\\providecommand{\\einff}[1]{\\einf\\paren{#1}}\n\\def\\heinf{\\hat{\\einf}}\n\\providecommand{\\heinff}[1]{\\heinf \\paren{#1}}\n\\providecommand{\\1}[1]{\\mathbb{1}_{#1}}\n\\providecommand{\\set}[1]{\\cb{#1}}\n\\providecommand{\\pf}[1]{\\p \\paren{#1}}\n\\providecommand{\\Bias}[1]{\\text{Bias}\\paren{#1}}\n\\providecommand{\\bias}[1]{\\text{Bias}\\paren{#1}}\n\\def\\ss{\\sigma^2}\n\\providecommand{\\ssqf}[1]{\\sigma^2\\paren{#1}}\n\\providecommand{\\mselr}[1]{\\text{MSE}\\paren{#1}}\n\\providecommand{\\maelr}[1]{\\text{MAE}\\paren{#1}}\n\\providecommand{\\abs}[1]{\\left|#1\\right|}\n\\providecommand{\\sqf}[1]{\\paren{#1}^2}\n\\providecommand{\\sq}{^2}\n\\def\\err{\\eps}\n\\providecommand{\\erf}[1]{\\err\\paren{#1}}\n\\renewcommand{\\vec}[1]{\\tilde{#1}}\n\\providecommand{\\v}[1]{\\vec{#1}}\n\\providecommand{\\matr}[1]{\\mathbf{#1}}\n\\def\\mX{\\matr{X}}\n\\def\\mx{\\matr{x}}\n\\def\\vx{\\vec{x}}\n\\def\\vX{\\vec{X}}\n\\def\\vy{\\vec{y}}\n\\def\\vY{\\vec{Y}}\n\\def\\vpi{\\vec{\\pi}}\n\\providecommand{\\mat}[1]{\\mathbf{#1}}\n\\providecommand{\\dsn}[1]{#1_1, \\ldots, #1_n}\n\\def\\X1n{\\dsn{X}}\n\\def\\Xin{\\dsn{X}}\n\\def\\x1n{\\dsn{x}}\n\\def\\'{^{\\top}}\n\\def\\dpr{\\cdot}\n\\def\\Xx1n{X_1=x_1, \\ldots, X_n = x_n}\n\\providecommand{\\dsvn}[2]{#1_1=#2_1, \\ldots, #1_n = #2_n}\n\\providecommand{\\sumn}[1]{\\sum_{#1=1}^n}\n\\def\\sumin{\\sum_{i=1}^n}\n\\def\\sumi1n{\\sum_{i=1}^n}\n\\def\\prodin{\\prod_{i=1}^n}\n\\def\\prodi1n{\\prod_{i=1}^n}\n\\providecommand{\\lp}[2]{#1 \\' \\beta}\n\\def\\odds{\\omega}\n\\def\\OR{\\text{OR}}\n\\def\\logodds{\\eta}\n\\def\\oddst{\\text{odds}}\n\\def\\probst{\\text{probs}}\n\\def\\probt{\\text{probt}}\n\\def\\probit{\\text{probit}}\n\\providecommand{\\oddsf}[1]{\\oddst\\cb{#1}}\n\\providecommand{\\doddsf}[1]{{\\oddst}'\\cb{#1}}\n\\def\\oddsinv{\\text{invodds}}\n\\providecommand{\\oddsinvf}[1]{\\oddsinv\\cb{#1}}\n\\def\\invoddsf{\\oddsinvf}\n\\providecommand{\\doddsinvf}[1]{{\\oddsinv}'\\cb{#1}}\n\\def\\dinvoddsf{\\doddsinvf}\n\\def\\haz{h}\n\\def\\cuhaz{H}\n\\def\\incidence{\\bar{\\haz}}\n\\def\\phaz{\\Expf{\\haz}}\n\n\n\n\n\n\n\n\n\n```{=html}\n<style>\n.quarto-figure-center > figure {\ntext-align: center;\n}\n</style>\n```\n\n\n\n\n\n\n\n\n\n## Overview\n\n### Time-to-event outcomes {.smaller}\n\n**Survival analysis** is a framework for modeling *time-to-event* outcomes. It is used in:\n\n-   clinical trials, where the event is often death or\n    recurrence of disease.\n-   engineering reliability analysis, where the event is\n    failure of a device or system.\n-   insurance, particularly life insurance, where the\n    event is death.\n\n:::{.callout-note}\nThe term *survival analysis* is a bit misleading. Survival outcomes can sometimes be analyzed using binomial models (logistic regression). *Time-to-event models* or *survival time analysis* might be a better name.\n:::\n\n## Time-to-event outcome distributions\n\n### Distributions of Time-to-Event Data  {.smaller}\n\n-   The distribution of event times is asymmetric and can be\n    long-tailed, and starts at 0 (that is, $P(T<0) = 0$).\n-   The base distribution is not normal, but exponential.\n-   There are usually **censored** observations, which are ones in which\n    the failure time is not observed.\n-   Often, these are **right-censored**, meaning that we know that the\n    event occurred after some known time $t$, but we don't know the\n    actual event time, as when a patient is still alive at the end of\n    the study.\n-   Observations can also be **left-censored**, meaning we know the\n    event has already happened at time $t$, or **interval-censored**,\n    meaning that we only know that the event happened between times\n    $t_1$ and $t_2$.\n-   Analysis is difficult if censoring is associated with treatment.\n\n### Right Censoring\n\n-   Patients are in a clinical trial for cancer, some on a new treatment\n    and some on standard of care.\n-   Some patients in each group have died by the end of the study. We\n    know the survival time (measured for example from time of\n    diagnosis---each person on their own clock).\n-   Patients still alive at the end of the study are right censored.\n-   Patients who are lost to follow-up or withdraw from the study may be\n    right-censored.\n\n### Left and Interval Censoring\n\n-   An individual tests positive for HIV.\n-   If the event is infection with HIV, then we only know that it has\n    occurred before the testing time $t$, so this is left censored.\n-   If an individual has a negative HIV test at time $t_1$ and a\n    positive HIV test at time $t_2$, then the infection event is\n    interval censored.\n\n## Distribution functions for time-to-event variables\n\n### The Probability Density Function (PDF)  {.smaller}\n\nFor a time-to-event variable $T$ with a continuous distribution, the\n**probability density function** is defined as usual (see @sec-prob-dens).\n\n::: notes\nIn most time-to-event models, this density is assumed to be 0 for all $t<0$; \nthat is, $f(t) = 0, \\forall t<0$. \nIn other words, the support of $T$ is typically $[0,\\infty)$.\n:::\n\n---\n\n:::{#exm-exp-pdf}\n#### exponential distribution\n\nRecall from Epi 202: the pdf of the exponential distribution family of\nmodels is:\n\n$$p(T=t) = \\1{t \\ge 0} \\cdot \\lambda \\ef{-\\lambda t}$$ \n\nwhere $\\lambda > 0$.\n\n---\n\nHere are some examples of exponential pdfs:\n\n\n\n\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](intro-to-survival-analysis_files/figure-pdf/unnamed-chunk-3-1.pdf)\n:::\n:::\n\n\n\n\n\n\n\n\n:::\n\n### The Cumulative Distribution Function (CDF)\n\nThe **cumulative distribution function** is defined as:\n\n$$\n\\begin{aligned}\nF(t) &\\eqdef \\Pr(T \\le t)\\\\\n&=\\int_{u=-\\infty}^t f(u) du\n\\end{aligned}\n$$\n\n:::{#exm-exp-cdf}\n##### exponential distribution\n\nRecall from Epi 202: the cdf of the exponential distribution family of\nmodels is:\n\n$$\nP(T\\le t) = \\mathbb{1}_{t \\ge 0} \\cdot (1- \\text{e}^{-\\lambda t})\n$$ where $\\lambda > 0$.\n\n:::\n\nHere are some examples of exponential cdfs:\n\n\n\n\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](intro-to-survival-analysis_files/figure-pdf/unnamed-chunk-4-1.pdf)\n:::\n:::\n\n\n\n\n\n\n\n\n### The Survival Function\n\nFor survival data, a more important quantity is the **survival\nfunction**:\n\n$$\n\\begin{aligned}\nS(t) &\\eqdef \\Pr(T > t)\\\\\n&=\\int_{u=t}^\\infty p(u) du\\\\\n&=1-F(t)\\\\\n\\end{aligned}\n$$\n\n---\n\n:::{#def-surv-fn}\n\n#### Survival function\n\n:::: notes\nGiven a random time-to-event variable $T$, \nthe **survival function** or **survivor function**, \ndenoted $S(t)$,\nis the probability \nthat the event time is later than $t$. \nIf the event in a clinical trial is death, \nthen $S(t)$ is the expected fraction \nof the original population at time 0 \nwho have survived up to time $t$ \nand are still alive at time $t$; that is:\n::::\n\n$$S(t) \\eqdef \\Pr(T > t)$${#eq-def-surv}\n\n:::\n\n---\n\n:::{#exm-exp-survfn}\n##### exponential distribution\n\nSince $S(t) = 1 - F(t)$, the survival function of the exponential\ndistribution family of models is:\n\n$$\nP(T> t) = \\left\\{ {{\\text{e}^{-\\lambda t}, t\\ge0} \\atop {1, t \\le 0}}\\right. \n$$ where $\\lambda > 0$.\n\n@fig-exp-survfuns shows some examples of exponential survival functions.\n\n:::\n\n---\n\n\n\n\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Exponential Survival Functions](intro-to-survival-analysis_files/figure-pdf/fig-exp-survfuns-1.pdf){#fig-exp-survfuns}\n:::\n:::\n\n\n\n\n\n\n\n\n---\n\n:::{#thm-surv-fn-as-mean-status}\n\nIf $A_t$ represents survival status at time $t$, with $A_t = 1$ denoting alive at time $t$ and $A_t = 0$ denoting deceased at time $t$, then:\n\n$$S(t) = \\Pr(A_t=1) = \\Expp[A_t]$$\n\n:::\n\n---\n\n:::{#thm-surv-and-mean}\n\nIf $T$ is a nonnegative random variable, then:\n\n$$\\Expp[T] = \\int_{t=0}^{\\infty} S(t)dt$$\n\n:::\n\n---\n\n:::{.proof}\n\nSee <https://statproofbook.github.io/P/mean-nnrvar.html> or \n\n:::\n\n### The Hazard Function\n\nAnother important quantity is the **hazard function**:\n\n\n\n:::{#def-hazard}\n\n##### Hazard function, hazard rate, hazard rate function\n\n::: notes\nThe **hazard function**, **hazard rate**,  **hazard rate function**, \nfor a random variable $T$ at value $t$,\ntypically denoted as $h(t)$ or $\\lambda(t)$,\nis the conditional [density](probability.qmd#def-pdf) of $T$ at $t$, \ngiven $T \\ge t$.\nThat is:\n:::\n\n$$\\haz(t) \\eqdef \\p(T=t|T\\ge t)$$\n\n::: notes\nIf $T$ represents the time at which an event occurs, \nthen $\\haz(t)$ is the probability that the event occurs at time $t$, \ngiven that it has not occurred prior to time $t$.\n:::\n\n:::\n\n\n\n---\n\n\n*New content for 2025:*\n\n:::{#def-incidence-rate}\n#### Incidence rate\n\nGiven a population of individuals indexed by $i$, \neach with their own hazard rate $\\haz_i(t)$, \nthe **incidence rate** for that population is the mean hazard rate:\n\n$$\\incidence(t) \\eqdef \\frac{1}{n}\\sumin \\haz_i(t)$$\n\n:::\n\n---\n\n*New content for 2025:*\n\n:::{#thm-homogenous-incidence}\n\n#### Incidence rate in a homogenous population\n\nIf a population of individuals indexed by $i$ \nall have identical hazard rates $\\haz_i(t) = \\haz(t)$, \nthen the **incidence rate** for that population \nis equal to the hazard rate:\n\n$$\\incidence(t) = \\haz(t)$$\n\n:::\n\n*(End of new content for 2025)*\n\n\n\n---\n\n::: notes\nThe hazard function has an important relationship to the density and survival functions, \nwhich we can use to derive the hazard function for a given probability distribution (@thm-hazard-dens-surv).\n:::\n\n:::::{#lem-joint-prob-same-var}\n\n#### Joint probability of a variable with itself\n\n$$p(T=t, T\\ge t) = p(T=t)$$\n\n::::::{.proof}\nRecall from Epi 202: \nif $A$ and $B$ are statistical events and $A\\subseteq B$, then $p(A, B) = p(A)$.\nIn particular, $\\{T=t\\} \\subseteq \\{T\\geq t\\}$, so $p(T=t, T\\ge t) = p(T=t)$.\n::::::\n:::::\n\n---\n\n:::{#thm-hazard-dens-surv}\n#### Hazard equals density over survival\n$$h(t)=\\frac{f(t)}{S(t)}$$\n:::\n\n---\n\n::::{.proof}\n\n$$\n\\begin{aligned}\nh(t) &=p(T=t|T\\ge t)\\\\\n&=\\frac{p(T=t, T\\ge t)}{p(T \\ge t)}\\\\\n&=\\frac{p(T=t)}{p(T \\ge t)}\\\\\n&=\\frac{f(t)}{S(t)}\n\\end{aligned}\n$$\n\n::::\n\n---\n\n:::{#exm-exp-haz}\n##### exponential distribution\n\nThe hazard function of the exponential distribution family of models is:\n\n$$\n\\begin{aligned}\nP(T=t|T \\ge t) \n&= \\frac{f(t)}{S(t)}\\\\\n&= \\frac{\\mathbb{1}_{t \\ge 0}\\cdot \\lambda  \\text{e}^{-\\lambda t}}{\\text{e}^{-\\lambda t}}\\\\\n&=\\mathbb{1}_{t \\ge 0}\\cdot \\lambda\n\\end{aligned}\n$$\n@fig-exp-hazard shows some examples of exponential hazard functions.\n\n:::\n\n---\n\n\n\n\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Examples of hazard functions for exponential distributions](intro-to-survival-analysis_files/figure-pdf/fig-exp-hazard-1.pdf){#fig-exp-hazard}\n:::\n:::\n\n\n\n\n\n\n\n\n---\n\nWe can also view the hazard function as the derivative of the negative of the logarithm of the survival function:\n\n:::{#thm-h-logS}\n\n#### transform survival to hazard\n\n$$h(t) = \\deriv{t}\\cb{-\\log{S(t)}}$$\n:::\n\n---\n\n::::{.proof}\n$$\n\\begin{aligned}\nh(t)\n&= \\frac{f(t)}{S(t)}\\\\\n&= \\frac{-S'(t)}{S(t)}\\\\\n&= -\\frac{S'(t)}{S(t)}\\\\\n&=-\\deriv{t}\\log{S(t)}\\\\\n&=\\deriv{t}\\cb{-\\log{S(t)}}\n\\end{aligned}\n$$\n::::\n\n### The Cumulative Hazard Function\n\nSince $h(t) = \\deriv{t}\\cb{-\\log{S(t)}}$ (see @thm-h-logS), we also have:\n\n:::{#cor-surv-int-haz}\n$$S(t) = \\exp{-\\int_{u=0}^t h(u)du}$${#eq-surv-int-haz}\n:::\n\n---\n\n::: notes\nThe integral in @eq-surv-int-haz is important enough to have its own name: **cumulative hazard**.\n:::\n\n:::{#def-cuhaz}\n\n##### cumulative hazard\n\nThe **cumulative hazard function** $H(t)$ is defined as:\n\n$$H(t) \\eqdef \\int_{u=0}^t h(u) du$$\n\n:::\n\nAs we will see below, $H(t)$ is tractable to estimate, and we can then\nderive an estimate of the hazard function using an approximate derivative\nof the estimated cumulative hazard.\n\n---\n\n:::{#exm-exp-cumhaz}\n\nThe cumulative hazard function of the exponential distribution family of\nmodels is:\n\n$$\nH(t) = \\mathbb{1}_{t \\ge 0}\\cdot \\lambda t\n$$\n\n@fig-cuhaz-exp shows some examples of exponential cumulative hazard functions.\n\n:::\n\n---\n\n\n\n\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Examples of exponential cumulative hazard functions](intro-to-survival-analysis_files/figure-pdf/fig-cuhaz-exp-1.pdf){#fig-cuhaz-exp}\n:::\n:::\n\n\n\n\n\n\n\n\n### Some Key Mathematical Relationships among Survival Concepts\n\n#### Diagram:\n\n$$\nh(t) \\xrightarrow[]{\\int_{u=0}^t h(u)du} H(t) \n\\xrightarrow[]{\\exp{-H(t)}} S(t)\n\\xrightarrow[]{1-S(t)} F(t)\n$$\n\n$$\nh(t) \\xleftarrow[\\deriv{t}H(t)]{} H(t) \n\\xleftarrow[-\\log{S(t)}]{} S(t)\n\\xleftarrow[1-F(t)]{} F(t)\n$$\n\n\n---\n\n#### Identities:\n\n$$\n\\begin{aligned}\nS(t) &= 1 - F(t)\\\\\n&= \\text{exp}\\left\\{-H(t)\\right\\}\\\\\nS'(t) &= -f(t)\\\\\nH(t) &= -\\text{log}\\left\\{S(t)\\right\\}\\\\\nH'(t) &= h(t)\\\\\nh(t) &= \\frac{f(t)}{S(t)}\\\\\n &= -\\deriv{t}\\log{S(t)} \\\\\nf(t) &= h(t)\\cdot S(t)\\\\\n\\end{aligned}\n$$\n\n---\n\nSome proofs (others left as exercises):\n\n$$\n\\begin{aligned}\nS'(t) &= \\deriv{t}(1-F(t))\\\\\n&= -F'(t)\\\\\n&= -f(t)\\\\\n\\end{aligned}\n$$\n\n---\n\n$$\n\\begin{aligned}\n\\deriv{t}\\log{S(t)} \n&= \\frac{S'(t)}{S(t)}\\\\\n&= -\\frac{f(t)}{S(t)}\\\\\n&= -h(t)\\\\\n\\end{aligned}\n$$\n\n---\n\n$$\n\\begin{aligned}\nH(t)\n&\\eqdef \\int_{u=0}^t h(u) du\\\\\n&= \\int_0^t -\\deriv{u}\\text{log}\\left\\{S(u)\\right\\} du\\\\\n&= \\left[-\\text{log}\\left\\{S(u)\\right\\}\\right]_{u=0}^{u=t}\\\\\n&= \\left[\\text{log}\\left\\{S(u)\\right\\}\\right]_{u=t}^{u=0}\\\\\n&= \\text{log}\\left\\{S(0)\\right\\} - \\text{log}\\left\\{S(t)\\right\\}\\\\\n&= \\text{log}\\left\\{1\\right\\} - \\text{log}\\left\\{S(t)\\right\\}\\\\\n&= 0 - \\text{log}\\left\\{S(t)\\right\\}\\\\\n&=-\\text{log}\\left\\{S(t)\\right\\}\n\\end{aligned}\n$$\n\n---\n\nCorollary:\n\n$$S(t) = \\text{exp}\\left\\{-H(t)\\right\\}$$\n\n---\n\n#### Example: Time to death the US in 2004\n\nThe first day is the most dangerous:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# download `survexp.rda` from: \n# paste0(\n# \"https://github.com/therneau/survival/raw/\",\n# \"f3ac93704949ff26e07720b56f2b18ffa8066470/\",\n# \"Data/survexp.rda\")\n\n#(newer versions of `survival` don't have the first-year breakdown; see:\n# https://cran.r-project.org/web/packages/survival/news.html)\n\nfs::path(\n  here::here(),\n  \"Data\",\n  \"survexp.rda\") |>\n  load()\ns1 <- survexp.us[,\"female\",\"2004\"]\nage1 <- c(\n  0.5/365.25,\n  4/365.25,\n  17.5/365.25,\n  196.6/365.25,\n  1:109+0.5)\ns2 <- 365.25*s1[5:113]\ns2 <- c(s1[1], 6*s1[2], 22*s1[3], 337.25*s1[4], s2)\ncols <- rep(1,113)\ncols[1] <- 2\ncols[2] <- 3\ncols[3] <- 4\n\nplot(age1,s1,type=\"b\",lwd=2,xlab=\"Age\",ylab=\"Daily Hazard Rate\",col=cols)\n\ntext(10,.003,\"First Day\",col=2)\ntext(18,.00030,\"Rest of First Week\",col=3)\ntext(18,.00015,\"Rest of First month\",col=4)\n```\n\n::: {.cell-output-display}\n![Daily Hazard Rates in 2004 for US Females](intro-to-survival-analysis_files/figure-pdf/fig-haz-female-US-1.pdf){#fig-haz-female-US fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n\n---\n\n:::{#exr-compare-mf}\nHypothesize why the male and female hazard functions in @fig-haz-mf differ where they do?\n:::\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nyrs=1:40\ns1 <- survexp.us[5:113,\"male\",\"2004\"]\ns2 <- survexp.us[5:113,\"female\",\"2004\"]\n\nage1 <- 1:109\n\nplot(age1[yrs],s1[yrs],type=\"l\",lwd=2,xlab=\"Age\",ylab=\"Daily Hazard Rate\")\nlines(age1[yrs],s2[yrs],col=2,lwd=2)\nlegend(5,5e-6,c(\"Males\",\"Females\"),col=1:2,lwd=2)\n\n```\n\n::: {.cell-output-display}\n![Daily Hazard Rates in 2004 for US Males and Females 1-40](intro-to-survival-analysis_files/figure-pdf/fig-haz-mf-1.pdf){#fig-haz-mf fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n\n---\n\n:::{#exr-surv-vs-haz}\nCompare and contrast @fig-surv-US-females with @fig-haz-female-US.\n:::\n\n---\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ns1 <- survexp.us[,\"female\",\"2004\"]\n\ns2 <- 365.25*s1[5:113]\ns2 <- c(s1[1], 6*s1[2], 21*s1[3], 337.25*s1[4], s2)\ncs2 <- cumsum(s2)\nage2 <- c(1/365.25, 7/365.25, 28/365.25, 1:110)\nplot(age2,exp(-cs2),type=\"l\",lwd=2,xlab=\"Age\",ylab=\"Survival\")\n\n```\n\n::: {.cell-output-display}\n![Survival Curve in 2004 for US Females](intro-to-survival-analysis_files/figure-pdf/fig-surv-US-females-1.pdf){#fig-surv-US-females fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n\n---\n\n### Likelihood with censoring\n\nIf an event time $T$ is observed exactly as $T=t$, then the likelihood\nof that observation is just its probability density function:\n\n$$\n\\begin{aligned}\n\\mathcal L(t) \n&= p(T=t)\\\\ \n&\\eqdef  f_T(t)\\\\\n&= h_T(t)S_T(t)\\\\\n\\ell(t) \n&\\eqdef \\text{log}\\left\\{\\mathcal L(t)\\right\\}\\\\\n&= \\text{log}\\left\\{h_T(t)S_T(t)\\right\\}\\\\\n&= \\text{log}\\left\\{h_T(t)\\right\\} + \\text{log}\\left\\{S_T(t)\\right\\}\\\\\n&= \\text{log}\\left\\{h_T(t)\\right\\} - H_T(t)\\\\\n\\end{aligned}\n$$\n\n---\n\nIf instead the event time $T$ is censored and only known to be after\ntime $y$, then the likelihood of that censored observation is instead\nthe survival function evaluated at the censoring time:\n\n$$\n\\begin{aligned}\n\\mathcal L(y) \n&=p_T(T>y)\\\\\n&\\eqdef  S_T(y)\\\\\n\\ell(y)\n&\\eqdef \\text{log}\\left\\{\\mathcal L(y)\\right\\}\\\\\n&=\\text{log}\\left\\{S(y)\\right\\}\\\\\n&=-H(y)\\\\\n\\end{aligned}\n$$\n\n---\n\n::: notes\nWhat's written above is incomplete. We also observed whether or not the\nobservation was censored. Let $C$ denote the time when censoring would\noccur (if the event did not occur first); let $f_C(y)$ and $S_C(y)$ be\nthe corresponding density and survival functions for the censoring\nevent.\n\nLet $Y$ denote the time when observation ended (either by censoring or\nby the event of interest occurring), and let $D$ be an indicator\nvariable for the event occurring at $Y$ (so $D=0$ represents a censored\nobservation and $D=1$ represents an uncensored observation). In other\nwords, let $Y \\eqdef  \\min(T,C)$ and\n$D \\eqdef  \\mathbb 1{\\{T<=C\\}}$.\n\nThen the complete likelihood of the observed data $(Y,D)$ is:\n:::\n\n$$\n\\begin{aligned}\n\\mathcal L(y,d) \n&= p(Y=y, D=d)\\\\\n&= \\left[p(T=y,C> y)\\right]^d \\cdot \n\\left[p(T>y,C=y)\\right]^{1-d}\\\\\n\\end{aligned}\n$$\n\n---\n\n::: notes\nTypically, survival analyses assume that $C$ and $T$ are mutually\nindependent; this assumption is called \"non-informative\" censoring.\n\nThen the joint likelihood $p(Y,D)$ factors into the product\n$p(Y), p(D)$, and the likelihood reduces to:\n:::\n\n$$\n\\begin{aligned}\n\\mathcal L(y,d) \n&= \\left[p(T=y,C> y)\\right]^d\\cdot \n\\left[p(T>y,C=y)\\right]^{1-d}\\\\\n&= \\left[p(T=y)p(C> y)\\right]^d\\cdot \n\\left[p(T>y)p(C=y)\\right]^{1-d}\\\\\n&= \\left[f_T(y)S_C(y)\\right]^d\\cdot \n\\left[S(y)f_C(y)\\right]^{1-d}\\\\\n&= \\left[f_T(y)^d S_C(y)^d\\right]\\cdot \n\\left[S_T(y)^{1-d}f_C(y)^{1-d}\\right]\\\\\n&= \\left(f_T(y)^d \\cdot S_T(y)^{1-d}\\right)\\cdot \n\\left(f_C(y)^{1-d} \\cdot S_C(y)^{d}\\right)\n\\end{aligned}\n$$\n\n---\n\n::: notes\nThe corresponding log-likelihood is:\n:::\n\n$$\n\\begin{aligned}\n\\ell(y,d) \n&= \\text{log}\\left\\{\\mathcal L(y,d) \\right\\}\\\\\n&= \\text{log}\\left\\{\n\\left(f_T(y)^d \\cdot S_T(y)^{1-d}\\right)\\cdot \n\\left(f_C(y)^{1-d} \\cdot S_C(y)^{d}\\right)\n\\right\\}\\\\\n&= \\text{log}\\left\\{\nf_T(y)^d \\cdot S_T(y)^{1-d}\n\\right\\} \n+\n\\text{log}\\left\\{\nf_C(y)^{1-d} \\cdot S_C(y)^{d}\n\\right\\}\\\\\n\\end{aligned}\n$$ Let\n\n-   $\\theta_T$ represent the parameters of $p_T(t)$,\n-   $\\theta_C$ represent the parameters of $p_C(c)$,\n-   $\\theta = (\\theta_T, \\theta_C)$ be the combined vector of all\n    parameters.\n\n---\n\n::: notes\nThe corresponding score function is:\n:::\n\n$$\n\\begin{aligned}\n\\ell'(y,d) \n&= \\deriv{\\theta} \n\\left[\n\\text{log}\\left\\{\nf_T(y)^d \\cdot S_T(y)^{1-d}\n\\right\\} \n+\n\\text{log}\\left\\{\nf_C(y)^{1-d} \\cdot S_C(y)^{d}\n\\right\\}\n\\right]\\\\\n&= \n\\left(\n\\deriv{\\theta} \n\\text{log}\\left\\{\nf_T(y)^d \\cdot S_T(y)^{1-d}\n\\right\\}\n\\right)\n+\n\\left(\n\\deriv{\\theta} \n\\text{log}\\left\\{\nf_C(y)^{1-d} \\cdot S_C(y)^{d}\n\\right\\}\n\\right)\\\\\n\\end{aligned}\n$$\n\n---\n\n::: notes\nAs long as $\\theta_C$ and $\\theta_T$ don't share any parameters, then if\ncensoring is non-informative, the partial derivative with respect to\n$\\theta_T$ is:\n:::\n\n$$\n\\begin{aligned}\n\\ell'_{\\theta_T}(y,d)\n&\\eqdef  \\deriv{\\theta_T}\\ell(y,d)\\\\\n&= \n\\left(\n\\deriv{\\theta_T} \n\\text{log}\\left\\{\nf_T(y)^d \\cdot S_T(y)^{1-d}\n\\right\\}\n\\right)\n+\n\\left(\n\\deriv{\\theta_T} \n\\text{log}\\left\\{\nf_C(y)^{1-d} \\cdot S_C(y)^{d}\n\\right\\}\n\\right)\\\\\n&= \n\\left(\n\\deriv{\\theta_T} \n\\text{log}\\left\\{\nf_T(y)^d \\cdot S_T(y)^{1-d}\n\\right\\}\n\\right) + 0\\\\\n&= \n\\deriv{\\theta_T} \n\\text{log}\\left\\{\nf_T(y)^d \\cdot S_T(y)^{1-d}\n\\right\\}\\\\\n\\end{aligned}\n$$ \n\n---\n\n::: notes\nThus, the MLE for $\\theta_T$ won't depend on $\\theta_C$, and we can\nignore the distribution of $C$ when estimating the parameters of\n$f_T(t)=p(T=t)$.\n:::\n\nThen:\n\n$$\n\\begin{aligned}\n\\mathcal L(y,d) \n&= f_T(y)^d \\cdot S_T(y)^{1-d}\\\\\n&= \\left(h_T(y)^d  S_T(y)^d\\right) \\cdot S_T(y)^{1-d}\\\\\n&= h_T(y)^d  \\cdot S_T(y)^d \\cdot S_T(y)^{1-d}\\\\\n&= h_T(y)^d \\cdot S_T(y)\\\\\n&= S_T(y) \\cdot h_T(y)^d \\\\\n\\end{aligned}\n$$\n\n::: notes\nThat is, if the event occurred at time $y$ (i.e., if $d=1$), then the\nlikelihood of $(Y,D) = (y,d)$ is equal to the hazard function at $y$\ntimes the survival function at $y$. Otherwise, the likelihood is equal\nto just the survival function at $y$.\n:::\n\n---\n\n::: notes\nThe corresponding log-likelihood is:\n:::\n\n$$\n\\begin{aligned}\n\\ell(y,d)\n&=\\text{log}\\left\\{\\mathcal L(y,d)\\right\\}\\\\\n&= \\text{log}\\left\\{S_T(y) \\cdot h_T(y)^d\\right\\}\\\\\n&= \\text{log}\\left\\{S_T(y)\\right\\} + \\text{log}\\left\\{h_T(y)^d\\right\\}\\\\\n&= \\text{log}\\left\\{S_T(y)\\right\\} + d\\cdot \\text{log}\\left\\{h_T(y)\\right\\}\\\\\n&= -H_T(y) + d\\cdot \\text{log}\\left\\{h_T(y)\\right\\}\\\\\n\\end{aligned}\n$$\n\n::: notes\nIn other words, the log-likelihood contribution from a single\nobservation $(Y,D) = (y,d)$ is equal to the negative cumulative hazard\nat $y$, plus the log of the hazard at $y$ if the event occurred at time\n$y$.\n:::\n\n## Parametric Models for Time-to-Event Outcomes\n\n### Exponential Distribution\n\n-   The exponential distribution is the base distribution for survival\n    analysis.\n-   The distribution has a constant hazard $\\lambda$\n-   The mean survival time is $\\lambda^{-1}$\n\n---\n\n#### Mathematical details of exponential distribution\n\n$$\n\\begin{aligned}\nf(t) &= \\lambda \\text{e}^{-\\lambda t}\\\\\nE(t) &= \\lambda^{-1}\\\\\nVar(t) &= \\lambda^{-2}\\\\\nF(t) &= 1-\\text{e}^{-\\lambda x}\\\\\nS(t)&= \\text{e}^{-\\lambda x}\\\\\n\\ln(S(t))&=-\\lambda x\\\\\nh(t) &= -\\frac{f(t)}{S(t)} = -\\frac{\\lambda \\text{e}^{-\\lambda t}}{\\text{e}^{-\\lambda t}}=\\lambda\n\\end{aligned}\n$$\n\n---\n\n#### Estimating $\\lambda$ {.smaller}\n\n-   Suppose we have $m$ exponential survival times of\n    $t_1, t_2,\\ldots,t_m$ and $k$ right-censored values at\n    $u_1,u_2,\\ldots,u_k$.\n\n-   A survival time of $t_i=10$ means that subject $i$ died at time 10.\n    A right-censored time $u_i=10$ means that at time 10, subject $i$\n    was still alive and that we have no further follow-up.\n\n-   For the moment we will assume that the survival distribution is\n    exponential and that all the subjects have the same parameter\n    $\\lambda$.\n\nWe have $m$ exponential survival times of $t_1, t_2,\\ldots,t_m$ and $k$\nright-censored values at $u_1,u_2,\\ldots,u_k$. The log-likelihood of an\nobserved survival time $t_i$ is $$\n\\text{log}\\left\\{\\lambda \\text{e}^{-\\lambda t_i}\\right\\} =\n\\text{log}\\left\\{\\lambda\\right\\}-\\lambda t_i\n$$ and the likelihood of a censored value is the probability of that\noutcome (survival greater than $u_j$) so the log-likelihood is \n\n$$\n\\ba\n\\ell_j(\\lambda) &= \\text{log}\\left\\{\\lambda \\text{e}^{u_j}\\right\\} \n\\\\ &= -\\lambda u_j\n\\ea\n$$\n\n---\n\n:::{#thm-mle-exp}\nLet $T=\\sum t_i$ and $U=\\sum u_j$. Then:\n\n$$\n\\hat{\\lambda}_{ML} = \\frac{m}{T+U}\n$$ {#eq-mle-exp}\n:::\n\n---\n\n::: proof\n\n$$\n\\begin{aligned}\n\\ell(\\lambda) &= \\sum_{i=1}^m( \\ln \\lambda-\\lambda t_i) + \\sum_{j=1}^k (-\\lambda u_j)\\\\\n&= m \\ln \\lambda -(T+U)\\lambda\\\\\n\\ell'(\\lambda) \n&=m\\lambda^{-1} -(T+U)\\\\\n\\hat{\\lambda} &= \\frac{m}{T+U}\n\\ea\n$$\n:::\n\n---\n\n$$\n\\ba\n\\ell''&=-m/\\lambda^2\\\\\n&< 0\\\\\n\\hat E[T] &= \\hat\\lambda^{-1}\\\\\n&= \\frac{T+U}{m}\n\\end{aligned}\n$$\n\n---\n\n#### Fisher Information and Standard Error\n\n$$\n\\begin{aligned}\nE[-\\ell'']\n& = m/\\lambda^2\\\\\n\\text{Var}\\left(\\hat\\lambda\\right) \n&\\approx \\left(E[-\\ell'']\\right)^{-1}\\\\\n&=\\lambda^2/m\\\\\n\\text{SE}\\left(\\hat\\lambda\\right) \n&= \\sqrt{\\text{Var}\\left(\\hat\\lambda\\right)}\\\\\n&\\approx \\lambda/\\sqrt{m}\n\\end{aligned}\n$$\n\n::: notes\n$\\hat\\lambda$ depends on the censoring times of the censored\nobservations, but $\\text{Var}\\left(\\hat\\lambda\\right)$ only depends on\nthe number of uncensored observations, $m$, and not on the number of\ncensored observations ($k$).\n:::\n\n---\n\n### Other Parametric Survival Distributions\n\n-   Any density on $[0,\\infty)$ can be a survival distribution, but the\n    most useful ones are all skew right.\n-   The most frequently used generalization of the exponential is the [Weibull](probability.qmd#sec-weibull).\n-   Other common choices are the gamma, log-normal, log-logistic,\n    Gompertz, inverse Gaussian, and Pareto.\n-   Most of what we do going forward is non-parametric or\n    semi-parametric, but sometimes these parametric distributions\n    provide a useful approach.\n\n## Nonparametric Survival Analysis\n\n### Basic ideas\n\n-   Mostly, we work without a parametric model.\n\n-   The first task is to estimate a survival function from data listing\n    survival times, and censoring times for censored data.\n\n-   For example one patient may have relapsed at 10 months. Another\n    might have been followed for 32 months without a relapse having\n    occurred (censored).\n\n-   The minimum information we need for each patient is a time and a\n    censoring variable which is 1 if the event occurred at the indicated\n    time and 0 if this is a censoring time.\n\n## Example: clinical trial for pediatric acute leukemia\n\n### Overview of study {.smaller}\n\nThis is from a clinical trial in 1963 for 6-MP treatment vs. placebo for\nAcute Leukemia in 42 children.\n\n-   Pairs of children:\n\n    -   matched by remission status at the time of treatment (`remstat`:\n        `1` = partial, `2` = complete)\n    -   randomized to 6-MP (exit times in `t2`) or placebo (exit times\n        in `t1`)\n\n-   Followed until relapse or end of study.\n\n-   All of the placebo group relapsed, but some of the 6-MP group were\n    censored (which means they were still in remission); indicated by\n    `relapse` variable (`0` = censored, `1` = relapse).\n\n-   6-MP = 6-Mercaptopurine (Purinethol) is an anti-cancer\n    (\"antineoplastic\" or \"cytotoxic\") chemotherapy drug used currently\n    for Acute lymphoblastic leukemia (ALL). It is classified as an\n    antimetabolite.\n\n### Study design {.smaller}\n\n- Clinical trial in 1963 for 6-MP treatment vs. placebo for Acute Leukemia\nin 42 children. \n- Pairs of children:\n  - matched by remission status at the time of treatment (`remstat`)\n     - `remstat` = 1: partial \n     - `remstat` = 2: complete\n  - randomized to 6-MP (exit time: `t2`) or placebo (`t1`). \n- Followed until relapse or end of study. \n  - All of the placebo group relapsed, \n  - Some of the 6-MP group were censored.\n\n---\n\n\n\n\n\n\n\n\n::: {#tbl-drug6mp .cell tbl-cap='`drug6mp` pediatric acute leukemia data'}\n\n```{.r .cell-code}\nlibrary(KMsurv)\ndata(drug6mp)\ndrug6mp = drug6mp |> as_tibble() |> print()\n#> # A tibble: 21 x 5\n#>     pair remstat    t1    t2 relapse\n#>    <int>   <int> <int> <int>   <int>\n#>  1     1       1     1    10       1\n#>  2     2       2    22     7       1\n#>  3     3       2     3    32       0\n#>  4     4       2    12    23       1\n#>  5     5       2     8    22       1\n#>  6     6       1    17     6       1\n#>  7     7       2     2    16       1\n#>  8     8       2    11    34       0\n#>  9     9       2     8    32       0\n#> 10    10       2    12    25       0\n#> # i 11 more rows\n```\n:::\n\n\n\n\n\n\n\n\n### Data documentation for `drug6mp`\n\n\n\n\n\n\n\n\n::: {.cell printr.help.sections='[\"description\",\"format\"]'}\n\n```{.r .cell-code}\n# library(printr) # inserts help-file output into markdown output\nlibrary(KMsurv)\n?drug6mp\n```\n:::\n\n\n\n\n\n\n\n\n### Descriptive Statistics {.smaller}\n\n\n\n\n\n\n\n\n::: {#tbl-drug6mp-summary .cell tbl-cap='Summary statistics for `drug6mp` data'}\n\n```{.r .cell-code  code-fold=\"show\"}\nsummary(drug6mp)\n#>       pair       remstat           t1              t2          relapse     \n#>  Min.   : 1   Min.   :1.00   Min.   : 1.00   Min.   : 6.0   Min.   :0.000  \n#>  1st Qu.: 6   1st Qu.:2.00   1st Qu.: 4.00   1st Qu.: 9.0   1st Qu.:0.000  \n#>  Median :11   Median :2.00   Median : 8.00   Median :16.0   Median :0.000  \n#>  Mean   :11   Mean   :1.76   Mean   : 8.67   Mean   :17.1   Mean   :0.429  \n#>  3rd Qu.:16   3rd Qu.:2.00   3rd Qu.:12.00   3rd Qu.:23.0   3rd Qu.:1.000  \n#>  Max.   :21   Max.   :2.00   Max.   :23.00   Max.   :35.0   Max.   :1.000\n```\n:::\n\n\n\n\n\n\n\n\n::: notes\n\n-   The average time in each group is not useful. Some of the 6-MP\n    patients have not relapsed at the time recorded, while all of the\n    placebo patients have relapsed.\n-   The median time is not really useful either because so many of the\n    6-MP patients have not relapsed (12/21).\n-   Both are biased down in the 6-MP group. Remember that lower times\n    are worse since they indicate sooner recurrence.\n:::\n\n### Exponential model\n\n::: notes\n-   We *can* compute the hazard rate, assuming an exponential model:\nnumber of relapses divided by the sum of the exit times (@eq-mle-exp).\n:::\n\n$$\\hat\\lambda = \\frac{\\sumin D_i}{\\sumin Y_i}$$\n\n::: notes\n-   For the placebo, that is just the reciprocal of the mean time:\n:::\n$$\n\\ba\n\\hat \\lambda_{\\text{placebo}} \n&= \\frac{\\sumin D_i}{\\sumin Y_i}\n\\\\ &= \\frac{\\sumin 1}{\\sumin Y_i}\n\\\\ &= \\frac{n}{\\sumin Y_i}\n\\\\ &= \\frac{1}{\\bar{Y}}\n\\\\ &= \\frac{1}{8.6667}\n\\\\ &= 0.1154\n\\ea\n$$\n\n---\n\n-   For the 6-MP group, $\\hat\\lambda = 9/359 = 0.025$\n\n$$\n\\ba\n\\hat \\lambda_{\\text{6-MP}} \n&= \\frac{\\sumin D_i}{\\sumin Y_i}\n\\\\ &= \\frac{9}{359}\n\\\\ &= 0.0251\n\\ea\n$$\n\n-   The estimated hazard in the placebo group is 4.6 times as\n    large as in the 6-MP group (assuming the hazard is constant over time).\n\n\n## The Kaplan-Meier Product Limit Estimator\n\n### Estimating survival in datasets without censoring\n\n::: notes\nIn the `drug6mp` dataset, the estimated survival function for the placebo patients is easy to compute. \nFor any time $t$ in months, $S(t)$ is the fraction of patients with times greater than $t$:\n:::\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n### Estimating survival in datasets with censoring\n\n-   For the 6-MP patients, we cannot ignore the censored data because we\n    know that the time to relapse is greater than the censoring time.\n\n-   For any time $t$ in months, we know that 6-MP patients with times\n    greater than $t$ have not relapsed, and those with relapse time less\n    than $t$ have relapsed, but we don't know if patients with censored\n    time less than $t$ have relapsed or not.\n\n-   The procedure we usually use is the Kaplan-Meier product-limit\n    estimator of the survival function.\n\n-   The Kaplan-Meier estimator is a step function (like the empirical\n    cdf), which changes value only at the event times, not at the\n    censoring times.\n\n-   At each event time $t$, we compute the at-risk group size $Y$, which\n    is all those observations whose event time or censoring time is at\n    least $t$.\n\n-   If $d$ of the observations have an event time (not a censoring time)\n    of $t$, then the group of survivors immediately following time $t$\n    is reduced by the fraction $$\\frac{Y-d}{Y}=1-\\frac{d}{Y}$$\n\n---\n\n:::{#def-KM-estimator}\n\n#### Kaplan-Meier Product-Limit Estimator of Survival Function\n\nIf the event times are $t_i$ with events per time of $d_i$ ($1\\le i \\le k$), \nthen the **Kaplan-Meier Product-Limit Estimator** \nof the [survival function](@def-surv-fn) is:\n\n$$\\hat S(t) = \\prod_{t_i < t} \\sb{\\frac{1-d_i}{Y_i}}$${#eq-km-surv-est}\n\nwhere $Y_i$ is the set of observations whose time (event or censored) is\n$\\ge t_i$, the group at risk at time $t_i$.\n\n:::\n\n---\n\n:::{#thm-KM-est-no-cens}\n#### Kaplan-Meier Estimate with No Censored Observations\n\nIf there are no censored data, and there are $n$ data points, then just\nafter (say) the third event time \n\n$$\n\\begin{aligned}\n\\hat S(t) \n&= \\prod_{t_i < t}\\sb{1-\\frac{d_i}{Y_i}}\n\\\\ &= \\sb{\\frac{n-d_1}{n}} \\sb{\\frac{n-d_1-d_2}{n-d_1}} \\sb{\\frac{n-d_1-d_2-d_3}{n-d_1-d_2}}\n\\\\ &= \\frac{n-d_1-d_2-d_3}{n}\n\\\\ &=1-\\frac{d_1+d_2+d_3}{n}\n\\\\ &=1-\\hat F(t)\n\\end{aligned}\n$$\n\nwhere $\\hat F(t)$ is the usual empirical CDF estimate.\n\n:::\n\n### Kaplan-Meier curve for `drug6mp` data\n\nHere is the Kaplan-Meier estimated survival curve for the patients who\nreceived 6-MP in the `drug6mp` dataset (we will see code to produce\nfigures like this one shortly):\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# | echo: false\n\nrequire(KMsurv)\ndata(drug6mp)\nlibrary(dplyr)\nlibrary(survival)\n\ndrug6mp_km_model1 = \n  drug6mp |> \n  mutate(surv = Surv(t2, relapse))  |> \n  survfit(formula = surv ~ 1, data = _)\n\nlibrary(ggfortify)\ndrug6mp_km_model1 |>  \n  autoplot(\n    mark.time = TRUE,\n    conf.int = FALSE) +\n  expand_limits(y = 0) +\n  xlab('Time since diagnosis (months)') +\n  ylab(\"KM Survival Curve\")\n\n```\n\n::: {.cell-output-display}\n![Kaplan-Meier Survival Curve for 6-MP Patients](intro-to-survival-analysis_files/figure-pdf/fig-KM-mp6-1.pdf){#fig-KM-mp6}\n:::\n:::\n\n\n\n\n\n\n\n\n### Kaplan-Meier calculations {.smaller}\n\nLet's compute these estimates and build the chart by hand:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(KMsurv)\nlibrary(dplyr)\ndata(drug6mp)\n\ndrug6mp.v2 = \n  drug6mp |> \n  as_tibble() |> \n  mutate(\n    remstat = remstat |> \n      case_match(\n        1 ~ \"partial\",\n        2 ~ \"complete\"\n      ),\n    # renaming to \"outcome\" while relabeling is just a style choice:\n    outcome = relapse |> \n      case_match(\n        0 ~ \"censored\",\n        1 ~ \"relapsed\"\n      )\n  )\n\nkm.6mp =\n  drug6mp.v2 |> \n  summarize(\n    .by = t2,\n    Relapses = sum(outcome == \"relapsed\"),\n    Censored = sum(outcome == \"censored\")) |>\n  # here we add a start time row, so the graph starts at time 0:\n  bind_rows(\n    tibble(\n      t2 = 0, \n      Relapses = 0, \n      Censored = 0)\n  ) |> \n  # sort in time order:\n  arrange(t2) |>\n  mutate(\n    Exiting = Relapses + Censored,\n    `Study Size` = sum(Exiting),\n    Exited = cumsum(Exiting) |> dplyr::lag(default = 0),\n    `At Risk` = `Study Size` - Exited,\n    Hazard = Relapses / `At Risk`,\n    `KM Factor` = 1 - Hazard,\n    `Cumulative Hazard` = cumsum(`Hazard`),\n    `KM Survival Curve` = cumprod(`KM Factor`)\n  )\n\nlibrary(pander)  \npander(km.6mp)\n```\n\n::: {.cell-output-display}\n\n----------------------------------------------------------------------------------------------------------------------------------\n t2   Relapses   Censored   Exiting   Study Size   Exited   At Risk   Hazard    KM Factor   Cumulative Hazard   KM Survival Curve \n---- ---------- ---------- --------- ------------ -------- --------- --------- ----------- ------------------- -------------------\n 0       0          0          0          21         0        21         0          1               0                   1         \n\n 6       3          1          4          21         0        21      0.1429     0.8571          0.1429              0.8571       \n\n 7       1          0          1          21         4        17      0.05882    0.9412          0.2017              0.8067       \n\n 9       0          1          1          21         5        16         0          1            0.2017              0.8067       \n\n 10      1          1          2          21         6        15      0.06667    0.9333          0.2683              0.7529       \n\n 11      0          1          1          21         8        13         0          1            0.2683              0.7529       \n\n 13      1          0          1          21         9        12      0.08333    0.9167          0.3517              0.6902       \n\n 16      1          0          1          21         10       11      0.09091    0.9091          0.4426              0.6275       \n\n 17      0          1          1          21         11       10         0          1            0.4426              0.6275       \n\n 19      0          1          1          21         12        9         0          1            0.4426              0.6275       \n\n 20      0          1          1          21         13        8         0          1            0.4426              0.6275       \n\n 22      1          0          1          21         14        7      0.1429     0.8571          0.5854              0.5378       \n\n 23      1          0          1          21         15        6      0.1667     0.8333          0.7521              0.4482       \n\n 25      0          1          1          21         16        5         0          1            0.7521              0.4482       \n\n 32      0          2          2          21         17        4         0          1            0.7521              0.4482       \n\n 34      0          1          1          21         19        2         0          1            0.7521              0.4482       \n\n 35      0          1          1          21         20        1         0          1            0.7521              0.4482       \n----------------------------------------------------------------------------------------------------------------------------------\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n---\n\n#### Summary\n\nFor the 6-MP patients at time 6 months, there are 21 patients at risk.\nAt $t=6$ there are 3 relapses and 1 censored observations.\n\nThe Kaplan-Meier factor is $(21-3)/21 = 0.857$. The number at risk for\nthe next time ($t=7$) is $21-3-1=17$.\n\nAt time 7 months, there are 17 patients at risk. At $t=7$ there is 1\nrelapse and 0 censored observations. The Kaplan-Meier factor is\n$(17-1)/17 = 0.941$. The Kaplan Meier estimate is\n$0.857\\times0.941=0.807$. The number at risk for the next time ($t=9$)\nis $17-1=16$.\n\n---\n\nNow, let's graph this estimated survival curve using `ggplot()`:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nconflicts_prefer(dplyr::filter)\nkm.6mp |> \n  ggplot(aes(x = t2, y = `KM Survival Curve`)) +\n  geom_step() +\n  geom_point(data = km.6mp |> filter(Censored > 0), shape = 3) +\n  expand_limits(y = c(0,1), x = 0) +\n  xlab('Time since diagnosis (months)') +\n  ylab(\"KM Survival Curve\") +\n  scale_y_continuous(labels = scales::percent)\n```\n\n::: {.cell-output-display}\n![KM curve for 6MP patients, calculated by hand](intro-to-survival-analysis_files/figure-pdf/fig-km-by-hand-1.pdf){#fig-km-by-hand}\n:::\n:::\n\n\n\n\n\n\n\n\n## Using the `survival` package in R\n\nWe don't have to do these calculations by hand every time; the\n`survival` package and several others have functions available to\nautomate many of these tasks (full list:\n<https://cran.r-project.org/web/views/Survival.html>).\n\n### The `Surv` function\n\nTo use the `survival` package, the first step is telling R how to\ncombine the exit time and exit reason (censoring versus event) columns.\nThe `Surv()` function accomplishes this task.\n\n#### Example: `Surv()` with `drug6mp` data\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"show\" code-line-numbers=\"5-7\"}\nlibrary(survival)\ndrug6mp.v3 = \n  drug6mp.v2 |> \n  mutate(\n    surv2 = Surv(\n      time = t2,\n      event = (outcome == \"relapsed\")))\n\nprint(drug6mp.v3)\n#> # A tibble: 21 x 7\n#>     pair remstat     t1    t2 relapse outcome   surv2\n#>    <int> <chr>    <int> <int>   <int> <chr>    <Surv>\n#>  1     1 partial      1    10       1 relapsed    10 \n#>  2     2 complete    22     7       1 relapsed     7 \n#>  3     3 complete     3    32       0 censored    32+\n#>  4     4 complete    12    23       1 relapsed    23 \n#>  5     5 complete     8    22       1 relapsed    22 \n#>  6     6 partial     17     6       1 relapsed     6 \n#>  7     7 complete     2    16       1 relapsed    16 \n#>  8     8 complete    11    34       0 censored    34+\n#>  9     9 complete     8    32       0 censored    32+\n#> 10    10 complete    12    25       0 censored    25+\n#> # i 11 more rows\n```\n:::\n\n\n\n\n\n\n\n\nThe output of `Surv()` is a vector of objects with class `Surv`. When we\nprint this vector:\n\n-   observations where the event was observed are printed as the event\n    time (for example, `surv2 = 10` on line 1)\n\n-   observations where the event was right-censored are printed as the\n    censoring time with a plus sign (`+`; for example, `surv2 = 32+` on\n    line 3).\n\n### The `survfit` function\n\nOnce we have constructed our `Surv` variable, we can calculate the\nKaplan-Meier estimate of the survival curve using the `survfit()`\nfunction.\n\n::: callout-note\nThe documentation for `?survfit` isn't too helpful; the\n`survfit.formula` documentation is better.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n:::\n\n---\n\n#### Example: `survfit()` with `drug6mp` data\n\nHere we use `survfit()` to create a `survfit` object, which contains the\nKaplan-Meier estimate:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"show\"}\ndrug6mp.km_model = survfit(\n  formula = surv2 ~ 1, \n  data = drug6mp.v3)\n```\n:::\n\n\n\n\n\n\n\n\n`print.survfit()` just gives some summary statistics:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"show\"}\nprint(drug6mp.km_model)\n#> Call: survfit(formula = surv2 ~ 1, data = drug6mp.v3)\n#> \n#>       n events median 0.95LCL 0.95UCL\n#> [1,] 21      9     23      16      NA\n```\n:::\n\n\n\n\n\n\n\n\n`summary.survfit()` shows us the underlying Kaplan-Meier table:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"show\"}\nsummary(drug6mp.km_model)\n#> Call: survfit(formula = surv2 ~ 1, data = drug6mp.v3)\n#> \n#>  time n.risk n.event survival std.err lower 95% CI upper 95% CI\n#>     6     21       3    0.857  0.0764        0.720        1.000\n#>     7     17       1    0.807  0.0869        0.653        0.996\n#>    10     15       1    0.753  0.0963        0.586        0.968\n#>    13     12       1    0.690  0.1068        0.510        0.935\n#>    16     11       1    0.627  0.1141        0.439        0.896\n#>    22      7       1    0.538  0.1282        0.337        0.858\n#>    23      6       1    0.448  0.1346        0.249        0.807\n```\n:::\n\n\n\n\n\n\n\n\n---\n\nWe can specify which time points we want using the `times` argument:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"show\"}\nsummary(\n  drug6mp.km_model, \n  times = c(0, drug6mp.v3$t2))\n#> Call: survfit(formula = surv2 ~ 1, data = drug6mp.v3)\n#> \n#>  time n.risk n.event survival std.err lower 95% CI upper 95% CI\n#>     0     21       0    1.000  0.0000        1.000        1.000\n#>    10     15       1    0.753  0.0963        0.586        0.968\n#>     7     17       1    0.807  0.0869        0.653        0.996\n#>    32      4       0    0.448  0.1346        0.249        0.807\n#>    23      6       1    0.448  0.1346        0.249        0.807\n#>    22      7       1    0.538  0.1282        0.337        0.858\n#>     6     21       3    0.857  0.0764        0.720        1.000\n#>    16     11       1    0.627  0.1141        0.439        0.896\n#>    34      2       0    0.448  0.1346        0.249        0.807\n#>    32      4       0    0.448  0.1346        0.249        0.807\n#>    25      5       0    0.448  0.1346        0.249        0.807\n#>    11     13       0    0.753  0.0963        0.586        0.968\n#>    20      8       0    0.627  0.1141        0.439        0.896\n#>    19      9       0    0.627  0.1141        0.439        0.896\n#>     6     21       3    0.857  0.0764        0.720        1.000\n#>    17     10       0    0.627  0.1141        0.439        0.896\n#>    35      1       0    0.448  0.1346        0.249        0.807\n#>     6     21       3    0.857  0.0764        0.720        1.000\n#>    13     12       1    0.690  0.1068        0.510        0.935\n#>     9     16       0    0.807  0.0869        0.653        0.996\n#>     6     21       3    0.857  0.0764        0.720        1.000\n#>    10     15       1    0.753  0.0963        0.586        0.968\n```\n:::\n\n\n\n\n\n\n\n\n---\n\n\n\n\n\n\n\n\n::: {.cell printr.help.sections='[\"description\",\"usage\",\"arguments\"]'}\n\n```{.r .cell-code  code-fold=\"show\"}\n?summary.survfit\n```\n:::\n\n\n\n\n\n\n\n\n### Plotting estimated survival functions\n\nWe can plot `survfit` objects with `plot()`, `autoplot()`, or\n`ggsurvplot()`:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"show\"}\nlibrary(ggfortify)\nautoplot(drug6mp.km_model)\n```\n\n::: {.cell-output-display}\n![Kaplan-Meier Survival Curve for 6-MP Patients](intro-to-survival-analysis_files/figure-pdf/unnamed-chunk-24-1.pdf)\n:::\n\n```{.r .cell-code  code-fold=\"show\"}\n\n# not shown:\n# plot(drug6mp.km_model)\n\n# library(survminer)\n# ggsurvplot(drug6mp.km_model)\n\n```\n:::\n\n\n\n\n\n\n\n\n---\n\n#### quantiles of survival curve\n\nWe can extract quantiles with `quantile()`:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-line-numbers=\"2\"}\ndrug6mp.km_model |> \n  quantile(p = c(.25, .5)) |> \n  as_tibble() |> \n  mutate(p = c(.25, .5)) |> \n  relocate(p, .before = everything())\n#> # A tibble: 2 x 4\n#>       p quantile lower upper\n#>   <dbl>    <dbl> <dbl> <dbl>\n#> 1  0.25       13     6    NA\n#> 2  0.5        23    16    NA\n```\n:::\n\n\n\n\n\n\n\n\n## Two-sample \"log-rank\"/\"Mantel-Haenszel\" test\n\n### The `survdiff` function\n\n\n\n\n\n\n\n\n::: {.cell printr.help.sections='[\"description\",\"usage\"]'}\n\n```{.r .cell-code}\n?survdiff\n```\n:::\n\n\n\n\n\n\n\n\n### Example: `survdiff()` with `drug6mp` data\n\nNow we are going to compare the placebo and 6-MP data. We need to\nreshape the data to make it usable with the standard `survival`\nworkflow:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(survival)\nlibrary(tidyr)\ndrug6mp.v4 = \n  drug6mp.v3 |>\n  select(pair, remstat, t1, t2, outcome) |> \n  # here we are going to change the data from a wide format to long:\n  pivot_longer(\n    cols = c(t1, t2),\n    names_to = \"treatment\",\n    values_to = \"exit_time\") |> \n  mutate(\n    treatment = treatment |> \n      case_match(\n        \"t1\" ~ \"placebo\",\n        \"t2\" ~ \"6-MP\"\n      ),\n    outcome = if_else(\n      treatment == \"placebo\",\n      \"relapsed\",\n      outcome\n    ),\n    surv = Surv(\n      time = exit_time,\n      event = (outcome == \"relapsed\"))\n  )\n```\n:::\n\n\n\n\n\n\n\n\n---\n\nUsing this long data format, we can fit a Kaplan-Meier curve for each\ntreatment group simultaneously:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndrug6mp.km_model2 = \n   survfit(\n  formula = surv ~ treatment, \n  data = drug6mp.v4)\n```\n:::\n\n\n\n\n\n\n\n\n---\n\nWe can plot the curves in the same graph:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndrug6mp.km_model2 |> autoplot()\n```\n\n::: {.cell-output-display}\n![](intro-to-survival-analysis_files/figure-pdf/unnamed-chunk-29-1.pdf)\n:::\n:::\n\n\n\n\n\n\n\n\n---\n\nWe can also perform something like a t-test, where the null hypothesis\nis that the curves are the same:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvdiff(\n  formula = surv ~ treatment,\n  data = drug6mp.v4)\n#> Call:\n#> survdiff(formula = surv ~ treatment, data = drug6mp.v4)\n#> \n#>                    N Observed Expected (O-E)^2/E (O-E)^2/V\n#> treatment=6-MP    21        9     19.3      5.46      16.8\n#> treatment=placebo 21       21     10.7      9.77      16.8\n#> \n#>  Chisq= 16.8  on 1 degrees of freedom, p= 4e-05\n```\n:::\n\n\n\n\n\n\n\n\nBy default, `survdiff()` ignores any pairing, \nbut we can use `strata()` to perform something similar to a paired t-test:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvdiff(\n  formula = surv ~ treatment + strata(pair),\n  data = drug6mp.v4)\n#> Call:\n#> survdiff(formula = surv ~ treatment + strata(pair), data = drug6mp.v4)\n#> \n#>                    N Observed Expected (O-E)^2/E (O-E)^2/V\n#> treatment=6-MP    21        9     16.5      3.41      10.7\n#> treatment=placebo 21       21     13.5      4.17      10.7\n#> \n#>  Chisq= 10.7  on 1 degrees of freedom, p= 0.001\n```\n:::\n\n\n\n\n\n\n\n\nInterestingly, accounting for pairing reduces the significant of the\ndifference.\n\n## Example: Bone Marrow Transplant Data\n\nData from @copelan1991treatment\n\n---\n\n![Recovery process from a bone marrow transplant (Fig. 1.1 from @klein2003survival)](images/bone marrow multi-stage model.png){#fig-bmt-mst}\n\n---\n\n\n### Study design\n\n##### Treatment {.unnumbered}\n\n-   **allogeneic** (from a donor) **bone marrow transplant therapy**\n\n##### Inclusion criteria {.unnumbered}\n\n-   **acute myeloid leukemia (AML)**\n-   **acute lymphoblastic leukemia (ALL).**\n\n##### Possible intermediate events {.unnumbered}\n\n-   **graft vs. host disease (GVHD)**: an immunological rejection\n    response to the transplant\n-   **platelet recovery**: a return of platelet count to normal levels.\n\nOne or the other, both in either order, or neither may occur.\n\n##### End point events\n\n-   relapse of the disease\n-   death\n\nAny or all of these events may be censored.\n\n### `KMsurv::bmt` data in R\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(KMsurv)\n?bmt\n```\n:::\n\n\n\n\n\n\n\n\n### Analysis plan\n\n-   We concentrate for now on disease-free survival (`t2` and `d3`) for\n    the three risk groups, ALL, AML Low Risk, and AML High Risk.\n-   We will construct the Kaplan-Meier survival curves, compare them,\n    and test for differences.\n-   We will construct the cumulative hazard curves and compare them.\n-   We will estimate the hazard functions, interpret, and compare them.\n\n### Survival Function Estimate and Variance\n\n$$\\hat S(t) = \\prod_{t_i < t}\\left[1-\\frac{d_i}{Y_i}\\right]$$ where\n$Y_i$ is the group at risk at time $t_i$.\n\nThe estimated variance of $\\hat S(t)$ is:\n\n:::{#thm-greenwood}\n#### Greenwood's estimator for variance of Kaplan-Meier survival estimator\n\n$$\n\\varhf{\\hat S(t)} = \\hat S(t)^2\\sum_{t_i <t}\\frac{d_i}{Y_i(Y_i-d_i)}\n$${#eq-var-est-surv}\n:::\n\n\nWe can use @eq-var-est-surv for confidence intervals for a survival function or a\ndifference of survival functions.\n\n---\n\n##### Kaplan-Meier survival curves\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"code to preprocess and model `bmt` data\"}\nlibrary(KMsurv)\nlibrary(survival)\ndata(bmt)\n\nbmt = \n  bmt |> \n  as_tibble() |> \n  mutate(\n    group = \n      group |> \n      factor(\n        labels = c(\"ALL\",\"Low Risk AML\",\"High Risk AML\")),\n    surv = Surv(t2,d3))\n\nkm_model1 = survfit(\n  formula = surv ~ group, \n  data = bmt)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggfortify)\nautoplot(\n  km_model1, \n  conf.int = TRUE,\n  ylab = \"Pr(disease-free survival)\",\n  xlab = \"Time since transplant (days)\") + \n  theme_bw() +\n  theme(legend.position=\"bottom\")\n```\n\n::: {.cell-output-display}\n![Disease-Free Survival by Disease Group](intro-to-survival-analysis_files/figure-pdf/KM survival curves for bmt data-1.pdf)\n:::\n:::\n\n\n\n\n\n\n\n\n---\n\n### Understanding Greenwood's formula (optional)\n\n::: notes\nTo see where Greenwood's formula comes from, let $x_i = Y_i - d_i$. We\napproximate the solution treating each time as independent, with $Y_i$\nfixed and ignore randomness in times of failure and we treat $x_i$ as\nindependent binomials $\\text{Bin}(Y_i,p_i)$. Letting $S(t)$ be the\n\"true\" survival function\n:::\n\n$$\n\\begin{aligned}\n\\hat S(t) &=\\prod_{t_i<t}x_i/Y_i\\\\\nS(t)&=\\prod_{t_i<t}p_i\n\\end{aligned}\n$$\n\n$$\n\\begin{aligned}\n\\frac{\\hat S(t)}{S(t)} \n   &= \\prod_{t_i<t} \\frac{x_i}.    {p_iY_i}\n\\\\ &= \\prod_{t_i<t} \\frac{\\hat p_i}{p_i}\n\\\\ &= \\prod_{t_i<t} \\paren{1+\\frac{\\hat p_i-p_i}{p_i}}\n\\\\ &\\approx 1+\\sum_{t_i<t} \\frac{\\hat p_i-p_i}{p_i}\n\\end{aligned}\n$$\n\n---\n\n$$\n\\begin{aligned}\n\\text{Var}\\left(\\frac{\\hat S(t)}{S(t)}\\right) \n&\\approx \\text{Var}\\left(1+\\sum_{t_i<t} \\frac{\\hat p_i-p_i}{p_i}\\right) \n\\\\ &=\\sum_{t_i<t} \\frac{1}{p_i^2}\\frac{p_i(1-p_i)}{Y_i} \n\\\\ &= \\sum_{t_i<t} \\frac{(1-p_i)}{p_iY_i}\n\\\\ &\\approx\\sum_{t_i<t} \\frac{(1-x_i/Y_i)}{x_i}\n\\\\ &=\\sum_{t_i<t} \\frac{Y_i-x_i}{x_iY_i}\n\\\\ &=\\sum_{t_i<t} \\frac{d_i}{Y_i(Y_i-d_i)}\n\\\\ \\tf \\text{Var}\\left(\\hat S(t)\\right)\n&\\approx \\hat S(t)^2\\sum_{t_i<t} \\frac{d_i}{Y_i(Y_i-d_i)}\n\\end{aligned}\n$$\n\n### Test for differences among the disease groups\n\nHere we compute a chi-square test for assocation between disease group\n(`group`) and disease-free survival:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvdiff(surv ~ group, data = bmt)\n#> Call:\n#> survdiff(formula = surv ~ group, data = bmt)\n#> \n#>                      N Observed Expected (O-E)^2/E (O-E)^2/V\n#> group=ALL           38       24     21.9     0.211     0.289\n#> group=Low Risk AML  54       25     40.0     5.604    11.012\n#> group=High Risk AML 45       34     21.2     7.756    10.529\n#> \n#>  Chisq= 13.8  on 2 degrees of freedom, p= 0.001\n```\n:::\n\n\n\n\n\n\n\n\n### Cumulative Hazard\n\n$$\n\\begin{aligned}\nh(t) \n&\\eqdef   P(T=t|T\\ge t)\\\\\n&= \\frac{p(T=t)}{P(T\\ge t)}\\\\\n&= -\\deriv{t}\\text{log}\\left\\{S(t)\\right\\}\n\\end{aligned}\n$$\n\nThe **cumulative hazard** (or **integrated hazard**) function is\n\n$$H(t)\\eqdef  \\int_0^t h(t) dt$$ Since\n$h(t) = -\\deriv{t}\\text{log}\\left\\{S(t)\\right\\}$ as shown above, we\nhave:\n\n$$\nH(t)=-\\text{log}\\left\\{S\\right\\}(t)\n$$\n\n---\n\nSo we can estimate $H(t)$ as:\n\n$$\n\\begin{aligned}\n\\hat H(t) \n&= -\\text{log}\\left\\{\\hat S(t)\\right\\}\\\\\n&= -\\text{log}\\left\\{\\prod_{t_i < t}\\left[1-\\frac{d_i}{Y_i}\\right]\\right\\}\\\\\n&= -\\sum_{t_i < t}\\text{log}\\left\\{1-\\frac{d_i}{Y_i}\\right\\}\\\\\n\\end{aligned}\n$$\n\nThis is the **Kaplan-Meier (product-limit) estimate of cumulative\nhazard**.\n\n---\n\n#### Example: Cumulative Hazard Curves for Bone-Marrow Transplant (`bmt`) data\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nautoplot(\n  fun = \"cumhaz\",\n  km_model1, \n  conf.int = FALSE,\n  ylab = \"Cumulative hazard (disease-free survival)\",\n  xlab = \"Time since transplant (days)\") + \n  theme_bw() +\n  theme(legend.position=\"bottom\")\n```\n\n::: {.cell-output-display}\n![Disease-Free Cumulative Hazard by Disease Group](intro-to-survival-analysis_files/figure-pdf/fig-cuhaz-bmt-1.pdf){#fig-cuhaz-bmt}\n:::\n:::\n\n\n\n\n\n\n\n\n## Nelson-Aalen Estimates of Cumulative Hazard and Survival\n\n---\n\n:::{#def-na-cuhaz-est}\n#### Nelson-Aalen Cumulative Hazard Estimator\n:::: notes\nThe point hazard at time $t_i$ can be estimated by $d_i/Y_i$, which\nleads to the **Nelson-Aalen estimator of the cumulative hazard**:\n::::\n$$\\hat H_{NA}(t) \\eqdef \\sum_{t_i < t}\\frac{d_i}{Y_i}$${#eq-NA-cuhaz-est}\n\n:::\n\n---\n\n:::{#thm-var-NA-est}\n\n#### Variance of Nelson-Aalen estimator\n\n:::: notes\nThe variance of this estimator is approximately: \n::::\n\n$$\n\\begin{aligned}\n\\hat{\\text{Var}}\\left(\\hat H_{NA} (t)\\right) \n&= \\sum_{t_i <t}\\frac{(d_i/Y_i)(1-d_i/Y_i)}{Y_i}\\\\\n&\\approx \\sum_{t_i <t}\\frac{d_i}{Y_i^2}\n\\end{aligned}\n$${#eq-var-NA-cuhaz-est}\n\n:::\n\n---\n\nSince $S(t)=\\text{exp}\\left\\{-H(t)\\right\\}$, the Nelson-Aalen cumulative\nhazard estimate can be converted into an alternate estimate of the\nsurvival function:\n\n$$\n\\begin{aligned}\n\\hat S_{NA}(t)\n&= \\text{exp}\\left\\{-\\hat H_{NA}(t)\\right\\}\\\\\n&= \\text{exp}\\left\\{-\\sum_{t_i < t}\\frac{d_i}{Y_i}\\right\\}\\\\\n&= \\prod_{t_i < t}\\text{exp}\\left\\{-\\frac{d_i}{Y_i}\\right\\}\\\\\n\\end{aligned}\n$$\n\n---\n\nCompare these with the corresponding Kaplan-Meier estimates:\n\n$$\n\\begin{aligned}\n\\hat H_{KM}(t) &= -\\sum_{t_i < t}\\text{log}\\left\\{1-\\frac{d_i}{Y_i}\\right\\}\\\\\n\\hat S_{KM}(t) &= \\prod_{t_i < t}\\left[1-\\frac{d_i}{Y_i}\\right]\n\\end{aligned}\n$$\n\n::: notes\nThe product limit estimate and the Nelson-Aalen estimate often do not\ndiffer by much. The latter is considered more accurate in small samples\nand also directly estimates the cumulative hazard. \nThe `\"fleming-harrington\"` method for `survfit()` reduces to Nelson-Aalen\nwhen the data are unweighted. \nWe can also estimate the cumulative hazard\nas the negative log of the KM survival function estimate.\n:::\n\n### Application to `bmt` dataset\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n\nna_fit = survfit(\n  formula = surv ~ group,\n  type = \"fleming-harrington\",\n  data = bmt)\n\nkm_fit = survfit(\n  formula = surv ~ group,\n  type = \"kaplan-meier\",\n  data = bmt)\n\nkm_and_na = \n  bind_rows(\n    .id = \"model\",\n    \"Kaplan-Meier\" = km_fit |> fortify(surv.connect = TRUE),\n    \"Nelson-Aalen\" = na_fit |> fortify(surv.connect = TRUE)\n  ) |> \n  as_tibble()\n\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nkm_and_na |> \n  ggplot(aes(x = time, y = surv, col = model)) +\n  geom_step() +\n  facet_grid(. ~ strata) +\n  theme_bw() + \n  ylab(\"S(t) = P(T>=t)\") +\n  xlab(\"Survival time (t, days)\") +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![Kaplan-Meier and Nelson-Aalen Survival Function Estimates, stratified by disease group](intro-to-survival-analysis_files/figure-pdf/unnamed-chunk-37-1.pdf)\n:::\n:::\n\n\n\n\n\n\n\n\nThe Kaplan-Meier and Nelson-Aalen survival estimates are very similar\nfor this dataset.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}