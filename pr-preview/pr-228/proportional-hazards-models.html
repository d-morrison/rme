<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.34">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>7&nbsp; Proportional Hazards Models – Regression Models for Epidemiology</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./parametric-survival-models.html" rel="next">
<link href="./intro-to-survival-analysis.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-c8ad9e5dbd60b7b70b38521ab19b7da4.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-befe23ebd2f54d8af2c8a89d1a1611f1.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-c8ad9e5dbd60b7b70b38521ab19b7da4.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-23102fe0f0b5b1a9f09cc09ebcc8fe5b.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-11608ecab0b4e008b87a77b96745bd9e.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-23102fe0f0b5b1a9f09cc09ebcc8fe5b.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-VS314RJ2KP"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-VS314RJ2KP', { 'anonymize_ip': true});
</script><script type="application/json" class="js-hypothesis-config">
{
  "theme": "clean",
  "openSidebar": false,
  "enableExperimentalNewNoteButton": true
}
</script><script async="" src="https://hypothes.is/embed.js"></script><script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script><link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="custom.scss">
</head>
<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./time-to-event-models.html">Time to Event Models</a></li><li class="breadcrumb-item"><a href="./proportional-hazards-models.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Proportional Hazards Models</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Regression Models for Epidemiology</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/d-morrison/rme" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./Regression-Models-for-Epidemiology.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Intro-to-GLMs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./glms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generalized Linear Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Linear-models-overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Linear (Gaussian) Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./logistic-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Models for Binary Outcomes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./count-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Models for Count Outcomes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro-multilevel-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Introduction to multi-level models for correlated data</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./time-to-event-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Time to Event Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro-to-survival-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Introduction to Survival Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./proportional-hazards-models.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Proportional Hazards Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./parametric-survival-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Parametric survival models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./top-ten-concepts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Summary of Regression Modeling Concepts</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendices-are-prereqs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Overview of Appendices</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./math-prereqs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Mathematics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./probability.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Probability</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Estimation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Inference</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro-MLEs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">F</span>&nbsp; <span class="chapter-title">Introduction to Maximum Likelihood Inference</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro-bayes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">G</span>&nbsp; <span class="chapter-title">Introduction to Bayesian inference</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./common-mistakes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">H</span>&nbsp; <span class="chapter-title">Common Mistakes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./notation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">I</span>&nbsp; <span class="chapter-title">Notation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro-to-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">J</span>&nbsp; <span class="chapter-title">Statistical computing in R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./CONTRIBUTING.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">K</span>&nbsp; <span class="chapter-title">Contributing to <code>rme</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./midterm-formula-sheet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">L</span>&nbsp; <span class="chapter-title">Exam formula sheet</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#configuring-r" id="toc-configuring-r" class="nav-link active" data-scroll-target="#configuring-r">Configuring R</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"><span class="header-section-number">7.1</span> Introduction</a></li>
  <li>
<a href="#understanding-proportional-hazards-models" id="toc-understanding-proportional-hazards-models" class="nav-link" data-scroll-target="#understanding-proportional-hazards-models"><span class="header-section-number">7.2</span> Understanding proportional hazards models</a>
  <ul class="collapse">
<li><a href="#additional-properties-of-the-proportional-hazards-model" id="toc-additional-properties-of-the-proportional-hazards-model" class="nav-link" data-scroll-target="#additional-properties-of-the-proportional-hazards-model"><span class="header-section-number">7.2.1</span> Additional properties of the proportional hazards model</a></li>
  <li><a href="#summary-of-proportional-hazards-model-structure-and-assumptions" id="toc-summary-of-proportional-hazards-model-structure-and-assumptions" class="nav-link" data-scroll-target="#summary-of-proportional-hazards-model-structure-and-assumptions"><span class="header-section-number">7.2.2</span> Summary of proportional hazards model structure and assumptions</a></li>
  </ul>
</li>
  <li>
<a href="#testing-the-proportional-hazards-assumption" id="toc-testing-the-proportional-hazards-assumption" class="nav-link" data-scroll-target="#testing-the-proportional-hazards-assumption"><span class="header-section-number">7.3</span> Testing the proportional hazards assumption</a>
  <ul class="collapse">
<li><a href="#smoothed-hazard-functions" id="toc-smoothed-hazard-functions" class="nav-link" data-scroll-target="#smoothed-hazard-functions"><span class="header-section-number">7.3.1</span> Smoothed hazard functions</a></li>
  </ul>
</li>
  <li><a href="#fitting-proportional-hazards-models-to-data" id="toc-fitting-proportional-hazards-models-to-data" class="nav-link" data-scroll-target="#fitting-proportional-hazards-models-to-data"><span class="header-section-number">7.4</span> Fitting proportional hazards models to data</a></li>
  <li>
<a href="#example-proportional-hazards-model-for-the-bmt-data" id="toc-example-proportional-hazards-model-for-the-bmt-data" class="nav-link" data-scroll-target="#example-proportional-hazards-model-for-the-bmt-data"><span class="header-section-number">7.5</span> Example: Proportional hazards model for the <code>bmt</code> data</a>
  <ul class="collapse">
<li><a href="#fit-the-model" id="toc-fit-the-model" class="nav-link" data-scroll-target="#fit-the-model"><span class="header-section-number">7.5.1</span> Fit the model</a></li>
  <li><a href="#tests-for-nested-models" id="toc-tests-for-nested-models" class="nav-link" data-scroll-target="#tests-for-nested-models"><span class="header-section-number">7.5.2</span> Tests for nested models</a></li>
  <li><a href="#survival-curves-from-the-cox-model" id="toc-survival-curves-from-the-cox-model" class="nav-link" data-scroll-target="#survival-curves-from-the-cox-model"><span class="header-section-number">7.5.3</span> Survival Curves from the Cox Model</a></li>
  <li><a href="#examining-survfit" id="toc-examining-survfit" class="nav-link" data-scroll-target="#examining-survfit"><span class="header-section-number">7.5.4</span> Examining <code>survfit</code></a></li>
  </ul>
</li>
  <li><a href="#adjustment-for-ties-optional" id="toc-adjustment-for-ties-optional" class="nav-link" data-scroll-target="#adjustment-for-ties-optional"><span class="header-section-number">7.6</span> Adjustment for Ties (optional)</a></li>
  <li>
<a href="#building-cox-proportional-hazards-models" id="toc-building-cox-proportional-hazards-models" class="nav-link" data-scroll-target="#building-cox-proportional-hazards-models"><span class="header-section-number">7.7</span> Building Cox Proportional Hazards models</a>
  <ul class="collapse">
<li><a href="#hodg-lymphoma-data-set-from-kmsurv" id="toc-hodg-lymphoma-data-set-from-kmsurv" class="nav-link" data-scroll-target="#hodg-lymphoma-data-set-from-kmsurv"><span class="header-section-number">7.7.1</span> <code>hodg</code> Lymphoma Data Set from <code>KMsurv</code></a></li>
  <li><a href="#proportional-hazards-model-1" id="toc-proportional-hazards-model-1" class="nav-link" data-scroll-target="#proportional-hazards-model-1"><span class="header-section-number">7.7.2</span> Proportional hazards model</a></li>
  </ul>
</li>
  <li>
<a href="#diagnostic-graphs-for-proportional-hazards-assumption" id="toc-diagnostic-graphs-for-proportional-hazards-assumption" class="nav-link" data-scroll-target="#diagnostic-graphs-for-proportional-hazards-assumption"><span class="header-section-number">7.8</span> Diagnostic graphs for proportional hazards assumption</a>
  <ul class="collapse">
<li><a href="#analysis-plan" id="toc-analysis-plan" class="nav-link" data-scroll-target="#analysis-plan"><span class="header-section-number">7.8.1</span> Analysis plan</a></li>
  <li><a href="#kaplan-meier-survival-functions" id="toc-kaplan-meier-survival-functions" class="nav-link" data-scroll-target="#kaplan-meier-survival-functions"><span class="header-section-number">7.8.2</span> Kaplan-Meier survival functions</a></li>
  <li><a href="#observed-and-expected-survival-curves" id="toc-observed-and-expected-survival-curves" class="nav-link" data-scroll-target="#observed-and-expected-survival-curves"><span class="header-section-number">7.8.3</span> Observed and expected survival curves</a></li>
  <li><a href="#cumulative-hazard-log-scale-curves" id="toc-cumulative-hazard-log-scale-curves" class="nav-link" data-scroll-target="#cumulative-hazard-log-scale-curves"><span class="header-section-number">7.8.4</span> Cumulative hazard (log-scale) curves</a></li>
  </ul>
</li>
  <li>
<a href="#predictions-and-residuals" id="toc-predictions-and-residuals" class="nav-link" data-scroll-target="#predictions-and-residuals"><span class="header-section-number">7.9</span> Predictions and Residuals</a>
  <ul class="collapse">
<li><a href="#review-predictions-in-linear-regression" id="toc-review-predictions-in-linear-regression" class="nav-link" data-scroll-target="#review-predictions-in-linear-regression"><span class="header-section-number">7.9.1</span> Review: Predictions in Linear Regression</a></li>
  <li><a href="#review-residuals-in-linear-regression" id="toc-review-residuals-in-linear-regression" class="nav-link" data-scroll-target="#review-residuals-in-linear-regression"><span class="header-section-number">7.9.2</span> Review: Residuals in Linear Regression</a></li>
  <li><a href="#predictions-and-residuals-in-survival-models" id="toc-predictions-and-residuals-in-survival-models" class="nav-link" data-scroll-target="#predictions-and-residuals-in-survival-models"><span class="header-section-number">7.9.3</span> Predictions and Residuals in survival models</a></li>
  <li><a href="#wide-prediction-intervals" id="toc-wide-prediction-intervals" class="nav-link" data-scroll-target="#wide-prediction-intervals"><span class="header-section-number">7.9.4</span> Wide prediction intervals</a></li>
  <li><a href="#types-of-residuals-in-time-to-event-models" id="toc-types-of-residuals-in-time-to-event-models" class="nav-link" data-scroll-target="#types-of-residuals-in-time-to-event-models"><span class="header-section-number">7.9.5</span> Types of Residuals in Time-to-Event Models</a></li>
  <li><a href="#schoenfeld-residuals" id="toc-schoenfeld-residuals" class="nav-link" data-scroll-target="#schoenfeld-residuals"><span class="header-section-number">7.9.6</span> Schoenfeld residuals</a></li>
  </ul>
</li>
  <li><a href="#sec-cox-snell" id="toc-sec-cox-snell" class="nav-link" data-scroll-target="#sec-cox-snell"><span class="header-section-number">7.10</span> Goodness of Fit using the Cox-Snell Residuals</a></li>
  <li>
<a href="#martingale-residuals" id="toc-martingale-residuals" class="nav-link" data-scroll-target="#martingale-residuals"><span class="header-section-number">7.11</span> Martingale Residuals</a>
  <ul class="collapse">
<li><a href="#using-martingale-residuals" id="toc-using-martingale-residuals" class="nav-link" data-scroll-target="#using-martingale-residuals"><span class="header-section-number">7.11.1</span> Using Martingale Residuals</a></li>
  </ul>
</li>
  <li>
<a href="#checking-for-outliers-and-influential-observations" id="toc-checking-for-outliers-and-influential-observations" class="nav-link" data-scroll-target="#checking-for-outliers-and-influential-observations"><span class="header-section-number">7.12</span> Checking for Outliers and Influential Observations</a>
  <ul class="collapse">
<li><a href="#deviance-residuals" id="toc-deviance-residuals" class="nav-link" data-scroll-target="#deviance-residuals"><span class="header-section-number">7.12.1</span> Deviance Residuals</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"><span class="header-section-number">7.12.2</span> </a></li>
  <li><a href="#dfbeta" id="toc-dfbeta" class="nav-link" data-scroll-target="#dfbeta"><span class="header-section-number">7.12.3</span> dfbeta</a></li>
  <li><a href="#section-1" id="toc-section-1" class="nav-link" data-scroll-target="#section-1"><span class="header-section-number">7.12.4</span> </a></li>
  <li><a href="#action-items" id="toc-action-items" class="nav-link" data-scroll-target="#action-items"><span class="header-section-number">7.12.5</span> Action Items</a></li>
  </ul>
</li>
  <li>
<a href="#stratified-survival-models" id="toc-stratified-survival-models" class="nav-link" data-scroll-target="#stratified-survival-models"><span class="header-section-number">7.13</span> Stratified survival models</a>
  <ul class="collapse">
<li><a href="#revisiting-the-leukemia-dataset-anderson" id="toc-revisiting-the-leukemia-dataset-anderson" class="nav-link" data-scroll-target="#revisiting-the-leukemia-dataset-anderson"><span class="header-section-number">7.13.1</span> Revisiting the leukemia dataset (<code>anderson</code>)</a></li>
  <li><a href="#cox-semi-parametric-proportional-hazards-model" id="toc-cox-semi-parametric-proportional-hazards-model" class="nav-link" data-scroll-target="#cox-semi-parametric-proportional-hazards-model"><span class="header-section-number">7.13.2</span> Cox semi-parametric proportional hazards model</a></li>
  <li><a href="#graph-the-nelson-aalen-cumulative-hazard" id="toc-graph-the-nelson-aalen-cumulative-hazard" class="nav-link" data-scroll-target="#graph-the-nelson-aalen-cumulative-hazard"><span class="header-section-number">7.13.3</span> Graph the Nelson-Aalen cumulative hazard</a></li>
  <li><a href="#the-stratified-cox-model" id="toc-the-stratified-cox-model" class="nav-link" data-scroll-target="#the-stratified-cox-model"><span class="header-section-number">7.13.4</span> The Stratified Cox Model</a></li>
  <li><a href="#conclusions-1" id="toc-conclusions-1" class="nav-link" data-scroll-target="#conclusions-1"><span class="header-section-number">7.13.5</span> Conclusions</a></li>
  <li><a href="#another-modeling-approach" id="toc-another-modeling-approach" class="nav-link" data-scroll-target="#another-modeling-approach"><span class="header-section-number">7.13.6</span> Another Modeling Approach</a></li>
  </ul>
</li>
  <li>
<a href="#time-varying-covariates" id="toc-time-varying-covariates" class="nav-link" data-scroll-target="#time-varying-covariates"><span class="header-section-number">7.14</span> Time-varying covariates</a>
  <ul class="collapse">
<li><a href="#motivating-example-back-to-the-leukemia-dataset" id="toc-motivating-example-back-to-the-leukemia-dataset" class="nav-link" data-scroll-target="#motivating-example-back-to-the-leukemia-dataset"><span class="header-section-number">7.14.1</span> Motivating example: back to the leukemia dataset</a></li>
  <li><a href="#time-dependent-covariates" id="toc-time-dependent-covariates" class="nav-link" data-scroll-target="#time-dependent-covariates"><span class="header-section-number">7.14.2</span> Time-Dependent Covariates</a></li>
  <li><a href="#analysis-in-r" id="toc-analysis-in-r" class="nav-link" data-scroll-target="#analysis-in-r"><span class="header-section-number">7.14.3</span> Analysis in R</a></li>
  <li><a href="#event-sequences" id="toc-event-sequences" class="nav-link" data-scroll-target="#event-sequences"><span class="header-section-number">7.14.4</span> Event sequences</a></li>
  <li><a href="#model-with-time-fixed-covariates" id="toc-model-with-time-fixed-covariates" class="nav-link" data-scroll-target="#model-with-time-fixed-covariates"><span class="header-section-number">7.14.5</span> Model with Time-Fixed Covariates</a></li>
  <li><a href="#model-with-time-dependent-covariates" id="toc-model-with-time-dependent-covariates" class="nav-link" data-scroll-target="#model-with-time-dependent-covariates"><span class="header-section-number">7.14.6</span> Model with Time-Dependent Covariates</a></li>
  </ul>
</li>
  <li>
<a href="#recurrent-events" id="toc-recurrent-events" class="nav-link" data-scroll-target="#recurrent-events"><span class="header-section-number">7.15</span> Recurrent Events</a>
  <ul class="collapse">
<li><a href="#bladder-cancer-data-set" id="toc-bladder-cancer-data-set" class="nav-link" data-scroll-target="#bladder-cancer-data-set"><span class="header-section-number">7.15.1</span> Bladder Cancer Data Set</a></li>
  </ul>
</li>
  <li><a href="#age-as-the-time-scale" id="toc-age-as-the-time-scale" class="nav-link" data-scroll-target="#age-as-the-time-scale"><span class="header-section-number">7.16</span> Age as the time scale</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/d-morrison/rme/edit/main/proportional-hazards-models.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/d-morrison/rme/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li><li><a href="https://github.com/d-morrison/rme/blob/main/proportional-hazards-models.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./time-to-event-models.html">Time to Event Models</a></li><li class="breadcrumb-item"><a href="./proportional-hazards-models.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Proportional Hazards Models</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Proportional Hazards Models</span>
</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Last modified: 2025-09-01: 22:46:23 (PM)</p>
    </div>
  </div>
  
    
  </div>
  


</header><hr>
<!-- ::: {.content-hidden when-format="revealjs"} --><hr>
<section id="configuring-r" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="configuring-r">Configuring R</h3>
<p>Functions from these packages will be used throughout this document:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://conflicted.r-lib.org/">conflicted</a></span><span class="op">)</span> <span class="co"># check for conflicting function definitions</span></span>
<span><span class="co"># library(printr) # inserts help-file output into markdown output</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/rmarkdown">rmarkdown</a></span><span class="op">)</span> <span class="co"># Convert R Markdown documents into a variety of formats.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rapporter.github.io/pander/">pander</a></span><span class="op">)</span> <span class="co"># format tables for markdown</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span> <span class="co"># graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jonocarroll/ggeasy">ggeasy</a></span><span class="op">)</span> <span class="co"># help with graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sinhrks/ggfortify">ggfortify</a></span><span class="op">)</span> <span class="co"># help with graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span> <span class="co"># manipulate data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/">tibble</a></span><span class="op">)</span> <span class="co"># `tibble`s extend `data.frame`s</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span> <span class="co"># `%&gt;%` and other additional piping tools</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org">haven</a></span><span class="op">)</span> <span class="co"># import Stata files</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span> <span class="co"># format R output for markdown</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span> <span class="co"># Tools to help to create tidy data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://plotly-r.com">plotly</a></span><span class="op">)</span> <span class="co"># interactive graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">dobson</span><span class="op">)</span> <span class="co"># datasets from Dobson and Barnett 2018</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://easystats.github.io/parameters/">parameters</a></span><span class="op">)</span> <span class="co"># format model output tables for markdown</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org">haven</a></span><span class="op">)</span> <span class="co"># import Stata files</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stefanom.io/latex2exp/">latex2exp</a></span><span class="op">)</span> <span class="co"># use LaTeX in R code (for figures and tables)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org">fs</a></span><span class="op">)</span> <span class="co"># filesystem path manipulations</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span> <span class="co"># survival analysis</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/survminer/index.html">survminer</a></span><span class="op">)</span> <span class="co"># survival analysis graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jun-yan/KMsurv">KMsurv</a></span><span class="op">)</span> <span class="co"># datasets from Klein and Moeschberger</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://easystats.github.io/parameters/">parameters</a></span><span class="op">)</span> <span class="co"># format model output tables for</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/webshot2/">webshot2</a></span><span class="op">)</span> <span class="co"># convert interactive content to static for pdf</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://forcats.tidyverse.org/">forcats</a></span><span class="op">)</span> <span class="co"># functions for categorical variables ("factors")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org">stringr</a></span><span class="op">)</span> <span class="co"># functions for dealing with strings</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span> <span class="co"># functions for dealing with dates and times</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here are some R settings I use in this document:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># delete any data that's already loaded into R</span></span>
<span></span>
<span><span class="fu"><a href="https://conflicted.r-lib.org/reference/conflicts_prefer.html">conflicts_prefer</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">)</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op">(</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="co"># ggplot2::labs(col = "") +</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>      legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>      text <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, family <span class="op">=</span> <span class="st">"serif"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>message <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="st">'digits'</span> <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/panderOptions.html">panderOptions</a></span><span class="op">(</span><span class="st">"big.mark"</span>, <span class="st">","</span><span class="op">)</span></span>
<span><span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/panderOptions.html">panderOptions</a></span><span class="op">(</span><span class="st">"table.emphasize.rownames"</span>, <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/panderOptions.html">panderOptions</a></span><span class="op">(</span><span class="st">"table.split.table"</span>, <span class="cn">Inf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://conflicted.r-lib.org/reference/conflicts_prefer.html">conflicts_prefer</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">)</span> <span class="co"># use the `filter()` function from dplyr() by default</span></span>
<span><span class="va">legend_text_size</span> <span class="op">=</span> <span class="fl">9</span></span>
<span><span class="va">run_graphs</span> <span class="op">=</span> <span class="cn">TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!-- ::: -->
<!-- https://www.overleaf.com/learn/latex/Using_colors_in_LaTeX#Named_colors_provided_by_the_xcolor_package -->
<!-- \def\or{\theta}  -->
<!-- doesn't work for some reason -->
<style>
.quarto-figure-center > figure {
text-align: center;
}
</style></section><section id="introduction" class="level2" data-number="7.1"><h2 data-number="7.1" class="anchored" data-anchor-id="introduction">
<span class="header-section-number">7.1</span> Introduction</h2>
<!-- https://www.overleaf.com/learn/latex/Using_colors_in_LaTeX#Named_colors_provided_by_the_xcolor_package -->
<!-- \def\or{\theta}  -->
<!-- doesn't work for some reason -->
<div id="exr-review-exp-dist" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 7.1</strong></span> Recall the key characteristics of the exponential distribution:</p>
<ul>
<li>density function <span class="math inline">\(\text{f}(t)\)</span>
</li>
<li>survival function <span class="math inline">\(\text{S}(t)\)</span>
</li>
<li>hazard function <span class="math inline">\({\lambda}(t)\)</span>
</li>
</ul>
</div>
<hr>
<div id="sol-review-exp-dist" class="proof solution">
<p><span class="proof-title"><em>Solution 7.1</em>. </span><span class="math display">\[
\begin{aligned}
\text{p}(t) &amp;= \lambda e^{-\lambda t}\\
\text{S}(t) &amp;= e^{-\lambda t}\\
{\lambda}(t) &amp;= \lambda
\end{aligned}
\]</span></p>
<div class="notes">
<p>Note that the exponential distribution has <strong>constant hazard</strong>.</p>
</div>
</div>
</section><section id="understanding-proportional-hazards-models" class="level2" data-number="7.2"><h2 data-number="7.2" class="anchored" data-anchor-id="understanding-proportional-hazards-models">
<span class="header-section-number">7.2</span> Understanding proportional hazards models</h2>
<!-- https://www.overleaf.com/learn/latex/Using_colors_in_LaTeX#Named_colors_provided_by_the_xcolor_package -->
<!-- \def\or{\theta}  -->
<!-- doesn't work for some reason -->
<!-- {{< include _sec_cox-bio.qmd >}} -->
<hr>
<div class="notes">
<p>Let’s make two generalizations. First, we let the hazard depend on some covariates <span class="math inline">\(x_1,x_2, \dots, x_p\)</span>; we will indicate this dependence by extending our notation for hazard:</p>
</div>
<!-- https://www.overleaf.com/learn/latex/Using_colors_in_LaTeX#Named_colors_provided_by_the_xcolor_package -->
<!-- \def\or{\theta}  -->
<!-- doesn't work for some reason -->
<div id="def-cond-hazard" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 7.1 (conditional hazard)</strong></span> The <strong>conditional hazard</strong> of outcome <span class="math inline">\(T\)</span> at value <span class="math inline">\(t\)</span>, given covariate vector <span class="math inline">\(\tilde{x}\)</span>, is the conditional density of the event <span class="math inline">\(T=t\)</span>, given <span class="math inline">\(T \ge t\)</span> and <span class="math inline">\(\tilde{X}= \tilde{x}\)</span>:</p>
<p><span id="eq-def-cond-haz"><span class="math display">\[{\lambda}(t|\tilde{x}) \stackrel{\text{def}}{=}\text{p}(T=t|T\ge t, \tilde{X}= \tilde{x}) \tag{7.1}\]</span></span></p>
</div>
<hr>
<div id="def-base-hazard" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 7.2 (baseline hazard)</strong></span> &nbsp;</p>
<div class="notes">
<p>The <strong>baseline hazard</strong>, <strong>base hazard</strong>, or <strong>reference hazard</strong>, denoted <span class="math inline">\({\lambda}_0(t)\)</span> or <span class="math inline">\(\lambda_0(t)\)</span>, is the <a href="./intro-to-survival-analysis.html#def-hazard">hazard function</a> for the subpopulation of individuals whose covariates are all equal to their reference levels:</p>
</div>
<p><span id="eq-def-baseline-haz"><span class="math display">\[{\lambda}_0(t) \stackrel{\text{def}}{=}{\lambda}(t | \tilde{X}= \tilde{0}) \tag{7.2}\]</span></span></p>
</div>
<div class="notes">
<p>The baseline hazard is <em>somewhat</em> analogous to the intercept term in linear regression, but it is <strong>not</strong> a mean.</p>
</div>
<hr>
<div class="notes">
<p>Similarly:</p>
</div>
<div id="def-base-cuhaz" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 7.3 (baseline cumulative hazard)</strong></span> &nbsp;</p>
<div class="notes">
<p>The <strong>baseline cumulative hazard</strong>, <strong>base cumulative hazard</strong>, or <strong>reference cumulative hazard</strong>, denoted <span class="math inline">\(H_0(t)\)</span> or <span class="math inline">\(\Lambda_0(t)\)</span>, is the cumulative hazard function (<a href="intro-to-survival-analysis.html#def-cuhaz" class="quarto-xref">Definition&nbsp;<span>6.5</span></a>) for the subpopulation of individuals whose covariates are all equal to their reference levels:</p>
</div>
<p><span id="eq-def-baseline-cuhaz"><span class="math display">\[{\Lambda}_0(t) \stackrel{\text{def}}{=}{\Lambda}(t | \tilde{X}= \tilde{0}) \tag{7.3}\]</span></span></p>
</div>
<hr>
<div class="notes">
<p>Also:</p>
</div>
<div id="def-baseline-surv" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 7.4 (Baseline survival function)</strong></span> The <strong>baseline survival function</strong> is the survival function for an individual whose covariates are all equal to their default values.</p>
<p><span class="math display">\[\text{S}_0(t) \stackrel{\text{def}}{=}\text{S}(t | \tilde{X}= \tilde{0})\]</span></p>
</div>
<hr>
<div class="notes">
<p>Now, let’s define <strong><em>how</em></strong> the hazard function depends on covariates. We typically use a log link to model the relationship between the hazard function, <span class="math inline">\({\lambda}(t|\tilde{x})\)</span>, and the linear component, <span class="math inline">\(\eta(t|\tilde{x})\)</span>, as we did for Poisson models in <a href="count-regression.html" class="quarto-xref"><span>Chapter 4</span></a>; that is:</p>
</div>
<div id="def-loghaz" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 7.5 (log-hazard)</strong></span> &nbsp;</p>
<div class="notes">
<p>The <strong>log-hazard</strong> function, denoted <span class="math inline">\(\eta(t)\)</span>, is the natural logarithm of the hazard function:</p>
</div>
<p><span class="math display">\[\eta(t) \stackrel{\text{def}}{=}\text{log}{\left\{{\lambda}(t)\right\}}\]</span></p>
</div>
<hr>
<div id="def-cond-loghaz" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 7.6 (conditional log-hazard)</strong></span> &nbsp;</p>
<div class="notes">
<p>The <strong>conditional log-hazard</strong> function, denoted <span class="math inline">\(\eta(t|\tilde{x})\)</span>, is the natural logarithm of the conditional hazard function:</p>
</div>
<p><span class="math display">\[\eta(t | \tilde{x}) \stackrel{\text{def}}{=}\text{log}{\left\{{\lambda}(t | \tilde{x})\right\}}\]</span></p>
</div>
<div class="note">
<p>In contrast with Poisson regression, here <span class="math inline">\(\eta(t|\tilde{x})\)</span> depends on <strong>both</strong> <span class="math inline">\(t\)</span> <strong>and</strong> <span class="math inline">\(\tilde{x}\)</span>.</p>
</div>
<hr>
<div id="def-base-loghaz" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 7.7 (baseline log-hazard)</strong></span> &nbsp;</p>
<div class="notes">
<p>The <strong>baseline log-hazard</strong>, denoted <span class="math inline">\(\eta_0(t)\)</span>, log-hazard function for the subpopulation of individuals whose covariates are all equal to their reference levels:</p>
</div>
<p><span class="math display">\[\eta_0(t) \stackrel{\text{def}}{=}\eta(t | \tilde{X}= \tilde{0})\]</span></p>
</div>
<hr>
<div id="thm-haz-from-loghaz" class="theorem">
<p><span class="theorem-title"><strong>Theorem 7.1</strong></span> <span class="math display">\[
\begin{aligned}
{\lambda}(t|\tilde{x}) &amp;= \text{exp}{\left\{\eta(t|\tilde{x})\right\}}
\end{aligned}
\]</span></p>
</div>
<hr>
<div id="def-diffloghaz" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 7.8 (difference in log-hazards)</strong></span> The <strong>difference in log-hazards</strong> between covariate patterns <span class="math inline">\(\tilde{x}\)</span> and <span class="math inline">\({\tilde{x}^*}\)</span> at time <span class="math inline">\(t\)</span> is:</p>
<p><span class="math display">\[\Delta \eta(t|\tilde{x}: {\tilde{x}^*}) \stackrel{\text{def}}{=}\eta(t|\tilde{x}) - \eta(t|{\tilde{x}^*})\]</span></p>
</div>
<hr>
<div id="thm-diff-loghaz" class="theorem">
<p><span class="theorem-title"><strong>Theorem 7.2 (Difference of log-hazards vs hazard ratio)</strong></span> If <span class="math inline">\(\Delta \eta(t|\tilde{x}: {\tilde{x}^*})\)</span> is the difference in log-hazard between covariate patterns <span class="math inline">\(\tilde{x}\)</span> and <span class="math inline">\({\tilde{x}^*}\)</span> at time <span class="math inline">\(t\)</span>, and <span class="math inline">\(\theta(t| \tilde{x}: {\tilde{x}^*})\)</span> is corresponding hazard ratio, then:</p>
<p><span class="math display">\[\Delta \eta(t|\tilde{x}: {\tilde{x}^*})= \text{log}{\left\{\theta(t| \tilde{x}: {\tilde{x}^*})\right\}}\]</span></p>
</div>
<hr>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span>Using <a href="intro-to-survival-analysis.html#def-hazard-ratio" class="quarto-xref">Definition&nbsp;<span>6.4</span></a>:</p>
<p><span class="math display">\[
\begin{aligned}
\Delta \eta(t|\tilde{x}: {\tilde{x}^*})
&amp;\stackrel{\text{def}}{=}\eta(t|\tilde{x}) - \eta(t|{\tilde{x}^*})
\\
&amp;= \text{log}{\left\{{\lambda}(t|\tilde{x})\right\}} - \text{log}{\left\{{\lambda}(t|{\tilde{x}^*})\right\}}
\\
&amp;= \text{log}{\left\{\frac{{\lambda}(t|\tilde{x})}{{\lambda}(t|{\tilde{x}^*})}\right\}}
\\
&amp;= \text{log}{\left\{\theta(t| \tilde{x}: {\tilde{x}^*})\right\}}
\end{aligned}
\]</span></p>
</div>
<hr>
<div id="cor-hazard-ratio-diffloghaz" class="theorem corollary">
<p><span class="theorem-title"><strong>Corollary 7.1 (Hazard ratio vs difference of log-odds)</strong></span> <span class="math display">\[\theta(t| \tilde{x}: {\tilde{x}^*}) = \text{exp}{\left\{\Delta \eta(t|\tilde{x}: {\tilde{x}^*})\right\}}\]</span></p>
</div>
<hr>
<div id="def-difflog-hazard-from-baseline" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 7.9 (difference in log-hazard from baseline)</strong></span> &nbsp;</p>
<div class="notes">
<p>The difference in log-hazard for covariate pattern <span class="math inline">\(\tilde{x}\)</span> compared to the baseline covariate pattern <span class="math inline">\(\tilde{0}\)</span> is:</p>
</div>
<p><span class="math display">\[
\begin{aligned}
\Delta \eta(t|\tilde{x})
&amp;\stackrel{\text{def}}{=}\Delta \eta(t | \tilde{x}: \tilde{0})
\end{aligned}
\]</span></p>
</div>
<hr>
<div id="thm-loghaz-decomp" class="theorem">
<p><span class="theorem-title"><strong>Theorem 7.3 (Decomposition of log-hazard)</strong></span> <span class="math display">\[
\begin{aligned}
\eta(t|\tilde{x}) = \eta_0(t) + \Delta \eta(t|\tilde{x})
\end{aligned}
\]</span></p>
</div>
<hr>
<div id="def-hr-vs-baseline" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 7.10 (Hazard ratio versus baseline)</strong></span> <span id="eq-def-hr-vs-0"><span class="math display">\[\theta(t|\tilde{x}) \stackrel{\text{def}}{=}\theta(t| \tilde{x}: \tilde{0}) \tag{7.4}\]</span></span></p>
</div>
<hr>
<div id="cor-hazard-ratio-vs-baseline" class="theorem corollary">
<p><span class="theorem-title"><strong>Corollary 7.2</strong></span> <span class="math display">\[\theta(t|\tilde{x})= \text{exp}{\left\{\Delta \eta(t|\tilde{x})\right\}}\]</span></p>
</div>
<hr>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><span class="math display">\[
\begin{aligned}
\theta(t|\tilde{x})
&amp;\stackrel{\text{def}}{=}\theta(t| \tilde{x}: \tilde{0})
\\
&amp;= \text{exp}{\left\{\Delta \eta(t|\tilde{x})\right\}}
\end{aligned}
\]</span></p>
</div>
<hr>
<div id="cor-difflogodds-log-HR" class="theorem corollary">
<p><span class="theorem-title"><strong>Corollary 7.3</strong></span> <span class="math display">\[\Delta \eta(t|\tilde{x}) = \text{log}{\left\{\theta(t| \tilde{x})\right\}}\]</span></p>
</div>
<hr>
<div class="notes">
<p>As the second generalization, we let the base hazard, cumulative hazard, and survival functions depend on <span class="math inline">\(t\)</span>, but not on any covariates (for now). We can do this using either parametric or semi-parametric approaches.</p>
</div>
<div id="def-ph-model" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 7.11 (Proportional hazards model)</strong></span> A <strong>proportional hazards</strong> model for a time-to-event outcome <span class="math inline">\(T\)</span> is a model where the difference in log-hazard from the baseline log-hazard is equal to a linear combination of the predictors:</p>
<p><span id="eq-ph-diffloghaz"><span class="math display">\[\Delta \eta(t|\tilde{x}) = \tilde{x}\cdot \tilde{\beta} \tag{7.5}\]</span></span></p>
</div>
<hr>
<p>Equivalently:</p>
<div id="lem-ph-lincomp" class="theorem lemma">
<p><span class="theorem-title"><strong>Lemma 7.1</strong></span> In a proportional hazards model (that is, if <a href="#eq-ph-diffloghaz" class="quarto-xref">Equation&nbsp;<span>7.5</span></a> holds):</p>
<p><span id="eq-ph-lincomp"><span class="math display">\[
\begin{aligned}
\eta(t|\tilde{x}) &amp;= \eta_0(t) + \tilde{x}\cdot \tilde{\beta}
\\
&amp;= \eta_0(t) + \beta_1 x_1+ \dots + \beta_p x_p
\end{aligned}
\tag{7.6}\]</span></span></p>
</div>
<div class="notes">
<p>In a proportional hazards model, the baseline log-hazard is analogous to the intercept term in a generalized linear model, except that the baseline log-hazard depends on time, <span class="math inline">\(t\)</span>.</p>
</div>
<hr>
<div id="lem-diffloghaz-ph" class="theorem lemma">
<p><span class="theorem-title"><strong>Lemma 7.2</strong></span> If <span class="math inline">\(\eta(t|\tilde{x}) = \eta_0(t) + \tilde{x}\cdot \tilde{\beta}\)</span>, then:</p>
<p><span class="math display">\[
\begin{aligned}
\Delta \eta(t|\tilde{x}: {\tilde{x}^*})
&amp;= (\tilde{x}- {\tilde{x}^*}) \cdot \beta
\end{aligned}
\]</span></p>
</div>
<hr>
<div id="thm-hazard-ratio-ph" class="theorem">
<p><span class="theorem-title"><strong>Theorem 7.4</strong></span> If <span class="math inline">\(\eta(t|\tilde{x}) = \eta_0(t) + \tilde{x}\cdot \tilde{\beta}\)</span>, then:</p>
<p><span class="math display">\[
\begin{aligned}
\theta(t|\tilde{x}: {\tilde{x}^*})
&amp;= \text{exp}{\left\{\Delta \eta(t|\tilde{x}: {\tilde{x}^*})\right\}}
\\
&amp;= \text{exp}{\left\{(\tilde{x}- {\tilde{x}^*}) \cdot \beta\right\}}
\end{aligned}
\]</span></p>
</div>
<p>So for proportional hazards models, we can write the hazard ratio using a shorthand notation:</p>
<p><span class="math display">\[\theta(t| \tilde{x}: {\tilde{x}^*})  = \theta(\tilde{x}: {\tilde{x}^*})\]</span></p>
<hr>
<div id="lem-ph-diffloghaz-0" class="theorem lemma">
<p><span class="theorem-title"><strong>Lemma 7.3</strong></span> <span id="eq-diffloghaz-0-ph"><span class="math display">\[\Delta \eta(t|\tilde{x})= \tilde{x}\cdot \tilde{\beta} \tag{7.7}\]</span></span></p>
</div>
<hr>
<div id="thm-hazard-ratio-vs-baseline-ph" class="theorem">
<p><span class="theorem-title"><strong>Theorem 7.5</strong></span> If <span class="math inline">\(\eta(t|\tilde{x}) = \eta_0(t) + \tilde{x}\cdot \tilde{\beta}\)</span>, then:</p>
<p><span class="math display">\[\theta(t|\tilde{x}) = \text{exp}{\left\{\tilde{x}\cdot \tilde{\beta}\right\}}\]</span></p>
</div>
<hr>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><span class="math display">\[
\begin{aligned}
\theta(t|\tilde{x})
&amp;\stackrel{\text{def}}{=}\theta(t| \tilde{x}: \tilde{0})
\\
&amp;= \text{exp}{\left\{\Delta \eta(t|\tilde{x})\right\}}
\\
&amp;= \text{exp}{\left\{\tilde{x}\cdot \tilde{\beta}\right\}}
\end{aligned}
\]</span></p>
</div>
<hr>
<div id="thm-ph-haz-decomp" class="theorem">
<p><span class="theorem-title"><strong>Theorem 7.6</strong></span> <span class="math display">\[{\lambda}(t|x) = {\lambda}_0(t)\theta(x)\]</span></p>
</div>
<hr>
<p>Also:</p>
<div id="thm-ph-also" class="theorem">
<p><span class="theorem-title"><strong>Theorem 7.7</strong></span> <span class="math display">\[
\begin{aligned}
\theta(x) &amp;= \text{exp}{\left\{\Delta \eta(x)\right\}}
\\
\log{{\lambda}(t|x)}
&amp;= \log{{\lambda}_0(t)} + \Delta \eta(x)
\\
&amp;= \eta_0(t) + \Delta \eta(x)
\\
\Delta \eta(x) &amp;= \tilde{x}\cdot \tilde{\beta}\\
&amp;\stackrel{\text{def}}{=}\beta_1x_1+\cdots+\beta_px_p
\end{aligned}
\]</span></p>
</div>
<div class="notes">
<p>This model is <strong>semi-parametric</strong>, because the linear predictor depends on estimated parameters but the base hazard function is unspecified. There is no constant term in <span class="math inline">\(\eta(x)\)</span>, because it is absorbed in the base hazard.</p>
</div>
<hr>
<p>Alternatively, we could define <span class="math inline">\(\beta_0(t) = \log{{\lambda}_0(t)}\)</span>, and then:</p>
<p><span class="math display">\[\eta(x,t) = \beta_0(t) + \beta_1x_1+\cdots+\beta_px_p\]</span></p>
<hr>
<div class="notes">
<p>For two different individuals with covariate patterns <span class="math inline">\(\tilde{x}_1\)</span> and <span class="math inline">\(\tilde{x}_2\)</span>, the ratio of the hazard functions (a.k.a. <strong>hazard ratio</strong>, a.k.a. <strong>relative hazard</strong>) is:</p>
</div>
<p><span class="math display">\[
\begin{aligned}
\frac{{\lambda}(t|\tilde{x}_1)}{{\lambda}(t|\tilde{x}_2)}
&amp;=\frac{{\lambda}_0(t)\theta(\tilde{x}_1)}{{\lambda}_0(t)\theta(\tilde{x}_2)}\\
&amp;=\frac{\theta(\tilde{x}_1)}{\theta(\tilde{x}_2)}\\
\end{aligned}
\]</span></p>
<div class="notes">
<p>Under the proportional hazards model, this ratio (a.k.a. proportion) does not depend on <span class="math inline">\(t\)</span>. This property is a structural limitation of the model; it is called the <strong>proportional hazards assumption</strong>.</p>
</div>
<hr>
<div id="def-pha" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 7.12 (proportional hazards)</strong></span> A conditional probability distribution <span class="math inline">\(p(T|X)\)</span> has <strong>proportional hazards</strong> if the hazard ratio <span class="math inline">\({\lambda}(t|\tilde{x}_1)/{\lambda}(t|\tilde{x}_2)\)</span> does not depend on <span class="math inline">\(t\)</span>. Mathematically, it can be written as:</p>
<p><span class="math display">\[
\frac{{\lambda}(t|\tilde{x}_1)}{{\lambda}(t|\tilde{x}_2)}
= \theta(\tilde{x}_1,\tilde{x}_2)
\]</span></p>
</div>
<div class="notes">
<p>As we saw above, Cox’s proportional hazards model has this property, with <span class="math inline">\(\theta(\tilde{x}_1,\tilde{x}_2) = \frac{\theta(\tilde{x}_1)}{\theta(\tilde{x}_2)}\)</span>.</p>
</div>
<hr>
<div id="thm-haz-ratio-notations" class="theorem">
<p><span class="theorem-title"><strong>Theorem 7.8</strong></span> &nbsp;</p>
<div class="notes">
<p>We are using two similar notations, <span class="math inline">\(\theta(\tilde{x},{\tilde{x}^*})\)</span> and <span class="math inline">\(\theta(\tilde{x})\)</span>. We can link these notations: <span class="math display">\[\theta(\tilde{x}) \stackrel{\text{def}}{=}\theta(\tilde{x}, \tilde{0})\]</span></p>
<p>Then:</p>
</div>
<p><span class="math display">\[\theta(\tilde{x}, {\tilde{x}^*}) = \frac{\theta(\tilde{x})}{\theta({\tilde{x}^*})}\]</span> <span class="math display">\[\theta(\tilde{0}) = \theta(\tilde{0}, \tilde{0}) = 1\]</span></p>
</div>
<hr>
<p>The proportional hazards model also has additional notable properties:</p>
<p><span class="math display">\[
\begin{aligned}
\frac{{\lambda}(t|\tilde{x}_1)}{{\lambda}(t|\tilde{x}_2)}
&amp;=\frac{\theta(\tilde{x}_1)}{\theta(\tilde{x}_2)}\\
&amp;=\frac{\text{exp}{\left\{\eta(\tilde{x}_1)\right\}}}{\text{exp}{\left\{\eta(\tilde{x}_2)\right\}}}\\
&amp;=\text{exp}{\left\{\eta(\tilde{x}_1)-\eta(\tilde{x}_2)\right\}}\\
&amp;=\text{exp}{\left\{\tilde{x}_1'\beta-\tilde{x}_2'\beta\right\}}\\
&amp;=\text{exp}{\left\{(\tilde{x}_1 - \tilde{x}_2)'\beta\right\}}\\
\end{aligned}
\]</span></p>
<hr>
<p>Hence on the log scale, we have:</p>
<div id="thm-diff-loghaz-lincom" class="theorem">
<p><span class="theorem-title"><strong>Theorem 7.9</strong></span> <span class="math display">\[
\begin{aligned}
\log{\frac{{\lambda}(t|\tilde{x})}{{\lambda}(t|{\tilde{x}^*})}}
&amp;= \Delta \eta(t|\tilde{x}: {\tilde{x}^*})
\\
&amp;\stackrel{\text{def}}{=}\eta(t|\tilde{x}) - \eta(t|{\tilde{x}^*})
\\
&amp;=\eta(\tilde{x}_1)-\eta(\tilde{x}_2)\\
&amp;= \tilde{x}_1'\beta-\tilde{x}_2'\beta\\
&amp;= (\tilde{x}_1 - \tilde{x}_2)'\beta
\end{aligned}
\]</span></p>
</div>
<hr>
<p>If only one covariate <span class="math inline">\(x_j\)</span> is changing, then:</p>
<p><span class="math display">\[
\begin{aligned}
\log{\frac{{\lambda}(t|\tilde{x}_1)}{{\lambda}(t|\tilde{x}_2)}}
&amp;=  (x_{1j} - x_{2j}) \cdot \beta_j\\
&amp;\propto (x_{1j} - x_{2j})
\end{aligned}
\]</span></p>
<div class="notes">
<p>That is, under Cox’s model <span class="math inline">\({\lambda}(t|\tilde{x}) = {\lambda}_0(t)\text{exp}{\left\{\tilde{x}'\beta\right\}}\)</span>, the log of the hazard ratio is proportional to the difference in <span class="math inline">\(x_j\)</span>, with the proportionality coefficient equal to <span class="math inline">\(\beta_j\)</span>.</p>
</div>
<hr>
<p>Further,</p>
<p><span class="math display">\[
\begin{aligned}
\log{{\lambda}(t|\tilde{x})}
&amp;=\log{{\lambda}_0(t)}  + x'\beta
\end{aligned}
\]</span></p>
<div class="notes">
<p>That is, the covariate effects are additive on the log-hazard scale; hazard functions for different covariate patterns should be vertical shifts of each other.</p>
<p>See also:</p>
<p><a href="https://en.wikipedia.org/wiki/Proportional_hazards_model#Why_it_is_called_%22proportional%22" class="uri">https://en.wikipedia.org/wiki/Proportional_hazards_model#Why_it_is_called_%22proportional%22</a></p>
</div>
<section id="additional-properties-of-the-proportional-hazards-model" class="level3" data-number="7.2.1"><h3 data-number="7.2.1" class="anchored" data-anchor-id="additional-properties-of-the-proportional-hazards-model">
<span class="header-section-number">7.2.1</span> Additional properties of the proportional hazards model</h3>
<p>If <span class="math inline">\({\lambda}(t|x)= {\lambda}_0(t)\theta(x)\)</span>, then:</p>
<div id="thm-ph-cuhaz" class="theorem">
<p><span class="theorem-title"><strong>Theorem 7.10 (Cumulative hazards are also proportional to <span class="math inline">\({\Lambda}_0(t)\)</span>)</strong></span> <span class="math display">\[
\begin{aligned}
{\Lambda}(t|x)
&amp;\stackrel{\text{def}}{=}\int_{u=0}^t {\lambda}(u)du\\
&amp;= \int_{u=0}^t {\lambda}_0(u)\theta(x)du\\
&amp;= \theta(x)\int_{u=0}^t {\lambda}_0(u)du\\
&amp;= \theta(x){\Lambda}_0(t)
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\({\Lambda}_0(t) \stackrel{\text{def}}{=}{\Lambda}(t|0) = \int_{u=0}^t {\lambda}_0(u)du\)</span>.</p>
</div>
<hr>
<div id="thm-log-cuhaz-parallel" class="theorem">
<p><span class="theorem-title"><strong>Theorem 7.11 (The logarithms of cumulative hazard should be parallel)</strong></span> <span class="math display">\[
\text{log}{\left\{{\Lambda}(t|\tilde{x})\right\}} =\text{log}{\left\{{\Lambda}_0(t)\right\}}  + \tilde{x}\cdot \tilde{\beta}
\]</span></p>
</div>
<hr>
<div id="cor-log-nlog-surv" class="theorem corollary">
<p><span class="theorem-title"><strong>Corollary 7.4 (linear model for log-negative-log survival)</strong></span> <span class="math display">\[
\text{log}{\left\{-\text{log}{\left\{\text{S}(t|\tilde{x})\right\}}\right\}} =
\text{log}{\left\{-\text{log}{\left\{\text{S}_0(t)\right\}}\right\}}  + \tilde{x}\cdot \tilde{\beta}
\]</span></p>
</div>
<hr>
<div id="thm-ph-surv" class="theorem">
<p><span class="theorem-title"><strong>Theorem 7.12 (Survival functions are exponential multiples of <span class="math inline">\(\text{S}_0(t)\)</span>)</strong></span> <span class="math display">\[\text{S}(t|x) = {\left[\text{S}_0(t)\right]}^{\theta(x)}\]</span></p>
</div>
<hr>
<div class="proof">
<p><span class="proof-title"><em>Proof</em>. </span><span class="math display">\[
\begin{aligned}
\text{S}(t|x)
&amp;= \text{exp}{\left\{-{\Lambda}(t|x)\right\}}\\
&amp;= \text{exp}{\left\{-\theta(x)\cdot {\Lambda}_0(t)\right\}}\\
&amp;= {\left(\text{exp}{\left\{- {\Lambda}_0(t)\right\}}\right)}^{\theta(x)}\\
&amp;= {\left[\text{S}_0(t)\right]}^{\theta(x)}\\
\end{aligned}
\]</span></p>
</div>
</section><section id="summary-of-proportional-hazards-model-structure-and-assumptions" class="level3" data-number="7.2.2"><h3 data-number="7.2.2" class="anchored" data-anchor-id="summary-of-proportional-hazards-model-structure-and-assumptions">
<span class="header-section-number">7.2.2</span> Summary of proportional hazards model structure and assumptions</h3>
<!-- https://www.overleaf.com/learn/latex/Using_colors_in_LaTeX#Named_colors_provided_by_the_xcolor_package -->
<!-- \def\or{\theta}  -->
<!-- doesn't work for some reason -->
<p><strong>Joint likelihood of data set</strong>: <span class="math inline">\(\mathscr{L}\stackrel{\text{def}}{=}\text{p}(\tilde{Y}= \tilde{y}, \tilde{D}= \tilde{d}| \mathbf{X}= \mathbf{x})\)</span></p>
<p><strong>Marginal likelihood contribution of obs. <em>i</em> </strong>: <span class="math inline">\(\mathscr{L}_i \stackrel{\text{def}}{=}\text{p}(Y_i= y_i, D_i = d_i | \tilde{X}_i = \tilde{x}_i)\)</span></p>
<p><em>Independent Observations Assumption:</em> <span class="math inline">\(\mathscr{L}= \prod_{i=1}^n \mathscr{L}_i\)</span></p>
<p><em>Non-Informative Censoring Assumption:</em> <span class="math inline">\(T_i\perp\!\!\!\perp C_i | \tilde{X}_i\)</span></p>
<p><span class="math display">\[
\mathscr{L}_i \propto [\text{f}_T(y_i|\tilde{x}_i)]^{d_i} [\text{S}_T(y_i | \tilde{x}_i)]^{1-d_i}
= \text{S}_T(y_i|\tilde{x}_i) \cdot [{\lambda}_T(y_i|\tilde{x}_i)]^{d_i}
\]</span></p>
<p><strong>Survival function</strong>: <span class="math inline">\(\text{S}(t | \tilde{x}) \stackrel{\text{def}}{=}\text{P}(T &gt; t|\tilde{X}= \tilde{x}) = \int_{u=t}^{\infty} \text{f}(u|\tilde{x})du = \text{exp}{\left\{-{\Lambda}(t|\tilde{x})\right\}}\)</span></p>
<p><strong>Probability density function</strong>: <span class="math inline">\(\text{f}(t| \tilde{x}) \stackrel{\text{def}}{=}\text{p}(T=t|\tilde{X}= \tilde{x}) = -\text{S}'(t|\tilde{x}) = {\lambda}(t| \tilde{x}) \text{S}(t | \tilde{x})\)</span></p>
<p><strong>Cumulative hazard function</strong>: <span class="math inline">\({\Lambda}(t | \tilde{x}) \stackrel{\text{def}}{=}\int_{u=0}^t {\lambda}(u|\tilde{x})du = -\text{log}{\left\{\text{S}(t|\tilde{x})\right\}}\)</span></p>
<p><strong>Hazard function</strong>: <span class="math inline">\({\lambda}(t |\tilde{x}) \stackrel{\text{def}}{=}\text{p}(T=t|T\ge t,\tilde{X}= \tilde{x}) = {\Lambda}'(t|\tilde{x}) = \frac{\text{f}(t|\tilde{x})}{\text{S}(t|\tilde{x})}\)</span></p>
<p><strong>Hazard ratio</strong>: <span class="math inline">\(\theta(t| \tilde{x}: {\tilde{x}^*}) \stackrel{\text{def}}{=}\frac{{\lambda}(t|\tilde{x})}{{\lambda}(t|{\tilde{x}^*})}\)</span></p>
<p><strong>Log-Hazard function</strong>: <span class="math inline">\(\eta(t|\tilde{x}) \stackrel{\text{def}}{=}\text{log}{\left\{\lambda(t|\tilde{x})\right\}} = \eta_0(t) + \Delta \eta(t|\tilde{x})\)</span></p>
<p><em>Proportional Hazards Assumption:</em></p>
<p><span class="math display">\[
\begin{aligned}
{\lambda}(t |\tilde{x}) &amp;= {\lambda}_0(t) \cdot \theta(\tilde{x})
\\
{\Lambda}(t |\tilde{x}) &amp;= {\Lambda}_0(t) \cdot \theta(\tilde{x})
\\
\eta(t|\tilde{x}) &amp;= \eta_0(t) + \Delta \eta(\tilde{x})
\end{aligned}
\]</span></p>
<p><em>Logarithmic Link Function Assumption:</em></p>
<ul>
<li><p><strong>Link function</strong>: <span class="math display">\[\text{log}{\left\{{\lambda}(t|\tilde{x})\right\}} = \eta(t|\tilde{x})\]</span> <span class="math display">\[\text{log}{\left\{\theta(\tilde{x})\right\}} = \Delta \eta(\tilde{x})\]</span></p></li>
<li><p><strong>Inverse link function</strong>: <span class="math display">\[{\lambda}(t|\tilde{x}) = \text{exp}{\left\{\eta(t|\tilde{x})\right\}}\]</span> <span class="math display">\[\theta(\tilde{x}) = \text{exp}{\left\{\Delta \eta(\tilde{x})\right\}}\]</span></p></li>
</ul>
<p><strong>Linear Predictor Component</strong>:</p>
<p><span class="math display">\[\eta(t|\tilde{x}) = \eta_0(t) + \Delta \eta(t|\tilde{x})\]</span> <span class="math display">\[\Delta \eta(t|\tilde{x}) = \tilde{x}\cdot \tilde{\beta}\]</span></p>
<p><em>Linear Predictor Component Functional Form Assumption:</em></p>
<p><span class="math display">\[\Delta \eta(t|\tilde{x}) = \tilde{x}\cdot \tilde{\beta}\stackrel{\text{def}}{=}\beta_1 x_1 + \cdots + \beta_p x_p\]</span></p>
</section></section><section id="testing-the-proportional-hazards-assumption" class="level2" data-number="7.3"><h2 data-number="7.3" class="anchored" data-anchor-id="testing-the-proportional-hazards-assumption">
<span class="header-section-number">7.3</span> Testing the proportional hazards assumption</h2>
<div class="notes">
<p>The Nelson-Aalen estimate of the cumulative hazard is usually used for estimates of the hazard and often the cumulative hazard.</p>
<p>If the hazards of the three groups are proportional, that means that the ratio of the hazards is constant over <span class="math inline">\(t\)</span>. We can test this using the ratios of the estimated cumulative hazards, which also would be proportional, as shown above.</p>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jun-yan/KMsurv">KMsurv</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmt</span> <span class="op">=</span></span>
<span>  <span class="va">bmt</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    group <span class="op">=</span></span>
<span>      <span class="va">group</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ALL"</span>,<span class="st">"Low Risk AML"</span>,<span class="st">"High Risk AML"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nafit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>,<span class="va">d3</span><span class="op">)</span> <span class="op">~</span> <span class="va">group</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"fleming-harrington"</span>,</span>
<span>  data <span class="op">=</span> <span class="va">bmt</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmt_curves</span> <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>timevec <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">sf1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">nafit</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/stats/stepfun.html">stepfun</a></span><span class="op">(</span><span class="va">time</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">surv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sf2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">nafit</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/stats/stepfun.html">stepfun</a></span><span class="op">(</span><span class="va">time</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">surv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sf3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">nafit</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/stats/stepfun.html">stepfun</a></span><span class="op">(</span><span class="va">time</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">surv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmt_curves</span> <span class="op">=</span></span>
<span>  <span class="va">bmt_curves</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    cumhaz1 <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu">sf1</span><span class="op">(</span><span class="va">timevec</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    cumhaz2 <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu">sf2</span><span class="op">(</span><span class="va">timevec</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    cumhaz3 <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu">sf3</span><span class="op">(</span><span class="va">timevec</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">bmt_rel_hazard_plot</span> <span class="op">=</span></span>
<span>  <span class="va">bmt_curves</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">timevec</span>,</span>
<span>      y <span class="op">=</span> <span class="va">cumhaz1</span><span class="op">/</span><span class="va">cumhaz2</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"ALL/Low Risk AML"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Hazard Ratio"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">cumhaz3</span><span class="op">/</span><span class="va">cumhaz1</span>, col <span class="op">=</span> <span class="st">"High Risk AML/ALL"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">cumhaz3</span><span class="op">/</span><span class="va">cumhaz2</span>, col <span class="op">=</span> <span class="st">"High Risk AML/Low Risk AML"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"Comparison"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">bmt_rel_hazard_plot</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-HR-bmt" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-HR-bmt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.1: Hazard Ratios by Disease Group for <code>bmt</code> data
</figcaption><div aria-describedby="fig-HR-bmt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="proportional-hazards-models_files/figure-html/fig-HR-bmt-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;7.1: Hazard Ratios by Disease Group for bmt data"><img src="proportional-hazards-models_files/figure-html/fig-HR-bmt-1.png" class="img-fluid figure-img" width="672"></a>
</div>
</figure>
</div>
</div>
</div>
<hr>
<p>We can zoom in on the first 300 days to take a closer look:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt_rel_hazard_plot</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">300</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-HR-bmt-inset" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-HR-bmt-inset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.2: Hazard Ratios by Disease Group (0-300 Days)
</figcaption><div aria-describedby="fig-HR-bmt-inset-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="proportional-hazards-models_files/figure-html/fig-HR-bmt-inset-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;7.2: Hazard Ratios by Disease Group (0-300 Days)"><img src="proportional-hazards-models_files/figure-html/fig-HR-bmt-inset-1.png" class="img-fluid figure-img" width="672"></a>
</div>
</figure>
</div>
</div>
</div>
<hr>
<p>The cumulative hazard curves should also be proportional</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sinhrks/ggfortify">ggfortify</a></span><span class="op">)</span></span>
<span><span class="va">plot_cuhaz_bmt</span> <span class="op">=</span></span>
<span>  <span class="va">bmt</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">d3</span><span class="op">)</span> <span class="op">~</span> <span class="va">group</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="st">"cumhaz"</span>,</span>
<span>           mark.time <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Cumulative hazard"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_cuhaz_bmt</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cuhaz-bmt" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-cuhaz-bmt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.3: Disease-Free Cumulative Hazard by Disease Group
</figcaption><div aria-describedby="fig-cuhaz-bmt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="proportional-hazards-models_files/figure-html/fig-cuhaz-bmt-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;7.3: Disease-Free Cumulative Hazard by Disease Group"><img src="proportional-hazards-models_files/figure-html/fig-cuhaz-bmt-1.png" class="img-fluid figure-img" width="672"></a>
</div>
</figure>
</div>
</div>
</div>
<hr>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_cuhaz_bmt</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cuhaz-bmt-loglog" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-cuhaz-bmt-loglog-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.4: Disease-Free Cumulative Hazard by Disease Group (log-scale)
</figcaption><div aria-describedby="fig-cuhaz-bmt-loglog-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="proportional-hazards-models_files/figure-html/fig-cuhaz-bmt-loglog-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure&nbsp;7.4: Disease-Free Cumulative Hazard by Disease Group (log-scale)"><img src="proportional-hazards-models_files/figure-html/fig-cuhaz-bmt-loglog-1.png" class="img-fluid figure-img" width="672"></a>
</div>
</figure>
</div>
</div>
</div>
<section id="smoothed-hazard-functions" class="level3" data-number="7.3.1"><h3 data-number="7.3.1" class="anchored" data-anchor-id="smoothed-hazard-functions">
<span class="header-section-number">7.3.1</span> Smoothed hazard functions</h3>
<div class="notes">
<p>The Nelson-Aalen estimate of the cumulative hazard is usually used for estimates of the hazard. Since the hazard is the derivative of the cumulative hazard, we need a smooth estimate of the cumulative hazard, which is provided by smoothing the step-function cumulative hazard.</p>
<p>The R package <code>muhaz</code> handles this for us. What we are looking for is whether the hazard function is more or less the same shape, increasing, decreasing, constant, etc. Are the hazards “proportional”?</p>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">muhaz</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/muhaz/man/muhaz.html">muhaz</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">t2</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">d3</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">==</span><span class="st">"High Risk AML"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">2</span>,col<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/muhaz/man/muhaz.html">muhaz</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">t2</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">d3</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">==</span><span class="st">"ALL"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">2</span>,col<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/muhaz/man/muhaz.html">muhaz</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">t2</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">d3</span>,<span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">==</span><span class="st">"Low Risk AML"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">2</span>,col<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topright"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ALL"</span>,<span class="st">"Low Risk AML"</span>,<span class="st">"High Risk AML"</span><span class="op">)</span>,col<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-smoothed-hazard-bmt" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-smoothed-hazard-bmt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.5: Smoothed Hazard Rate Estimates by Disease Group
</figcaption><div aria-describedby="fig-smoothed-hazard-bmt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="proportional-hazards-models_files/figure-html/fig-smoothed-hazard-bmt-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure&nbsp;7.5: Smoothed Hazard Rate Estimates by Disease Group"><img src="proportional-hazards-models_files/figure-html/fig-smoothed-hazard-bmt-1.png" class="img-fluid figure-img" width="672"></a>
</div>
</figure>
</div>
</div>
</div>
<div class="notes">
<p>Group 3 was plotted first because it has the highest hazard.</p>
<p>Except for an initial blip in the high risk AML group, the hazards look roughly proportional. They are all strongly decreasing.</p>
</div>
</section></section><section id="fitting-proportional-hazards-models-to-data" class="level2" data-number="7.4"><h2 data-number="7.4" class="anchored" data-anchor-id="fitting-proportional-hazards-models-to-data">
<span class="header-section-number">7.4</span> Fitting proportional hazards models to data</h2>
<!-- https://www.overleaf.com/learn/latex/Using_colors_in_LaTeX#Named_colors_provided_by_the_xcolor_package -->
<!-- \def\or{\theta}  -->
<!-- doesn't work for some reason -->
<hr>
<div class="notes">
<p>How do we fit a proportional hazards regression model? We need to estimate the coefficients of the covariates, and we need to estimate the base hazard <span class="math inline">\({\lambda}_0(t)\)</span>. For the covariates, supposing for simplicity that there are no tied event times, let the event times for the whole data set be <span class="math inline">\(t_1, t_2,\ldots,t_D\)</span>. Let the risk set at time <span class="math inline">\(t_i\)</span> be <span class="math inline">\(R(t_i)\)</span> and</p>
</div>
<p><span class="math display">\[
\begin{aligned}
\eta(\tilde{x}) &amp;= \beta_1x_{1}+\cdots+\beta_p x_{p}\\
\theta(\tilde{x}) &amp;= e^{\eta(\tilde{x})}\\
{\lambda}(t|X=x)&amp;= {\lambda}_0(t)e^{\eta(\tilde{x})}=\theta(\tilde{x}) {\lambda}_0(t)
\end{aligned}
\]</span></p>
<hr>
<div class="notes">
<p>Conditional on a single failure at time <span class="math inline">\(t\)</span>, the probability that the event is due to subject <span class="math inline">\(f\in R(t)\)</span> is approximately</p>
</div>
<p><span class="math display">\[
\begin{aligned}
\Pr(f \text{ fails}|\text{1 failure at } t)
&amp;= \frac{{\lambda}_0(t)e^{\eta(\tilde{x}_f)}}{\sum_{k \in R(t)}{\lambda}_0(t)e^{\eta(\tilde{x}_f)}}\\
&amp;=\frac{\theta(\tilde{x}_f)}{\sum_{k \in R(t)} \theta(\tilde{x}_k)}
\end{aligned}
\]</span></p>
<div class="notes">
<p>The logic behind this has several steps. We first fix (ex post) the failure times and note that in this discrete context, the probability <span class="math inline">\(p_j\)</span> that a subject <span class="math inline">\(j\)</span> in the risk set fails at time <span class="math inline">\(t\)</span> is just the hazard of that subject at that time.</p>
</div>
<p>If all of the <span class="math inline">\(p_j\)</span> are small, the chance that exactly one subject fails is</p>
<p><span class="math display">\[
\sum_{k\in R(t)}p_k\left[\prod_{m\in R(t), m\ne k} (1-p_m)\right]\approx\sum_{k\in R(t)}p_k
\]</span></p>
<hr>
<div class="notes">
<p>If subject <span class="math inline">\(i\)</span> is the one who experiences the event of interest at time <span class="math inline">\(t_i\)</span>, then the <strong>partial likelihood</strong> is</p>
</div>
<!-- https://www.overleaf.com/learn/latex/Using_colors_in_LaTeX#Named_colors_provided_by_the_xcolor_package -->
<!-- \def\or{\theta}  -->
<!-- doesn't work for some reason -->
<p><span class="math display">\[
\begin{aligned}
\mathscr{L}^*_i &amp;= \frac{\theta(\tilde{x}_i)}{\sum_{k \in R(t_i)} \theta(\tilde{x}_k)}
\\
\mathscr{L}^* &amp;=
\prod_{{\left\{i:\ d_i = 1\right\}}} \mathscr{L}^*_i
\end{aligned}
\]</span></p>
<div class="notes">
<p>and we can numerically maximize this with respect to the coefficients <span class="math inline">\(\tilde{\beta}\)</span> that specify <span class="math inline">\(\eta(\tilde{x}) = \tilde{x}'\tilde{\beta}\)</span>. When there are tied event times adjustments need to be made, but the likelihood is still similar. Note that we don’t need to know the base hazard to solve for the coefficients.</p>
<p>Once we have coefficient estimates <span class="math inline">\(\hat{\tilde{\beta}} =(\hat \beta_1,\ldots,\hat\beta_p)\)</span>, this also defines <span class="math inline">\(\hat\eta(x)\)</span> and <span class="math inline">\(\hat\theta(x)\)</span>, and then the estimated base cumulative hazard function is</p>
<p><span class="math display">\[\hat {\Lambda}_0(t) =
\sum_{t_i &lt; t} \frac{d_i}{\sum_{k\in R(t_i)} \theta(x_k)}\]</span></p>
<p>which reduces to the Nelson-Aalen estimate when there are no covariates. There are numerous other estimates that have been proposed as well.</p>
</div>
</section><section id="example-proportional-hazards-model-for-the-bmt-data" class="level2" data-number="7.5"><h2 data-number="7.5" class="anchored" data-anchor-id="example-proportional-hazards-model-for-the-bmt-data">
<span class="header-section-number">7.5</span> Example: Proportional hazards model for the <code>bmt</code> data</h2>
<section id="fit-the-model" class="level3" data-number="7.5.1"><h3 data-number="7.5.1" class="anchored" data-anchor-id="fit-the-model">
<span class="header-section-number">7.5.1</span> Fit the model</h3>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span></span>
<span><span class="va">bmt.cox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">d3</span><span class="op">)</span> <span class="op">~</span> <span class="va">group</span>, data <span class="op">=</span> <span class="va">bmt</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">bmt.cox</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = Surv(t2, d3) ~ group, data = bmt)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 137, number of events= 83 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                      coef exp(coef) se(coef)     z Pr(&gt;|z|)  </span></span>
<span><span class="co">#&gt; groupLow Risk AML  -0.574     0.563    0.287 -2.00    0.046 *</span></span>
<span><span class="co">#&gt; groupHigh Risk AML  0.383     1.467    0.267  1.43    0.152  </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                    exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; groupLow Risk AML      0.563      1.776     0.321     0.989</span></span>
<span><span class="co">#&gt; groupHigh Risk AML     1.467      0.682     0.869     2.478</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.625  (se = 0.03 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 13.4  on 2 df,   p=0.001</span></span>
<span><span class="co">#&gt; Wald test            = 13  on 2 df,   p=0.001</span></span>
<span><span class="co">#&gt; Score (logrank) test = 13.8  on 2 df,   p=0.001</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The table provides hypothesis tests comparing groups 2 and 3 to group 1. Group 3 has the highest hazard, so the most significant comparison is not directly shown.</p>
<p>The coefficient 0.3834 is on the log-hazard-ratio scale, as in log-risk-ratio. The next column gives the hazard ratio 1.4673, and a hypothesis (Wald) test.</p>
<p>The (not shown) group 3 vs.&nbsp;group 2 log hazard ratio is 0.3834 + 0.5742 = 0.9576. The hazard ratio is then exp(0.9576) or 2.605.</p>
<p>Inference on all coefficients and combinations can be constructed using <code>coef(bmt.cox)</code> and <code>vcov(bmt.cox)</code> as with logistic and poisson regression.</p>
<p><strong>Concordance</strong> is agreement of first failure between pairs of subjects and higher predicted risk between those subjects, omitting non-informative pairs.</p>
<p>The Rsquare value is Cox and Snell’s pseudo R-squared and is not very useful.</p>
</section><section id="tests-for-nested-models" class="level3" data-number="7.5.2"><h3 data-number="7.5.2" class="anchored" data-anchor-id="tests-for-nested-models">
<span class="header-section-number">7.5.2</span> Tests for nested models</h3>
<p><code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> prints three tests for whether the model with the group covariate is better than the one without</p>
<ul>
<li>
<code>Likelihood ratio test</code> (chi-squared)</li>
<li>
<code>Wald test</code> (also chi-squared), obtained by adding the squares of the z-scores</li>
<li>
<code>Score</code> = log-rank test, as with comparison of survival functions.</li>
</ul>
<p>The likelihood ratio test is probably best in smaller samples, followed by the Wald test.</p>
</section><section id="survival-curves-from-the-cox-model" class="level3" data-number="7.5.3"><h3 data-number="7.5.3" class="anchored" data-anchor-id="survival-curves-from-the-cox-model">
<span class="header-section-number">7.5.3</span> Survival Curves from the Cox Model</h3>
<p>We can take a look at the resulting group-specific curves:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">km_fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">d3</span><span class="op">)</span> <span class="op">~</span> <span class="va">group</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cox_fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span></span>
<span>  <span class="va">bmt.cox</span>,</span>
<span>  newdata <span class="op">=</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>      group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">)</span>,</span>
<span>      row.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/survminer/index.html">survminer</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>KM <span class="op">=</span> <span class="va">km_fit</span>, Cox <span class="op">=</span> <span class="va">cox_fit</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">survminer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html">ggsurvplot</a></span><span class="op">(</span></span>
<span>    <span class="co"># facet.by = "group",</span></span>
<span>    legend <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    legend.title <span class="op">=</span> <span class="st">""</span>,</span>
<span>    combine <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    fun <span class="op">=</span> <span class="st">'pct'</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">.5</span>,</span>
<span>    ggtheme <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    conf.int <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    censor <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># ggsurvplot() throws some warnings that aren't too worrying</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-surv-bmt-km-cph" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-surv-bmt-km-cph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.6: Survival Functions for Three Groups by KM and Cox Model
</figcaption><div aria-describedby="fig-surv-bmt-km-cph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="proportional-hazards-models_files/figure-html/fig-surv-bmt-km-cph-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure&nbsp;7.6: Survival Functions for Three Groups by KM and Cox Model"><img src="proportional-hazards-models_files/figure-html/fig-surv-bmt-km-cph-1.png" class="img-fluid figure-img" width="672"></a>
</div>
</figure>
</div>
</div>
</div>
<p>When we use <code><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit()</a></code> with a Cox model, we have to specify the covariate levels we are interested in; the argument <code>newdata</code> should include a <code>data.frame</code> with the same named columns as the predictors in the Cox model and one or more levels of each.</p>
<hr>
<p>From <code><a href="https://rdrr.io/pkg/survival/man/survfit.coxph.html">?survfit.coxph</a></code>:</p>
<blockquote class="blockquote">
<p>If the <code>newdata</code> argument is missing, a curve is produced for a single “pseudo” subject with covariate values equal to the means component of the fit. The resulting curve(s) almost never make sense, but the default remains due to an unwarranted attachment to the option shown by some users and by other packages. Two particularly egregious examples are factor variables and interactions. Suppose one were studying interspecies transmission of a virus, and the data set has a factor variable with levels (“pig”, “chicken”) and about equal numbers of observations for each. The “mean” covariate level will be 0.5 – is this a flying pig?</p>
</blockquote>
</section><section id="examining-survfit" class="level3" data-number="7.5.4"><h3 data-number="7.5.4" class="anchored" data-anchor-id="examining-survfit">
<span class="header-section-number">7.5.4</span> Examining <code>survfit</code>
</h3>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">d3</span><span class="op">)</span> <span class="op">~</span> <span class="va">group</span>, data <span class="op">=</span> <span class="va">bmt</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call: survfit(formula = Surv(t2, d3) ~ group, data = bmt)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                      n events median 0.95LCL 0.95UCL</span></span>
<span><span class="co">#&gt; group=ALL           38     24    418     194      NA</span></span>
<span><span class="co">#&gt; group=Low Risk AML  54     25   2204     704      NA</span></span>
<span><span class="co">#&gt; group=High Risk AML 45     34    183     115     456</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">d3</span><span class="op">)</span> <span class="op">~</span> <span class="va">group</span>, data <span class="op">=</span> <span class="va">bmt</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call: survfit(formula = Surv(t2, d3) ~ group, data = bmt)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                 group=ALL </span></span>
<span><span class="co">#&gt;  time n.risk n.event survival std.err lower 95% CI upper 95% CI</span></span>
<span><span class="co">#&gt;     1     38       1    0.974  0.0260        0.924        1.000</span></span>
<span><span class="co">#&gt;    55     37       1    0.947  0.0362        0.879        1.000</span></span>
<span><span class="co">#&gt;    74     36       1    0.921  0.0437        0.839        1.000</span></span>
<span><span class="co">#&gt;    86     35       1    0.895  0.0498        0.802        0.998</span></span>
<span><span class="co">#&gt;   104     34       1    0.868  0.0548        0.767        0.983</span></span>
<span><span class="co">#&gt;   107     33       1    0.842  0.0592        0.734        0.966</span></span>
<span><span class="co">#&gt;   109     32       1    0.816  0.0629        0.701        0.949</span></span>
<span><span class="co">#&gt;   110     31       1    0.789  0.0661        0.670        0.930</span></span>
<span><span class="co">#&gt;   122     30       2    0.737  0.0714        0.609        0.891</span></span>
<span><span class="co">#&gt;   129     28       1    0.711  0.0736        0.580        0.870</span></span>
<span><span class="co">#&gt;   172     27       1    0.684  0.0754        0.551        0.849</span></span>
<span><span class="co">#&gt;   192     26       1    0.658  0.0770        0.523        0.827</span></span>
<span><span class="co">#&gt;   194     25       1    0.632  0.0783        0.495        0.805</span></span>
<span><span class="co">#&gt;   230     23       1    0.604  0.0795        0.467        0.782</span></span>
<span><span class="co">#&gt;   276     22       1    0.577  0.0805        0.439        0.758</span></span>
<span><span class="co">#&gt;   332     21       1    0.549  0.0812        0.411        0.734</span></span>
<span><span class="co">#&gt;   383     20       1    0.522  0.0817        0.384        0.709</span></span>
<span><span class="co">#&gt;   418     19       1    0.494  0.0819        0.357        0.684</span></span>
<span><span class="co">#&gt;   466     18       1    0.467  0.0818        0.331        0.658</span></span>
<span><span class="co">#&gt;   487     17       1    0.439  0.0815        0.305        0.632</span></span>
<span><span class="co">#&gt;   526     16       1    0.412  0.0809        0.280        0.605</span></span>
<span><span class="co">#&gt;   609     14       1    0.382  0.0803        0.254        0.577</span></span>
<span><span class="co">#&gt;   662     13       1    0.353  0.0793        0.227        0.548</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                 group=Low Risk AML </span></span>
<span><span class="co">#&gt;  time n.risk n.event survival std.err lower 95% CI upper 95% CI</span></span>
<span><span class="co">#&gt;    10     54       1    0.981  0.0183        0.946        1.000</span></span>
<span><span class="co">#&gt;    35     53       1    0.963  0.0257        0.914        1.000</span></span>
<span><span class="co">#&gt;    48     52       1    0.944  0.0312        0.885        1.000</span></span>
<span><span class="co">#&gt;    53     51       1    0.926  0.0356        0.859        0.998</span></span>
<span><span class="co">#&gt;    79     50       1    0.907  0.0394        0.833        0.988</span></span>
<span><span class="co">#&gt;    80     49       1    0.889  0.0428        0.809        0.977</span></span>
<span><span class="co">#&gt;   105     48       1    0.870  0.0457        0.785        0.965</span></span>
<span><span class="co">#&gt;   211     47       1    0.852  0.0483        0.762        0.952</span></span>
<span><span class="co">#&gt;   219     46       1    0.833  0.0507        0.740        0.939</span></span>
<span><span class="co">#&gt;   248     45       1    0.815  0.0529        0.718        0.925</span></span>
<span><span class="co">#&gt;   272     44       1    0.796  0.0548        0.696        0.911</span></span>
<span><span class="co">#&gt;   288     43       1    0.778  0.0566        0.674        0.897</span></span>
<span><span class="co">#&gt;   381     42       1    0.759  0.0582        0.653        0.882</span></span>
<span><span class="co">#&gt;   390     41       1    0.741  0.0596        0.633        0.867</span></span>
<span><span class="co">#&gt;   414     40       1    0.722  0.0610        0.612        0.852</span></span>
<span><span class="co">#&gt;   421     39       1    0.704  0.0621        0.592        0.837</span></span>
<span><span class="co">#&gt;   481     38       1    0.685  0.0632        0.572        0.821</span></span>
<span><span class="co">#&gt;   486     37       1    0.667  0.0642        0.552        0.805</span></span>
<span><span class="co">#&gt;   606     36       1    0.648  0.0650        0.533        0.789</span></span>
<span><span class="co">#&gt;   641     35       1    0.630  0.0657        0.513        0.773</span></span>
<span><span class="co">#&gt;   704     34       1    0.611  0.0663        0.494        0.756</span></span>
<span><span class="co">#&gt;   748     33       1    0.593  0.0669        0.475        0.739</span></span>
<span><span class="co">#&gt;  1063     26       1    0.570  0.0681        0.451        0.720</span></span>
<span><span class="co">#&gt;  1074     25       1    0.547  0.0691        0.427        0.701</span></span>
<span><span class="co">#&gt;  2204      6       1    0.456  0.1012        0.295        0.704</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                 group=High Risk AML </span></span>
<span><span class="co">#&gt;  time n.risk n.event survival std.err lower 95% CI upper 95% CI</span></span>
<span><span class="co">#&gt;     2     45       1    0.978  0.0220        0.936        1.000</span></span>
<span><span class="co">#&gt;    16     44       1    0.956  0.0307        0.897        1.000</span></span>
<span><span class="co">#&gt;    32     43       1    0.933  0.0372        0.863        1.000</span></span>
<span><span class="co">#&gt;    47     42       2    0.889  0.0468        0.802        0.986</span></span>
<span><span class="co">#&gt;    48     40       1    0.867  0.0507        0.773        0.972</span></span>
<span><span class="co">#&gt;    63     39       1    0.844  0.0540        0.745        0.957</span></span>
<span><span class="co">#&gt;    64     38       1    0.822  0.0570        0.718        0.942</span></span>
<span><span class="co">#&gt;    74     37       1    0.800  0.0596        0.691        0.926</span></span>
<span><span class="co">#&gt;    76     36       1    0.778  0.0620        0.665        0.909</span></span>
<span><span class="co">#&gt;    80     35       1    0.756  0.0641        0.640        0.892</span></span>
<span><span class="co">#&gt;    84     34       1    0.733  0.0659        0.615        0.875</span></span>
<span><span class="co">#&gt;    93     33       1    0.711  0.0676        0.590        0.857</span></span>
<span><span class="co">#&gt;   100     32       1    0.689  0.0690        0.566        0.838</span></span>
<span><span class="co">#&gt;   105     31       1    0.667  0.0703        0.542        0.820</span></span>
<span><span class="co">#&gt;   113     30       1    0.644  0.0714        0.519        0.801</span></span>
<span><span class="co">#&gt;   115     29       1    0.622  0.0723        0.496        0.781</span></span>
<span><span class="co">#&gt;   120     28       1    0.600  0.0730        0.473        0.762</span></span>
<span><span class="co">#&gt;   157     27       1    0.578  0.0736        0.450        0.742</span></span>
<span><span class="co">#&gt;   162     26       1    0.556  0.0741        0.428        0.721</span></span>
<span><span class="co">#&gt;   164     25       1    0.533  0.0744        0.406        0.701</span></span>
<span><span class="co">#&gt;   168     24       1    0.511  0.0745        0.384        0.680</span></span>
<span><span class="co">#&gt;   183     23       1    0.489  0.0745        0.363        0.659</span></span>
<span><span class="co">#&gt;   242     22       1    0.467  0.0744        0.341        0.638</span></span>
<span><span class="co">#&gt;   268     21       1    0.444  0.0741        0.321        0.616</span></span>
<span><span class="co">#&gt;   273     20       1    0.422  0.0736        0.300        0.594</span></span>
<span><span class="co">#&gt;   318     19       1    0.400  0.0730        0.280        0.572</span></span>
<span><span class="co">#&gt;   363     18       1    0.378  0.0723        0.260        0.550</span></span>
<span><span class="co">#&gt;   390     17       1    0.356  0.0714        0.240        0.527</span></span>
<span><span class="co">#&gt;   422     16       1    0.333  0.0703        0.221        0.504</span></span>
<span><span class="co">#&gt;   456     15       1    0.311  0.0690        0.201        0.481</span></span>
<span><span class="co">#&gt;   467     14       1    0.289  0.0676        0.183        0.457</span></span>
<span><span class="co">#&gt;   625     13       1    0.267  0.0659        0.164        0.433</span></span>
<span><span class="co">#&gt;   677     12       1    0.244  0.0641        0.146        0.409</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="va">bmt.cox</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call: survfit(formula = bmt.cox)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;        n events median 0.95LCL 0.95UCL</span></span>
<span><span class="co">#&gt; [1,] 137     83    422     268      NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="va">bmt.cox</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call: survfit(formula = bmt.cox, newdata = tibble(group = unique(bmt$group)))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     n events median 0.95LCL 0.95UCL</span></span>
<span><span class="co">#&gt; 1 137     83    422     268      NA</span></span>
<span><span class="co">#&gt; 2 137     83     NA     625      NA</span></span>
<span><span class="co">#&gt; 3 137     83    268     162     467</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt.cox</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span>newdata <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">bmt</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call: survfit(formula = bmt.cox, newdata = tibble(group = unique(bmt$group)))</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  time n.risk n.event survival1 survival2 survival3</span></span>
<span><span class="co">#&gt;     1    137       1     0.993     0.996     0.989</span></span>
<span><span class="co">#&gt;     2    136       1     0.985     0.992     0.978</span></span>
<span><span class="co">#&gt;    10    135       1     0.978     0.987     0.968</span></span>
<span><span class="co">#&gt;    16    134       1     0.970     0.983     0.957</span></span>
<span><span class="co">#&gt;    32    133       1     0.963     0.979     0.946</span></span>
<span><span class="co">#&gt;    35    132       1     0.955     0.975     0.935</span></span>
<span><span class="co">#&gt;    47    131       2     0.941     0.966     0.914</span></span>
<span><span class="co">#&gt;    48    129       2     0.926     0.957     0.893</span></span>
<span><span class="co">#&gt;    53    127       1     0.918     0.953     0.882</span></span>
<span><span class="co">#&gt;    55    126       1     0.911     0.949     0.872</span></span>
<span><span class="co">#&gt;    63    125       1     0.903     0.944     0.861</span></span>
<span><span class="co">#&gt;    64    124       1     0.896     0.940     0.851</span></span>
<span><span class="co">#&gt;    74    123       2     0.881     0.931     0.830</span></span>
<span><span class="co">#&gt;    76    121       1     0.873     0.926     0.819</span></span>
<span><span class="co">#&gt;    79    120       1     0.865     0.922     0.809</span></span>
<span><span class="co">#&gt;    80    119       2     0.850     0.913     0.788</span></span>
<span><span class="co">#&gt;    84    117       1     0.843     0.908     0.778</span></span>
<span><span class="co">#&gt;    86    116       1     0.835     0.903     0.768</span></span>
<span><span class="co">#&gt;    93    115       1     0.827     0.899     0.757</span></span>
<span><span class="co">#&gt;   100    114       1     0.820     0.894     0.747</span></span>
<span><span class="co">#&gt;   104    113       1     0.812     0.889     0.737</span></span>
<span><span class="co">#&gt;   105    112       2     0.797     0.880     0.717</span></span>
<span><span class="co">#&gt;   107    110       1     0.789     0.875     0.707</span></span>
<span><span class="co">#&gt;   109    109       1     0.782     0.870     0.697</span></span>
<span><span class="co">#&gt;   110    108       1     0.774     0.866     0.687</span></span>
<span><span class="co">#&gt;   113    107       1     0.766     0.861     0.677</span></span>
<span><span class="co">#&gt;   115    106       1     0.759     0.856     0.667</span></span>
<span><span class="co">#&gt;   120    105       1     0.751     0.851     0.657</span></span>
<span><span class="co">#&gt;   122    104       2     0.735     0.841     0.637</span></span>
<span><span class="co">#&gt;   129    102       1     0.727     0.836     0.627</span></span>
<span><span class="co">#&gt;   157    101       1     0.720     0.831     0.617</span></span>
<span><span class="co">#&gt;   162    100       1     0.712     0.826     0.607</span></span>
<span><span class="co">#&gt;   164     99       1     0.704     0.821     0.598</span></span>
<span><span class="co">#&gt;   168     98       1     0.696     0.815     0.588</span></span>
<span><span class="co">#&gt;   172     97       1     0.688     0.810     0.578</span></span>
<span><span class="co">#&gt;   183     96       1     0.680     0.805     0.568</span></span>
<span><span class="co">#&gt;   192     95       1     0.672     0.800     0.558</span></span>
<span><span class="co">#&gt;   194     94       1     0.664     0.794     0.549</span></span>
<span><span class="co">#&gt;   211     93       1     0.656     0.789     0.539</span></span>
<span><span class="co">#&gt;   219     92       1     0.648     0.783     0.530</span></span>
<span><span class="co">#&gt;   230     90       1     0.640     0.778     0.520</span></span>
<span><span class="co">#&gt;   242     89       1     0.632     0.773     0.511</span></span>
<span><span class="co">#&gt;   248     88       1     0.624     0.767     0.501</span></span>
<span><span class="co">#&gt;   268     87       1     0.616     0.761     0.492</span></span>
<span><span class="co">#&gt;   272     86       1     0.608     0.756     0.482</span></span>
<span><span class="co">#&gt;   273     85       1     0.600     0.750     0.473</span></span>
<span><span class="co">#&gt;   276     84       1     0.592     0.745     0.464</span></span>
<span><span class="co">#&gt;   288     83       1     0.584     0.739     0.454</span></span>
<span><span class="co">#&gt;   318     82       1     0.576     0.733     0.445</span></span>
<span><span class="co">#&gt;   332     81       1     0.568     0.727     0.436</span></span>
<span><span class="co">#&gt;   363     80       1     0.560     0.722     0.427</span></span>
<span><span class="co">#&gt;   381     79       1     0.552     0.716     0.418</span></span>
<span><span class="co">#&gt;   383     78       1     0.544     0.710     0.409</span></span>
<span><span class="co">#&gt;   390     77       2     0.528     0.698     0.392</span></span>
<span><span class="co">#&gt;   414     75       1     0.520     0.692     0.383</span></span>
<span><span class="co">#&gt;   418     74       1     0.512     0.686     0.374</span></span>
<span><span class="co">#&gt;   421     73       1     0.504     0.680     0.366</span></span>
<span><span class="co">#&gt;   422     72       1     0.496     0.674     0.357</span></span>
<span><span class="co">#&gt;   456     71       1     0.488     0.667     0.349</span></span>
<span><span class="co">#&gt;   466     70       1     0.480     0.661     0.340</span></span>
<span><span class="co">#&gt;   467     69       1     0.472     0.655     0.332</span></span>
<span><span class="co">#&gt;   481     68       1     0.464     0.649     0.324</span></span>
<span><span class="co">#&gt;   486     67       1     0.455     0.642     0.315</span></span>
<span><span class="co">#&gt;   487     66       1     0.447     0.636     0.307</span></span>
<span><span class="co">#&gt;   526     65       1     0.439     0.629     0.299</span></span>
<span><span class="co">#&gt;   606     63       1     0.431     0.623     0.291</span></span>
<span><span class="co">#&gt;   609     62       1     0.423     0.616     0.283</span></span>
<span><span class="co">#&gt;   625     61       1     0.415     0.609     0.275</span></span>
<span><span class="co">#&gt;   641     60       1     0.407     0.603     0.267</span></span>
<span><span class="co">#&gt;   662     59       1     0.399     0.596     0.260</span></span>
<span><span class="co">#&gt;   677     58       1     0.391     0.589     0.252</span></span>
<span><span class="co">#&gt;   704     57       1     0.383     0.582     0.244</span></span>
<span><span class="co">#&gt;   748     56       1     0.374     0.575     0.237</span></span>
<span><span class="co">#&gt;  1063     47       1     0.365     0.567     0.228</span></span>
<span><span class="co">#&gt;  1074     46       1     0.356     0.559     0.220</span></span>
<span><span class="co">#&gt;  2204      9       1     0.313     0.520     0.182</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="adjustment-for-ties-optional" class="level2" data-number="7.6"><h2 data-number="7.6" class="anchored" data-anchor-id="adjustment-for-ties-optional">
<span class="header-section-number">7.6</span> Adjustment for Ties (optional)</h2>
<hr>
<p>At each time <span class="math inline">\(t_i\)</span> at which more than one of the subjects has an event, let <span class="math inline">\(d_i\)</span> be the number of events at that time, <span class="math inline">\(D_i\)</span> the set of subjects with events at that time, and let <span class="math inline">\(s_i\)</span> be a covariate vector for an artificial subject obtained by adding up the covariate values for the subjects with an event at time <span class="math inline">\(t_i\)</span>. Let <span class="math display">\[\bar\eta_i = \beta_1s_{i1}+\cdots+\beta_ps_{ip}\]</span> and <span class="math inline">\(\bar\theta_i = \text{exp}{\left\{\bar\eta_i\right\}}\)</span>.</p>
<p>Let <span class="math inline">\(s_i\)</span> be a covariate vector for an artificial subject obtained by adding up the covariate values for the subjects with an event at time <span class="math inline">\(t_i\)</span>. Note that</p>
<p><span class="math display">\[
\begin{aligned}
\bar\eta_i &amp;=\sum_{j \in D_i}\beta_1x_{j1}+\cdots+\beta_px_{jp}\\
&amp;= \beta_1s_{i1}+\cdots+\beta_ps_{ip}\\
\bar\theta_i &amp;= \text{exp}{\left\{\bar\eta_i\right\}}\\
&amp;= \prod_{j \in D_i}\theta_i
\end{aligned}
\]</span></p>
<section id="breslows-method-for-ties" class="level4"><h4 class="anchored" data-anchor-id="breslows-method-for-ties">Breslow’s method for ties</h4>
<p>Breslow’s method estimates the partial likelihood as</p>
<p><span class="math display">\[
\begin{aligned}
L(\beta|T) &amp;=
\prod_i \frac{\bar\theta_i}{[\sum_{k \in R(t_i)} \theta_k]^{d_i}}\\
&amp;= \prod_i \prod_{j \in D_i}\frac{\theta_j}{\sum_{k \in R(t_i)} \theta_k}
\end{aligned}
\]</span></p>
<p>This method is equivalent to treating each event as distinct and using the non-ties formula. It works best when the number of ties is small. It is the default in many statistical packages, including PROC PHREG in SAS.</p>
</section><section id="efrons-method-for-ties" class="level4"><h4 class="anchored" data-anchor-id="efrons-method-for-ties">Efron’s method for ties</h4>
<p>The other common method is Efron’s, which is the default in R.</p>
<p><span class="math display">\[L(\beta|T)=
\prod_i \frac{\bar\theta_i}{\prod_{j=1}^{d_i}[\sum_{k \in R(t_i)} \theta_k-\frac{j-1}{d_i}\sum_{k \in D_i} \theta_k]}\]</span> This is closer to the exact discrete partial likelihood when there are many ties.</p>
<p>The third option in R (and an option also in SAS as <code>discrete</code>) is the “exact” method, which is the same one used for matched logistic regression.</p>
</section><section id="example-breslows-method" class="level4"><h4 class="anchored" data-anchor-id="example-breslows-method">Example: Breslow’s method</h4>
<p>Suppose as an example we have a time <span class="math inline">\(t\)</span> where there are 20 individuals at risk and three failures. Let the three individuals have risk parameters <span class="math inline">\(\theta_1, \theta_2, \theta_3\)</span> and let the sum of the risk parameters of the remaining 17 individuals be <span class="math inline">\(\theta_R\)</span>. Then the factor in the partial likelihood at time <span class="math inline">\(t\)</span> using Breslow’s method is</p>
<div class="smaller">
<p><span class="math display">\[
\left(\frac{\theta_1}{\theta_R+\theta_1+\theta_2+\theta_3}\right)
\left(\frac{\theta_2}{\theta_R+\theta_1+\theta_2+\theta_3}\right)
\left(\frac{\theta_3}{\theta_R+\theta_1+\theta_2+\theta_3}\right)
\]</span></p>
</div>
<p>If on the other hand, they had died in the order 1,2, 3, then the contribution to the partial likelihood would be:</p>
<div class="smaller">
<p><span class="math display">\[
\left(\frac{\theta_1}{\theta_R+\theta_1+\theta_2+\theta_3}\right)
\left(\frac{\theta_2}{\theta_R+\theta_2+\theta_3}\right)
\left(\frac{\theta_3}{\theta_R+\theta_3}\right)
\]</span></p>
</div>
<p>as the risk set got smaller with each failure. The exact method roughly averages the results for the six possible orderings of the failures.</p>
</section><section id="example-efrons-method" class="level4"><h4 class="anchored" data-anchor-id="example-efrons-method">Example: Efron’s method</h4>
<p>But we don’t know the order they failed in, so instead of reducing the denominator by one risk coefficient each time, we reduce it by the same fraction. This is Efron’s method.</p>
<div class="smaller">
<p><span class="math display">\[\left(\frac{\theta_1}{\theta_R+\theta_1+\theta_2+\theta_3}\right)
\left(\frac{\theta_2}{\theta_R+2(\theta_1+\theta_2+\theta_3)/3}\right)
\left(\frac{\theta_3}{\theta_R+(\theta_1+\theta_2+\theta_3)/3}\right)\]</span></p>
</div>
<!-- https://www.overleaf.com/learn/latex/Using_colors_in_LaTeX#Named_colors_provided_by_the_xcolor_package -->
<!-- \def\or{\theta}  -->
<!-- doesn't work for some reason -->
</section></section><section id="building-cox-proportional-hazards-models" class="level2" data-number="7.7"><h2 data-number="7.7" class="anchored" data-anchor-id="building-cox-proportional-hazards-models">
<span class="header-section-number">7.7</span> Building Cox Proportional Hazards models</h2>
<section id="hodg-lymphoma-data-set-from-kmsurv" class="level3" data-number="7.7.1"><h3 data-number="7.7.1" class="anchored" data-anchor-id="hodg-lymphoma-data-set-from-kmsurv">
<span class="header-section-number">7.7.1</span> <code>hodg</code> Lymphoma Data Set from <code>KMsurv</code>
</h3>
<section id="participants" class="level4"><h4 class="anchored" data-anchor-id="participants">Participants</h4>
<p>43 bone marrow transplant patients at Ohio State University (Avalos 1993)</p>
</section><section id="variables" class="level4"><h4 class="anchored" data-anchor-id="variables">Variables</h4>
<ul>
<li>
<code>dtype</code>: Disease type (Hodgkin’s or non-Hodgkins lymphoma)</li>
<li>
<code>gtype</code>: Bone marrow graft type:</li>
<li>allogeneic: from HLA-matched sibling</li>
<li>autologous: from self (prior to chemo)</li>
<li>
<code>time</code>: time to study exit</li>
<li>
<code>delta</code>: study exit reason (death/relapse vs censored)</li>
<li>
<code>wtime</code>: waiting time to transplant (in months)</li>
<li>
<code>score</code>: Karnofsky score:</li>
<li>80–100: Able to carry on normal activity and to work; no special care needed.</li>
<li>50–70: Unable to work; able to live at home and care for most personal needs; varying amount of assistance needed.</li>
<li>10–60: Unable to care for self; requires equivalent of institutional or hospital care; disease may be progressing rapidly.</li>
</ul></section><section id="data" class="level4"><h4 class="anchored" data-anchor-id="data">Data</h4>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">hodg</span>, package <span class="op">=</span> <span class="st">"KMsurv"</span><span class="op">)</span></span>
<span><span class="va">hodg2</span> <span class="op">=</span> <span class="va">hodg</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># We add factor labels to the categorical variables:</span></span>
<span>    gtype <span class="op">=</span> <span class="va">gtype</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"Allogenic"</span>,</span>
<span>        <span class="fl">2</span> <span class="op">~</span> <span class="st">"Autologous"</span><span class="op">)</span>,</span>
<span>    dtype <span class="op">=</span> <span class="va">dtype</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"Non-Hodgkins"</span>,</span>
<span>        <span class="fl">2</span> <span class="op">~</span> <span class="st">"Hodgkins"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span>ref <span class="op">=</span> <span class="st">"Non-Hodgkins"</span><span class="op">)</span>, </span>
<span>    delta <span class="op">=</span> <span class="va">delta</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"dead"</span>,</span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"alive"</span><span class="op">)</span>,</span>
<span>    surv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span></span>
<span>      time <span class="op">=</span> <span class="va">time</span>, </span>
<span>      event <span class="op">=</span> <span class="va">delta</span> <span class="op">==</span> <span class="st">"dead"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">hodg2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 43 × 7</span></span>
<span><span class="co">#&gt;    gtype     dtype         time delta score wtime   surv</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;     &lt;fct&gt;        &lt;int&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;Surv&gt;</span></span>
<span><span class="co">#&gt;  1 Allogenic Non-Hodgkins    28 dead     90    24    28 </span></span>
<span><span class="co">#&gt;  2 Allogenic Non-Hodgkins    32 dead     30     7    32 </span></span>
<span><span class="co">#&gt;  3 Allogenic Non-Hodgkins    49 dead     40     8    49 </span></span>
<span><span class="co">#&gt;  4 Allogenic Non-Hodgkins    84 dead     60    10    84 </span></span>
<span><span class="co">#&gt;  5 Allogenic Non-Hodgkins   357 dead     70    42   357 </span></span>
<span><span class="co">#&gt;  6 Allogenic Non-Hodgkins   933 alive    90     9   933+</span></span>
<span><span class="co">#&gt;  7 Allogenic Non-Hodgkins  1078 alive   100    16  1078+</span></span>
<span><span class="co">#&gt;  8 Allogenic Non-Hodgkins  1183 alive    90    16  1183+</span></span>
<span><span class="co">#&gt;  9 Allogenic Non-Hodgkins  1560 alive    80    20  1560+</span></span>
<span><span class="co">#&gt; 10 Allogenic Non-Hodgkins  2114 alive    80    27  2114+</span></span>
<span><span class="co">#&gt; # ℹ 33 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="proportional-hazards-model-1" class="level3" data-number="7.7.2"><h3 data-number="7.7.2" class="anchored" data-anchor-id="proportional-hazards-model-1">
<span class="header-section-number">7.7.2</span> Proportional hazards model</h3>
<div id="tbl-summary-hodg.cox1" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-summary-hodg.cox1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7.1: Summary of Proportional Hazards model for Hodgkins Lymphoma data
</figcaption><div aria-describedby="tbl-summary-hodg.cox1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg.cox1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">gtype</span> <span class="op">*</span> <span class="va">dtype</span> <span class="op">+</span> <span class="va">score</span> <span class="op">+</span> <span class="va">wtime</span>, </span>
<span>  data <span class="op">=</span> <span class="va">hodg2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">hodg.cox1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = surv ~ gtype * dtype + score + wtime, data = hodg2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 43, number of events= 26 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                                  coef exp(coef) se(coef)     z Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; gtypeAutologous                0.6394    1.8953   0.5937  1.08   0.2815    </span></span>
<span><span class="co">#&gt; dtypeHodgkins                  2.7603   15.8050   0.9474  2.91   0.0036 ** </span></span>
<span><span class="co">#&gt; score                         -0.0495    0.9517   0.0124 -3.98  6.8e-05 ***</span></span>
<span><span class="co">#&gt; wtime                         -0.0166    0.9836   0.0102 -1.62   0.1046    </span></span>
<span><span class="co">#&gt; gtypeAutologous:dtypeHodgkins -2.3709    0.0934   1.0355 -2.29   0.0220 *  </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                               exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; gtypeAutologous                  1.8953     0.5276    0.5920     6.068</span></span>
<span><span class="co">#&gt; dtypeHodgkins                   15.8050     0.0633    2.4682   101.207</span></span>
<span><span class="co">#&gt; score                            0.9517     1.0507    0.9288     0.975</span></span>
<span><span class="co">#&gt; wtime                            0.9836     1.0167    0.9641     1.003</span></span>
<span><span class="co">#&gt; gtypeAutologous:dtypeHodgkins    0.0934    10.7074    0.0123     0.711</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.776  (se = 0.059 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 32.1  on 5 df,   p=6e-06</span></span>
<span><span class="co">#&gt; Wald test            = 27.2  on 5 df,   p=5e-05</span></span>
<span><span class="co">#&gt; Score (logrank) test = 37.7  on 5 df,   p=4e-07</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</figure>
</div>
</section></section><section id="diagnostic-graphs-for-proportional-hazards-assumption" class="level2" data-number="7.8"><h2 data-number="7.8" class="anchored" data-anchor-id="diagnostic-graphs-for-proportional-hazards-assumption">
<span class="header-section-number">7.8</span> Diagnostic graphs for proportional hazards assumption</h2>
<section id="analysis-plan" class="level3" data-number="7.8.1"><h3 data-number="7.8.1" class="anchored" data-anchor-id="analysis-plan">
<span class="header-section-number">7.8.1</span> Analysis plan</h3>
<ul>
<li>
<strong>survival function</strong> for the four combinations of disease type and graft type.</li>
<li>
<strong>observed (nonparametric) vs.&nbsp;expected (semiparametric) survival</strong> functions.</li>
<li>
<strong>complementary log-log survival</strong> for the four groups.</li>
</ul></section><section id="kaplan-meier-survival-functions" class="level3" data-number="7.8.2"><h3 data-number="7.8.2" class="anchored" data-anchor-id="kaplan-meier-survival-functions">
<span class="header-section-number">7.8.2</span> Kaplan-Meier survival functions</h3>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">km_model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">dtype</span> <span class="op">+</span> <span class="va">gtype</span>,</span>
<span>  data <span class="op">=</span> <span class="va">hodg2</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">km_model</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span>conf.int <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    legend.position<span class="op">=</span><span class="st">"bottom"</span>,</span>
<span>    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">legend_text_size</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>col<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">'Survival probability, S(t)'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Time since transplant (days)"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-km-hodg2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-km-hodg2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.7: Kaplan-Meier Survival Curves for HOD/NHL and Allo/Auto Grafts
</figcaption><div aria-describedby="fig-km-hodg2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="proportional-hazards-models_files/figure-html/fig-km-hodg2-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Figure&nbsp;7.7: Kaplan-Meier Survival Curves for HOD/NHL and Allo/Auto Grafts"><img src="proportional-hazards-models_files/figure-html/fig-km-hodg2-1.png" class="img-fluid figure-img" width="672"></a>
</div>
</figure>
</div>
</div>
</div>
</section><section id="observed-and-expected-survival-curves" class="level3" data-number="7.8.3"><h3 data-number="7.8.3" class="anchored" data-anchor-id="observed-and-expected-survival-curves">
<span class="header-section-number">7.8.3</span> Observed and expected survival curves</h3>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># we need to create a tibble of covariate patterns;</span></span>
<span><span class="co"># we will set score and wtime to mean values for disease and graft types:</span></span>
<span><span class="va">means</span> <span class="op">=</span> <span class="va">hodg2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">dtype</span>, <span class="va">gtype</span><span class="op">)</span>, </span>
<span>    score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">score</span><span class="op">)</span>, </span>
<span>    wtime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">wtime</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">dtype</span>, <span class="va">gtype</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">dtype</span>, <span class="va">gtype</span>, sep <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># survfit.coxph() will use the rownames of its `newdata`</span></span>
<span><span class="co"># argument to label its output:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span> <span class="op">=</span> <span class="va">means</span><span class="op">$</span><span class="va">strata</span></span>
<span></span>
<span><span class="va">cox_model</span> <span class="op">=</span> </span>
<span>  <span class="va">hodg.cox1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">hodg2</span>, <span class="co"># ggsurvplot() will need this</span></span>
<span>    newdata <span class="op">=</span> <span class="va">means</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># I couldn't find a good function to reformat `cox_model` for ggplot, </span></span>
<span><span class="co"># so I made my own:</span></span>
<span><span class="va">stack_surv_ph</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">cox_model</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">cox_model</span><span class="op">$</span><span class="va">surv</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">cox_model</span><span class="op">$</span><span class="va">time</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>      cols <span class="op">=</span> <span class="op">-</span><span class="va">time</span>,</span>
<span>      names_to <span class="op">=</span> <span class="st">"strata"</span>,</span>
<span>      values_to <span class="op">=</span> <span class="st">"surv"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      cumhaz <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">surv</span><span class="op">)</span>,</span>
<span>      model <span class="op">=</span> <span class="st">"Cox PH"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">km_and_cph</span> <span class="op">=</span></span>
<span>  <span class="va">km_model</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span>surv.connect <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/trimws.html">trimws</a></span><span class="op">(</span><span class="va">strata</span><span class="op">)</span>,</span>
<span>    model <span class="op">=</span> <span class="st">"Kaplan-Meier"</span>,</span>
<span>    cumhaz <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">surv</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="fu">stack_surv_ph</span><span class="op">(</span><span class="va">cox_model</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">km_and_cph</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">surv</span>, col <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_step</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">strata</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"S(t) = P(T&gt;=t)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Survival time (t, days)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption>Observed and expected survival curves for <code>bmt</code> data</figcaption><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-5-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8" title="Observed and expected survival curves for bmt data"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672" alt="Observed and expected survival curves for bmt data"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="cumulative-hazard-log-scale-curves" class="level3" data-number="7.8.4"><h3 data-number="7.8.4" class="anchored" data-anchor-id="cumulative-hazard-log-scale-curves">
<span class="header-section-number">7.8.4</span> Cumulative hazard (log-scale) curves</h3>
<p>Also known as “complementary log-log (clog-log) survival curves”.</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">na_model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">dtype</span> <span class="op">+</span> <span class="va">gtype</span>,</span>
<span>  data <span class="op">=</span> <span class="va">hodg2</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"fleming"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">na_model</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">survminer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html">ggsurvplot</a></span><span class="op">(</span></span>
<span>  legend <span class="op">=</span> <span class="st">"bottom"</span>, </span>
<span>  legend.title <span class="op">=</span> <span class="st">""</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">"log(Cumulative Hazard)"</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Time since transplant (days, log-scale)"</span>,</span>
<span>  fun <span class="op">=</span> <span class="st">'cloglog'</span>, </span>
<span>  size <span class="op">=</span> <span class="fl">.5</span>,</span>
<span>  ggtheme <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  conf.int <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>  censor <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">extract2</a></span><span class="op">(</span><span class="st">"plot"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span></span>
<span>    col <span class="op">=</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span></span>
<span>        ncol <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        label.theme <span class="op">=</span> </span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span></span>
<span>            size <span class="op">=</span> <span class="va">legend_text_size</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cloglog-na" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-cloglog-na-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.8: Complementary log-log survival curves - Nelson-Aalen estimates
</figcaption><div aria-describedby="fig-cloglog-na-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="proportional-hazards-models_files/figure-html/fig-cloglog-na-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9" title="Figure&nbsp;7.8: Complementary log-log survival curves - Nelson-Aalen estimates"><img src="proportional-hazards-models_files/figure-html/fig-cloglog-na-1.png" class="img-fluid figure-img" width="672"></a>
</div>
</figure>
</div>
</div>
</div>
<p>Let’s compare these empirical (i.e., non-parametric) curves with the fitted curves from our <code><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph()</a></code> model:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cox_model</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">survminer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html">ggsurvplot</a></span><span class="op">(</span></span>
<span>    facet_by <span class="op">=</span> <span class="st">""</span>,</span>
<span>    legend <span class="op">=</span> <span class="st">"bottom"</span>, </span>
<span>    legend.title <span class="op">=</span> <span class="st">""</span>,</span>
<span>    ylab <span class="op">=</span> <span class="st">"log(Cumulative Hazard)"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"Time since transplant (days, log-scale)"</span>,</span>
<span>    fun <span class="op">=</span> <span class="st">'cloglog'</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">.5</span>,</span>
<span>    ggtheme <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    censor <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># doesn't make sense for cox model</span></span>
<span>    conf.int <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">extract2</a></span><span class="op">(</span><span class="st">"plot"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span></span>
<span>    col <span class="op">=</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span></span>
<span>        ncol <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        label.theme <span class="op">=</span> </span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span></span>
<span>            size <span class="op">=</span> <span class="va">legend_text_size</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cloglog-ph" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-cloglog-ph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.9: Complementary log-log survival curves - PH estimates
</figcaption><div aria-describedby="fig-cloglog-ph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="proportional-hazards-models_files/figure-html/fig-cloglog-ph-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10" title="Figure&nbsp;7.9: Complementary log-log survival curves - PH estimates"><img src="proportional-hazards-models_files/figure-html/fig-cloglog-ph-1.png" class="img-fluid figure-img" width="672"></a>
</div>
</figure>
</div>
</div>
</div>
<p>Now let’s overlay these cumulative hazard curves:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">na_and_cph</span> <span class="op">=</span> </span>
<span>  <span class="va">na_model</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/fortify.html">fortify</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="st">"cumhaz"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># `fortify.survfit()` doesn't name cumhaz correctly:</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>cumhaz <span class="op">=</span> <span class="va">surv</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    surv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">cumhaz</span><span class="op">)</span>,</span>
<span>    strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/trimws.html">trimws</a></span><span class="op">(</span><span class="va">strata</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"Nelson-Aalen"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="fu">stack_surv_ph</span><span class="op">(</span><span class="va">cox_model</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">na_and_cph</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">time</span>, </span>
<span>      y <span class="op">=</span> <span class="va">cumhaz</span>, </span>
<span>      col <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_step</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">strata</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    trans <span class="op">=</span> <span class="st">"log10"</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Cumulative hazard, H(t) (log-scale)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span></span>
<span>    trans <span class="op">=</span> <span class="st">"log10"</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Survival time (t, days, log-scale)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-bmt-cumhaz" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-bmt-cumhaz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.10: Observed and expected cumulative hazard curves for <code>bmt</code> data (cloglog format)
</figcaption><div aria-describedby="fig-bmt-cumhaz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="proportional-hazards-models_files/figure-html/fig-bmt-cumhaz-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11" title="Figure&nbsp;7.10: Observed and expected cumulative hazard curves for bmt data (cloglog format)"><img src="proportional-hazards-models_files/figure-html/fig-bmt-cumhaz-1.png" class="img-fluid figure-img" width="672"></a>
</div>
</figure>
</div>
</div>
</div>
</section></section><section id="predictions-and-residuals" class="level2" data-number="7.9"><h2 data-number="7.9" class="anchored" data-anchor-id="predictions-and-residuals">
<span class="header-section-number">7.9</span> Predictions and Residuals</h2>
<section id="review-predictions-in-linear-regression" class="level3" data-number="7.9.1"><h3 data-number="7.9.1" class="anchored" data-anchor-id="review-predictions-in-linear-regression">
<span class="header-section-number">7.9.1</span> Review: Predictions in Linear Regression</h3>
<ul>
<li>In linear regression, we have a linear predictor for each data point <span class="math inline">\(i\)</span>
</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
\eta_i &amp;= \beta_0+\beta_1x_{1i}+\cdots+\beta_px_{pi}\\
\hat y_i &amp;=\hat\eta_i = \hat\beta_0+\hat\beta_1x_{1i}+\cdots+\hat\beta_px_{pi}\\
y_i &amp;\sim N(\eta_i,\sigma^2)
\end{aligned}
\]</span></p>
<ul>
<li>
<span class="math inline">\(\hat y_i\)</span> estimates the conditional mean of <span class="math inline">\(y_i\)</span> given the covariate values <span class="math inline">\(\tilde{x}_i\)</span>. This together with the prediction error says that we are predicting the distribution of values of <span class="math inline">\(y\)</span>.</li>
</ul></section><section id="review-residuals-in-linear-regression" class="level3" data-number="7.9.2"><h3 data-number="7.9.2" class="anchored" data-anchor-id="review-residuals-in-linear-regression">
<span class="header-section-number">7.9.2</span> Review: Residuals in Linear Regression</h3>
<ul>
<li>The usual residual is <span class="math inline">\(r_i=y_i-\hat y_i\)</span>, the difference between the actual value of <span class="math inline">\(y\)</span> and a prediction of its mean.</li>
<li>The residuals are also the quantities the sum of whose squares is being minimized by the least squares/MLE estimation.</li>
</ul></section><section id="predictions-and-residuals-in-survival-models" class="level3" data-number="7.9.3"><h3 data-number="7.9.3" class="anchored" data-anchor-id="predictions-and-residuals-in-survival-models">
<span class="header-section-number">7.9.3</span> Predictions and Residuals in survival models</h3>
<ul>
<li>In survival analysis, the equivalent of <span class="math inline">\(y_i\)</span> is the event time <span class="math inline">\(t_i\)</span>, which is unknown for the censored observations.</li>
<li>The expected event time can be tricky to calculate:</li>
</ul>
<p><span class="math display">\[
\hat{\text{E}}[T|X=x] = \int_{t=0}^{\infty} \hat{\text{S}}(t)dt
\]</span></p>
</section><section id="wide-prediction-intervals" class="level3" data-number="7.9.4"><h3 data-number="7.9.4" class="anchored" data-anchor-id="wide-prediction-intervals">
<span class="header-section-number">7.9.4</span> Wide prediction intervals</h3>
<p>The nature of time-to-event data results in very wide prediction intervals:</p>
<ul>
<li>Suppose a cancer patient is predicted to have a mean lifetime of 5 years after diagnosis and suppose the distribution is exponential.</li>
<li>If we want a 95% interval for survival, the lower end is at the 0.025 percentage point of the exponential which is <code>qexp(.025, rate = 1/5)</code> = 0.126589 years, or 1/40 of the mean lifetime.</li>
<li>The upper end is at the 0.975 point which is <code>qexp(.975, rate = 1/5)</code> = 18.444397 years, or 3.7 times the mean lifetime.</li>
<li>Saying that the survival time is somewhere between 6 weeks and 18 years does not seem very useful, but it may be the best we can do.</li>
<li>For survival analysis, something is like a residual if it is small when the model is accurate or if the accumulation of them is in some way minimized by the estimation algorithm, but there is no exact equivalence to linear regression residuals.</li>
<li>And if there is, they are mostly quite large!</li>
</ul></section><section id="types-of-residuals-in-time-to-event-models" class="level3" data-number="7.9.5"><h3 data-number="7.9.5" class="anchored" data-anchor-id="types-of-residuals-in-time-to-event-models">
<span class="header-section-number">7.9.5</span> Types of Residuals in Time-to-Event Models</h3>
<ul>
<li>It is often hard to make a decision from graph appearances, though the process can reveal much.</li>
<li>Some diagnostic tests are based on residuals as with other regression methods:
<ul>
<li>
<strong>Schoenfeld residuals</strong> (via <code>cox.zph</code>) for proportionality</li>
<li>
<strong>Cox-Snell residuals</strong> for goodness of fit (<a href="#sec-cox-snell" class="quarto-xref"><span>Section 7.10</span></a>)</li>
<li>
<strong>martingale residuals</strong> for non-linearity</li>
<li>
<strong>dfbeta</strong> for influence.</li>
</ul>
</li>
</ul></section><section id="schoenfeld-residuals" class="level3" data-number="7.9.6"><h3 data-number="7.9.6" class="anchored" data-anchor-id="schoenfeld-residuals">
<span class="header-section-number">7.9.6</span> Schoenfeld residuals</h3>
<ul>
<li><p>There is a Schoenfeld residual for each subject <span class="math inline">\(i\)</span> with an event (not censored) and for each predictor <span class="math inline">\(x_{k}\)</span>.</p></li>
<li><p>At the event time <span class="math inline">\(t\)</span> for that subject, there is a risk set <span class="math inline">\(R\)</span>, and each subject <span class="math inline">\(j\)</span> in the risk set has a risk coefficient <span class="math inline">\(\theta_j\)</span> and also a value <span class="math inline">\(x_{jk}\)</span> of the predictor.</p></li>
<li><p>The Schoenfeld residual is the difference between <span class="math inline">\(x_{ik}\)</span> and the risk-weighted average of all the <span class="math inline">\(x_{jk}\)</span> over the risk set.</p></li>
</ul>
<p><span class="math display">\[
r^S_{ik} =
x_{ik}-\frac{\sum_{k\in R}x_{jk}\theta_k}{\sum_{k\in R}\theta_k}
\]</span></p>
<p>This residual measures how typical the individual subject is with respect to the covariate at the time of the event. Since subjects should fail more or less uniformly according to risk, the Schoenfeld residuals should be approximately level over time, not increasing or decreasing.</p>
<p>We can test this with the correlation with time on some scale, which could be the time itself, the log time, or the rank in the set of failure times.</p>
<p>The default is to use the KM curve as a transform, which is similar to the rank but deals better with censoring.</p>
<p>The <code><a href="https://rdrr.io/pkg/survival/man/cox.zph.html">cox.zph()</a></code> function implements a score test proposed in <span class="citation" data-cites="grambsch1994proportional">Grambsch and Therneau (<a href="references.html#ref-grambsch1994proportional" role="doc-biblioref">1994</a>)</span>.</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="va">hodg.zph</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/cox.zph.html">cox.zph</a></span><span class="op">(</span><span class="va">hodg.cox1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">hodg.zph</span><span class="op">)</span></span>
<span><span class="co">#&gt;               chisq df     p</span></span>
<span><span class="co">#&gt; gtype        0.5400  1 0.462</span></span>
<span><span class="co">#&gt; dtype        1.8012  1 0.180</span></span>
<span><span class="co">#&gt; score        3.8805  1 0.049</span></span>
<span><span class="co">#&gt; wtime        0.0173  1 0.895</span></span>
<span><span class="co">#&gt; gtype:dtype  4.0474  1 0.044</span></span>
<span><span class="co">#&gt; GLOBAL      13.7573  5 0.017</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="gtype" class="level4"><h4 class="anchored" data-anchor-id="gtype"><code>gtype</code></h4>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggcoxzph.html">ggcoxzph</a></span><span class="op">(</span><span class="va">hodg.zph</span>, var <span class="op">=</span> <span class="st">"gtype"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-8-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="dtype" class="level4"><h4 class="anchored" data-anchor-id="dtype"><code>dtype</code></h4>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggcoxzph.html">ggcoxzph</a></span><span class="op">(</span><span class="va">hodg.zph</span>, var <span class="op">=</span> <span class="st">"dtype"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-9-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="score" class="level4"><h4 class="anchored" data-anchor-id="score"><code>score</code></h4>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggcoxzph.html">ggcoxzph</a></span><span class="op">(</span><span class="va">hodg.zph</span>, var <span class="op">=</span> <span class="st">"score"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-10-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="wtime" class="level4"><h4 class="anchored" data-anchor-id="wtime"><code>wtime</code></h4>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggcoxzph.html">ggcoxzph</a></span><span class="op">(</span><span class="va">hodg.zph</span>, var <span class="op">=</span> <span class="st">"wtime"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-11-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="gtypedtype" class="level4"><h4 class="anchored" data-anchor-id="gtypedtype"><code>gtype:dtype</code></h4>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggcoxzph.html">ggcoxzph</a></span><span class="op">(</span><span class="va">hodg.zph</span>, var <span class="op">=</span> <span class="st">"gtype:dtype"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-12-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="conclusions" class="level4"><h4 class="anchored" data-anchor-id="conclusions">Conclusions</h4>
<ul>
<li>From the correlation test, the Karnofsky score and the interaction with graft type disease type induce modest but statistically significant non-proportionality.</li>
<li>The sample size here is relatively small (26 events in 43 subjects). If the sample size is large, very small amounts of non-proportionality can induce a significant result.</li>
<li>As time goes on, autologous grafts are over-represented at their own event times, but those from HOD patients become less represented.</li>
<li>Both the statistical tests and the plots are useful.</li>
</ul></section></section></section><section id="sec-cox-snell" class="level2" data-number="7.10"><h2 data-number="7.10" class="anchored" data-anchor-id="sec-cox-snell">
<span class="header-section-number">7.10</span> Goodness of Fit using the Cox-Snell Residuals</h2>
<p>(references: <span class="citation" data-cites="klein2003survival">Klein and Moeschberger (<a href="references.html#ref-klein2003survival" role="doc-biblioref">2003</a>)</span>, §11.2, and <span class="citation" data-cites="dobson4e">Dobson and Barnett (<a href="references.html#ref-dobson4e" role="doc-biblioref">2018</a>)</span>, §10.6)</p>
<hr>
<div class="notes">
<p>Suppose that an individual has a survival time <span class="math inline">\(T\)</span> which has survival function <span class="math inline">\(\text{S}(t)\)</span>, meaning that <span class="math inline">\(\Pr(T&gt; t) = \text{S}(t)\)</span>. Then <span class="math inline">\(S(T)\)</span> has a uniform distribution on <span class="math inline">\((0,1)\)</span>:</p>
</div>
<p><span class="math display">\[
\begin{aligned}
\Pr(S(T_i) \le u)
&amp;= \Pr(T_i &gt; S_i^{-1}(u))\\
&amp;= S_i(S_i^{-1}(u))\\
&amp;= u
\end{aligned}
\]</span></p>
<hr>
<div class="notes">
<p>Also, if <span class="math inline">\(U\)</span> has a uniform distribution on <span class="math inline">\((0,1)\)</span>, then what is the distribution of <span class="math inline">\(-\ln(U)\)</span>?</p>
</div>
<hr>
<p><span class="math display">\[
\begin{aligned}
\Pr(-\ln(U) &lt; x) &amp;= \Pr(U&gt;\text{exp}{\left\{-x\right\}})\\
&amp;= 1-e^{-x}
\end{aligned}
\]</span></p>
<div class="notes">
<p>which is the CDF of an exponential distribution with parameter <span class="math inline">\(\lambda=1\)</span>.</p>
</div>
<hr>
<div id="def-CS-resid" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 7.13 (Cox-Snell generalized residuals)</strong></span> &nbsp;</p>
<div class="notes">
<p>The <strong>Cox-Snell generalized residuals</strong> are defined as:</p>
</div>
<p><span class="math display">\[
r^{CS}_i \stackrel{\text{def}}{=}\hat {\Lambda}(t_i|\tilde{x}_i)
\]</span></p>
</div>
<div class="notes">
<p>If the estimate <span class="math inline">\(\hat S_i\)</span> is accurate, <span class="math inline">\(r^{CS}_i\)</span> should have an exponential distribution with constant hazard <span class="math inline">\(\lambda=1\)</span>, which means that these values should look like a censored sample from this exponential distribution.</p>
</div>
<hr>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg2</span> <span class="op">=</span> <span class="va">hodg2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">hodg.cox1</span>, type <span class="op">=</span> <span class="st">"expected"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">surv.csr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">hodg2</span>,</span>
<span>  formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">cs</span>, event <span class="op">=</span> <span class="va">delta</span> <span class="op">==</span> <span class="st">"dead"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"fleming-harrington"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">surv.csr</span>, fun <span class="op">=</span> <span class="st">"cumhaz"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cox-snell-cuhaz-hodg2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-cox-snell-cuhaz-hodg2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.11: Cumulative Hazard of Cox-Snell Residuals
</figcaption><div aria-describedby="fig-cox-snell-cuhaz-hodg2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="proportional-hazards-models_files/figure-html/fig-cox-snell-cuhaz-hodg2-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17" title="Figure&nbsp;7.11: Cumulative Hazard of Cox-Snell Residuals"><img src="proportional-hazards-models_files/figure-html/fig-cox-snell-cuhaz-hodg2-1.png" class="img-fluid figure-img" width="672"></a>
</div>
</figure>
</div>
</div>
</div>
<p>The line with slope 1 and intercept 0 fits the curve relatively well, so we don’t see lack of fit using this procedure.</p>
</section><section id="martingale-residuals" class="level2" data-number="7.11"><h2 data-number="7.11" class="anchored" data-anchor-id="martingale-residuals">
<span class="header-section-number">7.11</span> Martingale Residuals</h2>
<p>The <strong>martingale residuals</strong> are a slight modification of the Cox-Snell residuals. If the censoring indicator is <span class="math inline">\(\delta_i\)</span>, then <span class="math display">\[r^M_i=\delta_i-r^{CS}_i\]</span> These residuals can be interpreted as an estimate of the excess number of events seen in the data but not predicted by the model. We will use these to examine the functional forms of continuous covariates.</p>
<section id="using-martingale-residuals" class="level3" data-number="7.11.1"><h3 data-number="7.11.1" class="anchored" data-anchor-id="using-martingale-residuals">
<span class="header-section-number">7.11.1</span> Using Martingale Residuals</h3>
<p>Martingale residuals can be used to examine the functional form of a numeric variable.</p>
<ul>
<li>We fit the model without that variable and compute the martingale residuals.</li>
<li>We then plot these martingale residuals against the values of the variable.</li>
<li>We can see curvature, or a possible suggestion that the variable can be discretized.</li>
</ul>
<p>Let’s use this to examine the <code>score</code> and <code>wtime</code> variables in the <code>wtime</code> data set.</p>
<section id="karnofsky-score" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="karnofsky-score">Karnofsky score</h4>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg2</span> <span class="op">=</span> <span class="va">hodg2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    mres <span class="op">=</span> </span>
<span>      <span class="va">hodg.cox1</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">score</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"martingale"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hodg2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">score</span>, y <span class="op">=</span> <span class="va">mres</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"loess"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'lm'</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Karnofsky Score"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Martingale Residuals"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>col<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption>Martingale Residuals vs.&nbsp;Karnofsky Score</figcaption><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-13-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18" title="Martingale Residuals vs.&nbsp;Karnofsky Score"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672" alt="Martingale Residuals vs.&nbsp;Karnofsky Score"></a></p>
</figure>
</div>
</div>
</div>
<p>The line is almost straight. It could be some modest transformation of the Karnofsky score would help, but it might not make much difference.</p>
</section><section id="waiting-time" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="waiting-time">Waiting time</h4>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg2</span><span class="op">$</span><span class="va">mres</span> <span class="op">=</span> </span>
<span>  <span class="va">hodg.cox1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">wtime</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"martingale"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hodg2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">wtime</span>, y <span class="op">=</span> <span class="va">mres</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"loess"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'lm'</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Waiting Time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Martingale Residuals"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>col<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption>Martingale Residuals vs.&nbsp;Waiting Time</figcaption><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-14-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-19" title="Martingale Residuals vs.&nbsp;Waiting Time"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672" alt="Martingale Residuals vs.&nbsp;Waiting Time"></a></p>
</figure>
</div>
</div>
</div>
<p>The line could suggest a step function. To see where the drop is, we can look at the largest waiting times and the associated martingale residual.</p>
<p>The martingale residuals are all negative for <code>wtime</code> &gt;83 and positive for the next smallest value. A reasonable cut-point is 80 days.</p>
</section><section id="updating-the-model" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="updating-the-model">Updating the model</h4>
<p>Let’s reformulate the model with dichotomized <code>wtime</code>.</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg2</span> <span class="op">=</span> </span>
<span>  <span class="va">hodg2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    wt2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span></span>
<span>      <span class="va">wtime</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">200</span><span class="op">)</span>,</span>
<span>      labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"short"</span>,<span class="st">"long"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hodg.cox2</span> <span class="op">=</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, event <span class="op">=</span> <span class="va">delta</span> <span class="op">==</span> <span class="st">"dead"</span><span class="op">)</span> <span class="op">~</span> </span>
<span>      <span class="va">gtype</span><span class="op">*</span><span class="va">dtype</span> <span class="op">+</span> <span class="va">score</span> <span class="op">+</span> <span class="va">wt2</span>,</span>
<span>    data <span class="op">=</span> <span class="va">hodg2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-tbl-cap="Model summary table with waiting time on continuous scale">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg.cox1</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/add1.html">drop1</a></span><span class="op">(</span>test<span class="op">=</span><span class="st">"Chisq"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div data-pagedtable="false"> <div class="table-caption"><p>Model summary table with waiting time on continuous scale</p></div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Df"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["AIC"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["LRT"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Pr(>Chi)"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"NA","2":"152.363","3":"NA","4":"NA","_rn_":"<none>"},{"1":"1","2":"167.599","3":"17.23654","4":"3.30027e-05","_rn_":"score"},{"1":"1","2":"153.642","3":"3.27921","4":"7.01625e-02","_rn_":"wtime"},{"1":"1","2":"155.799","3":"5.43571","4":"1.97291e-02","_rn_":"gtype:dtype"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell" data-tbl-cap="Model summary table with dichotomized waiting time">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg.cox2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/add1.html">drop1</a></span><span class="op">(</span>test<span class="op">=</span><span class="st">"Chisq"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div data-pagedtable="false"> <div class="table-caption"><p>Model summary table with dichotomized waiting time</p></div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Df"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["AIC"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["LRT"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Pr(>Chi)"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"NA","2":"149.034","3":"NA","4":"NA","_rn_":"<none>"},{"1":"1","2":"168.638","3":"21.60424","4":"3.35111e-06","_rn_":"score"},{"1":"1","2":"153.642","3":"6.60805","4":"1.01519e-02","_rn_":"wt2"},{"1":"1","2":"152.004","3":"4.96967","4":"2.57956e-02","_rn_":"gtype:dtype"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>The new model has better (lower) AIC.</p>
</section></section></section><section id="checking-for-outliers-and-influential-observations" class="level2" data-number="7.12"><h2 data-number="7.12" class="anchored" data-anchor-id="checking-for-outliers-and-influential-observations">
<span class="header-section-number">7.12</span> Checking for Outliers and Influential Observations</h2>
<p>We will check for outliers using the deviance residuals. The martingale residuals show excess events or the opposite, but highly skewed, with the maximum possible value being 1, but the smallest value can be very large negative. Martingale residuals can detect unexpectedly long-lived patients, but patients who die unexpectedly early show up only in the deviance residual. Influence will be examined using dfbeta in a similar way to linear regression, logistic regression, or Poisson regression.</p>
<section id="deviance-residuals" class="level3" data-number="7.12.1"><h3 data-number="7.12.1" class="anchored" data-anchor-id="deviance-residuals">
<span class="header-section-number">7.12.1</span> Deviance Residuals</h3>
<p><span class="math display">\[
\begin{aligned}
r_i^D &amp;= \textrm{sign}(r_i^M)\sqrt{-2\left[ r_i^M+\delta_i\ln(\delta_i-r_i^M)  \right]}\\
r_i^D &amp;= \textrm{sign}(r_i^M)\sqrt{-2\left[ r_i^M+\delta_i\ln(r_i^{CS})  \right]}
\end{aligned}
\]</span></p>
<p>Roughly centered on 0 with approximate standard deviation 1.</p>
</section><section id="section" class="level3" data-number="7.12.2"><h3 data-number="7.12.2" class="anchored" data-anchor-id="section">
<span class="header-section-number">7.12.2</span> </h3>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg.mart</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">hodg.cox2</span>,type<span class="op">=</span><span class="st">"martingale"</span><span class="op">)</span></span>
<span><span class="va">hodg.dev</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">hodg.cox2</span>,type<span class="op">=</span><span class="st">"deviance"</span><span class="op">)</span></span>
<span><span class="va">hodg.dfb</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">hodg.cox2</span>,type<span class="op">=</span><span class="st">"dfbeta"</span><span class="op">)</span></span>
<span><span class="va">hodg.preds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">hodg.cox2</span><span class="op">)</span>                   <span class="co">#linear predictor</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hodg.preds</span>,</span>
<span>     <span class="va">hodg.mart</span>,</span>
<span>     xlab<span class="op">=</span><span class="st">"Linear Predictor"</span>,</span>
<span>     ylab<span class="op">=</span><span class="st">"Martingale Residual"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption>Martingale Residuals vs.&nbsp;Linear Predictor</figcaption><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-19-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-20" title="Martingale Residuals vs.&nbsp;Linear Predictor"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672" alt="Martingale Residuals vs.&nbsp;Linear Predictor"></a></p>
</figure>
</div>
</div>
</div>
<p>The smallest three martingale residuals in order are observations 1, 29, and 18.</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hodg.preds</span>,<span class="va">hodg.dev</span>,xlab<span class="op">=</span><span class="st">"Linear Predictor"</span>,ylab<span class="op">=</span><span class="st">"Deviance Residual"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption>Deviance Residuals vs.&nbsp;Linear Predictor</figcaption><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-20-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-21" title="Deviance Residuals vs.&nbsp;Linear Predictor"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672" alt="Deviance Residuals vs.&nbsp;Linear Predictor"></a></p>
</figure>
</div>
</div>
</div>
<p>The two largest deviance residuals are observations 1 and 29. Worth examining.</p>
</section><section id="dfbeta" class="level3" data-number="7.12.3"><h3 data-number="7.12.3" class="anchored" data-anchor-id="dfbeta">
<span class="header-section-number">7.12.3</span> dfbeta</h3>
<ul>
<li><p>dfbeta is the approximate change in the coefficient vector if that observation were dropped</p></li>
<li><p>dfbetas is the approximate change in the coefficients, scaled by the standard error for the coefficients.</p></li>
</ul>
<section id="graft-type" class="level4"><h4 class="anchored" data-anchor-id="graft-type">Graft type</h4>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hodg.dfb</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,xlab<span class="op">=</span><span class="st">"Observation Order"</span>,ylab<span class="op">=</span><span class="st">"dfbeta for Graft Type"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption>dfbeta Values by Observation Order for Graft Type</figcaption><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-21-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-22" title="dfbeta Values by Observation Order for Graft Type"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672" alt="dfbeta Values by Observation Order for Graft Type"></a></p>
</figure>
</div>
</div>
</div>
<p>The smallest dfbeta for graft type is observation 1.</p>
</section><section id="disease-type" class="level4"><h4 class="anchored" data-anchor-id="disease-type">Disease type</h4>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hodg.dfb</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,</span>
<span>     xlab<span class="op">=</span><span class="st">"Observation Order"</span>,</span>
<span>     ylab<span class="op">=</span><span class="st">"dfbeta for Disease Type"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption>dfbeta Values by Observation Order for Disease Type</figcaption><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-22-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-23" title="dfbeta Values by Observation Order for Disease Type"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672" alt="dfbeta Values by Observation Order for Disease Type"></a></p>
</figure>
</div>
</div>
</div>
<p>The smallest two dfbeta values for disease type are observations 1 and 16.</p>
</section><section id="karnofsky-score-1" class="level4"><h4 class="anchored" data-anchor-id="karnofsky-score-1">Karnofsky score</h4>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hodg.dfb</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>,</span>
<span>     xlab<span class="op">=</span><span class="st">"Observation Order"</span>,</span>
<span>     ylab<span class="op">=</span><span class="st">"dfbeta for Karnofsky Score"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption>dfbeta Values by Observation Order for Karnofsky Score</figcaption><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-23-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-24" title="dfbeta Values by Observation Order for Karnofsky Score"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672" alt="dfbeta Values by Observation Order for Karnofsky Score"></a></p>
</figure>
</div>
</div>
</div>
<p>The two highest dfbeta values for score are observations 1 and 18. The next three are observations 17, 29, and 19. The smallest value is observation 2.</p>
</section><section id="waiting-time-dichotomized" class="level4"><h4 class="anchored" data-anchor-id="waiting-time-dichotomized">Waiting time (dichotomized)</h4>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">hodg.dfb</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span>,</span>
<span>  xlab<span class="op">=</span><span class="st">"Observation Order"</span>,</span>
<span>  ylab<span class="op">=</span><span class="st">"dfbeta for `Waiting Time &lt; 80`"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption>dfbeta Values by Observation Order for Waiting Time (dichotomized)</figcaption><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-24-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-25" title="dfbeta Values by Observation Order for Waiting Time (dichotomized)"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672" alt="dfbeta Values by Observation Order for Waiting Time (dichotomized)"></a></p>
</figure>
</div>
</div>
</div>
<p>The two large values of dfbeta for dichotomized waiting time are observations 15 and 16. This may have to do with the discretization of waiting time.</p>
</section><section id="interaction-graft-type-and-disease-type" class="level4"><h4 class="anchored" data-anchor-id="interaction-graft-type-and-disease-type">Interaction: graft type and disease type</h4>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hodg.dfb</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span>,</span>
<span>     xlab<span class="op">=</span><span class="st">"Observation Order"</span>,</span>
<span>     ylab<span class="op">=</span><span class="st">"dfbeta for dtype:gtype"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption>dfbeta Values by Observation Order for dtype:gtype</figcaption><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-25-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-26" title="dfbeta Values by Observation Order for dtype:gtype"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672" alt="dfbeta Values by Observation Order for dtype:gtype"></a></p>
</figure>
</div>
</div>
</div>
<p>The two largest values are observations 1 and 16. The smallest value is observation 35.</p>
<div id="tbl-obs-to-examine" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-obs-to-examine-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7.2: Observations to Examine by Residuals and Influence
</figcaption><div aria-describedby="tbl-obs-to-examine-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<thead><tr class="header">
<th>Diagnostic</th>
<th>Observations to Examine</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Martingale Residuals</td>
<td>1, 29, 18</td>
</tr>
<tr class="even">
<td>Deviance Residuals</td>
<td>1, 29</td>
</tr>
<tr class="odd">
<td>Graft Type Influence</td>
<td>1</td>
</tr>
<tr class="even">
<td>Disease Type Influence</td>
<td>1, 16</td>
</tr>
<tr class="odd">
<td>Karnofsky Score Influence</td>
<td>1, 18 (17, 29, 19)</td>
</tr>
<tr class="even">
<td>Waiting Time Influence</td>
<td>15, 16</td>
</tr>
<tr class="odd">
<td>Graft by Disease Influence</td>
<td>1, 16, 35</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>The most important observations to examine seem to be 1, 15, 16, 18, and 29.</p>
</section></section><section id="section-1" class="level3" data-number="7.12.4"><h3 data-number="7.12.4" class="anchored" data-anchor-id="section-1">
<span class="header-section-number">7.12.4</span> </h3>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">hodg</span>,<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">time</span><span class="op">[</span><span class="va">delta</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;     2.0    41.2    62.5    97.6    83.2   524.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">hodg</span>,<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">wtime</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;     5.0    16.0    24.0    37.7    55.5   171.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">hodg</span>,<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">score</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;    20.0    60.0    80.0    76.3    90.0   100.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg.cox2</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = Surv(time, event = delta == "dead") ~ gtype * </span></span>
<span><span class="co">#&gt;     dtype + score + wt2, data = hodg2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                                  coef exp(coef) se(coef)     z       p</span></span>
<span><span class="co">#&gt; gtypeAutologous                0.6651    1.9447   0.5943  1.12  0.2631</span></span>
<span><span class="co">#&gt; dtypeHodgkins                  2.3273   10.2505   0.7332  3.17  0.0015</span></span>
<span><span class="co">#&gt; score                         -0.0550    0.9464   0.0123 -4.46 8.2e-06</span></span>
<span><span class="co">#&gt; wt2long                       -2.0598    0.1275   1.0507 -1.96  0.0499</span></span>
<span><span class="co">#&gt; gtypeAutologous:dtypeHodgkins -2.0668    0.1266   0.9258 -2.23  0.0256</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Likelihood ratio test=35.5  on 5 df, p=1.21e-06</span></span>
<span><span class="co">#&gt; n= 43, number of events= 26</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">15</span>,<span class="fl">16</span>,<span class="fl">18</span>,<span class="fl">29</span><span class="op">)</span>,<span class="op">]</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">gtype</span>, <span class="va">dtype</span>, <span class="va">time</span>, <span class="va">delta</span>, <span class="va">score</span>, <span class="va">wtime</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    comment <span class="op">=</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"early death, good score, low risk"</span>,</span>
<span>        <span class="st">"high risk grp, long wait, poor score"</span>,</span>
<span>        <span class="st">"high risk grp, short wait, poor score"</span>,</span>
<span>        <span class="st">"early death, good score, med risk grp"</span>,</span>
<span>        <span class="st">"early death, good score, med risk grp"</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["gtype"],"name":[1],"type":["chr"],"align":["left"]},{"label":["dtype"],"name":[2],"type":["fct"],"align":["left"]},{"label":["time"],"name":[3],"type":["int"],"align":["right"]},{"label":["delta"],"name":[4],"type":["chr"],"align":["left"]},{"label":["score"],"name":[5],"type":["int"],"align":["right"]},{"label":["wtime"],"name":[6],"type":["int"],"align":["right"]},{"label":["comment"],"name":[7],"type":["chr"],"align":["left"]}],"data":[{"1":"Allogenic","2":"Non-Hodgkins","3":"28","4":"dead","5":"90","6":"24","7":"early death, good score, low risk"},{"1":"Allogenic","2":"Hodgkins","3":"77","4":"dead","5":"60","6":"102","7":"high risk grp, long wait, poor score"},{"1":"Allogenic","2":"Hodgkins","3":"79","4":"dead","5":"70","6":"71","7":"high risk grp, short wait, poor score"},{"1":"Autologous","2":"Non-Hodgkins","3":"53","4":"dead","5":"90","6":"17","7":"early death, good score, med risk grp"},{"1":"Autologous","2":"Hodgkins","3":"30","4":"dead","5":"90","6":"73","7":"early death, good score, med risk grp"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section><section id="action-items" class="level3" data-number="7.12.5"><h3 data-number="7.12.5" class="anchored" data-anchor-id="action-items">
<span class="header-section-number">7.12.5</span> Action Items</h3>
<ul>
<li>Unusual points may need checking, particularly if the data are not completely cleaned. In this case, observations 15 and 16 may show some trouble with the dichotomization of waiting time, but it still may be useful.</li>
<li>The two largest residuals seem to be due to unexpectedly early deaths, but unfortunately this can occur.</li>
<li>If hazards don’t look proportional, then we may need to use strata, between which the base hazards are permitted to be different. For this problem, the natural strata are the two diseases, because they could need to be managed differently anyway.</li>
<li>A main point that we want to be sure of is the relative risk difference by disease type and graft type.</li>
</ul>
<div class="cell" data-tbl-cap="Linear Risk Predictors for Lymphoma">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hodg.cox2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span></span>
<span>    reference <span class="op">=</span> <span class="st">"zero"</span>,</span>
<span>    newdata <span class="op">=</span> <span class="va">means</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        wt2 <span class="op">=</span> <span class="st">"short"</span>, </span>
<span>        score <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>    type <span class="op">=</span> <span class="st">"lp"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="st">'linear predictor'</span> <span class="op">=</span> <span class="va">_</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/pander/man/pander.html">pander</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Linear Risk Predictors for Lymphoma</caption>
<colgroup>
<col style="width: 36%">
<col style="width: 26%">
</colgroup>
<thead><tr class="header">
<th style="text-align: center;">&nbsp;</th>
<th style="text-align: center;">linear.predictor</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Non-Hodgkins,Allogenic</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="even">
<td style="text-align: center;">Non-Hodgkins,Autologous</td>
<td style="text-align: center;">0.6651</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Hodgkins,Allogenic</td>
<td style="text-align: center;">2.327</td>
</tr>
<tr class="even">
<td style="text-align: center;">Hodgkins,Autologous</td>
<td style="text-align: center;">0.9256</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>For Non-Hodgkin’s, the allogenic graft is better. For Hodgkin’s, the autologous graft is much better.</p>
</section></section><section id="stratified-survival-models" class="level2" data-number="7.13"><h2 data-number="7.13" class="anchored" data-anchor-id="stratified-survival-models">
<span class="header-section-number">7.13</span> Stratified survival models</h2>
<section id="revisiting-the-leukemia-dataset-anderson" class="level3" data-number="7.13.1"><h3 data-number="7.13.1" class="anchored" data-anchor-id="revisiting-the-leukemia-dataset-anderson">
<span class="header-section-number">7.13.1</span> Revisiting the leukemia dataset (<code>anderson</code>)</h3>
<p>We will analyze remission survival times on 42 leukemia patients, half on new treatment, half on standard treatment.</p>
<p>This is the same data as the <code>drug6mp</code> data from <code>KMsurv</code>, but with two other variables and without the pairing. This version comes from <span class="citation" data-cites="kleinbaum2012survival">Kleinbaum and Klein (<a href="references.html#ref-kleinbaum2012survival" role="doc-biblioref">2012</a>)</span> (e.g., p281):</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="va">anderson</span> <span class="op">=</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"http://web1.sph.emory.edu/dkleinb/allDatasets/"</span>,</span>
<span>    <span class="st">"surv2datasets/anderson.dta"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">haven</span><span class="fu">::</span><span class="fu"><a href="https://haven.tidyverse.org/reference/read_dta.html">read_dta</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    status <span class="op">=</span> <span class="va">status</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"relapse"</span>,</span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"censored"</span></span>
<span>      <span class="op">)</span>,</span>
<span>    </span>
<span>    sex <span class="op">=</span> <span class="va">sex</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"female"</span>,</span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"male"</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span>ref <span class="op">=</span> <span class="st">"female"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    rx <span class="op">=</span> <span class="va">rx</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"new"</span>,</span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"standard"</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span>ref <span class="op">=</span> <span class="st">"standard"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    surv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span></span>
<span>      time <span class="op">=</span> <span class="va">survt</span>, </span>
<span>      event <span class="op">=</span> <span class="op">(</span><span class="va">status</span> <span class="op">==</span> <span class="st">"relapse"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">anderson</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="cox-semi-parametric-proportional-hazards-model" class="level3" data-number="7.13.2"><h3 data-number="7.13.2" class="anchored" data-anchor-id="cox-semi-parametric-proportional-hazards-model">
<span class="header-section-number">7.13.2</span> Cox semi-parametric proportional hazards model</h3>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="va">anderson.cox1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">rx</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">logwbc</span>,</span>
<span>  data <span class="op">=</span> <span class="va">anderson</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">anderson.cox1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = surv ~ rx + sex + logwbc, data = anderson)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 42, number of events= 30 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           coef exp(coef) se(coef)     z Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; rxnew   -1.504     0.222    0.462 -3.26   0.0011 ** </span></span>
<span><span class="co">#&gt; sexmale  0.315     1.370    0.455  0.69   0.4887    </span></span>
<span><span class="co">#&gt; logwbc   1.682     5.376    0.337  5.00  5.8e-07 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; rxnew       0.222      4.498     0.090     0.549</span></span>
<span><span class="co">#&gt; sexmale     1.370      0.730     0.562     3.338</span></span>
<span><span class="co">#&gt; logwbc      5.376      0.186     2.779    10.398</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.851  (se = 0.041 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 47.2  on 3 df,   p=3e-10</span></span>
<span><span class="co">#&gt; Wald test            = 33.5  on 3 df,   p=2e-07</span></span>
<span><span class="co">#&gt; Score (logrank) test = 48  on 3 df,   p=2e-10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="test-the-proportional-hazards-assumption" class="level4"><h4 class="anchored" data-anchor-id="test-the-proportional-hazards-assumption">Test the proportional hazards assumption</h4>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/cox.zph.html">cox.zph</a></span><span class="op">(</span><span class="va">anderson.cox1</span><span class="op">)</span></span>
<span><span class="co">#&gt;        chisq df    p</span></span>
<span><span class="co">#&gt; rx     0.036  1 0.85</span></span>
<span><span class="co">#&gt; sex    5.420  1 0.02</span></span>
<span><span class="co">#&gt; logwbc 0.142  1 0.71</span></span>
<span><span class="co">#&gt; GLOBAL 5.879  3 0.12</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="graph-the-k-m-survival-curves" class="level4"><h4 class="anchored" data-anchor-id="graph-the-k-m-survival-curves">Graph the K-M survival curves</h4>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="va">anderson_km_model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">sex</span>,</span>
<span>  data <span class="op">=</span> <span class="va">anderson</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anderson_km_model</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span>conf.int <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-36-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-27"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>The survival curves cross, which indicates a problem in the proportionality assumption by sex.</p>
</section></section><section id="graph-the-nelson-aalen-cumulative-hazard" class="level3" data-number="7.13.3"><h3 data-number="7.13.3" class="anchored" data-anchor-id="graph-the-nelson-aalen-cumulative-hazard">
<span class="header-section-number">7.13.3</span> Graph the Nelson-Aalen cumulative hazard</h3>
<p>We can also look at the log-hazard (“cloglog survival”) plots:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anderson_na_model</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">sex</span>,</span>
<span>  data <span class="op">=</span> <span class="va">anderson</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"fleming"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anderson_na_model</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span></span>
<span>    fun <span class="op">=</span> <span class="st">"cumhaz"</span>,</span>
<span>    conf.int <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"log(Cumulative Hazard)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    trans <span class="op">=</span> <span class="st">"log10"</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Cumulative hazard (H(t), log scale)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">5</span>,<span class="fl">10</span>,<span class="fl">20</span>,<span class="fl">50</span><span class="op">)</span>,</span>
<span>    trans <span class="op">=</span> <span class="st">"log"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cuhaz-anderson" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-cuhaz-anderson-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.12: Cumulative hazard (cloglog scale) for <code>anderson</code> data
</figcaption><div aria-describedby="fig-cuhaz-anderson-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="proportional-hazards-models_files/figure-html/fig-cuhaz-anderson-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-28" title="Figure&nbsp;7.12: Cumulative hazard (cloglog scale) for anderson data"><img src="proportional-hazards-models_files/figure-html/fig-cuhaz-anderson-1.png" class="img-fluid figure-img" width="672"></a>
</div>
</figure>
</div>
</div>
</div>
<p>This can be fixed by using strata or possibly by other model alterations.</p>
</section><section id="the-stratified-cox-model" class="level3" data-number="7.13.4"><h3 data-number="7.13.4" class="anchored" data-anchor-id="the-stratified-cox-model">
<span class="header-section-number">7.13.4</span> The Stratified Cox Model</h3>
<ul>
<li>In a stratified Cox model, each stratum, defined by one or more factors, has its own base survival function <span class="math inline">\({\lambda}_0(t)\)</span>.</li>
<li>But the coefficients for each variable not used in the strata definitions are assumed to be the same across strata.</li>
<li>To check if this assumption is reasonable one can include interactions with strata and see if they are significant (this may generate a warning and NA lines but these can be ignored).</li>
<li>Since the <code>sex</code> variable shows possible non-proportionality, we try stratifying on <code>sex</code>.</li>
</ul>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="va">anderson.coxph.strat</span> <span class="op">=</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> </span>
<span>      <span class="va">surv</span> <span class="op">~</span> <span class="va">rx</span> <span class="op">+</span> <span class="va">logwbc</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/strata.html">strata</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">anderson</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">anderson.coxph.strat</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = surv ~ rx + logwbc + strata(sex), data = anderson)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 42, number of events= 30 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;          coef exp(coef) se(coef)     z Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; rxnew  -0.998     0.369    0.474 -2.11    0.035 *  </span></span>
<span><span class="co">#&gt; logwbc  1.454     4.279    0.344  4.22  2.4e-05 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;        exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; rxnew      0.369      2.713     0.146     0.932</span></span>
<span><span class="co">#&gt; logwbc     4.279      0.234     2.180     8.398</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.812  (se = 0.059 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 32.1  on 2 df,   p=1e-07</span></span>
<span><span class="co">#&gt; Wald test            = 22.8  on 2 df,   p=1e-05</span></span>
<span><span class="co">#&gt; Score (logrank) test = 30.8  on 2 df,   p=2e-07</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s compare this to a model fit only on the subset of males:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="va">anderson.coxph.male</span> <span class="op">=</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">rx</span> <span class="op">+</span> <span class="va">logwbc</span>,</span>
<span>    subset <span class="op">=</span> <span class="va">sex</span> <span class="op">==</span> <span class="st">"male"</span>,</span>
<span>    data <span class="op">=</span> <span class="va">anderson</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">anderson.coxph.male</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = surv ~ rx + logwbc, data = anderson, subset = sex == </span></span>
<span><span class="co">#&gt;     "male")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 20, number of events= 14 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;          coef exp(coef) se(coef)     z Pr(&gt;|z|)   </span></span>
<span><span class="co">#&gt; rxnew  -1.978     0.138    0.739 -2.68   0.0075 **</span></span>
<span><span class="co">#&gt; logwbc  1.743     5.713    0.536  3.25   0.0011 **</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;        exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; rxnew      0.138      7.227    0.0325     0.589</span></span>
<span><span class="co">#&gt; logwbc     5.713      0.175    1.9991    16.328</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.905  (se = 0.043 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 29.2  on 2 df,   p=5e-07</span></span>
<span><span class="co">#&gt; Wald test            = 15.3  on 2 df,   p=5e-04</span></span>
<span><span class="co">#&gt; Score (logrank) test = 26.4  on 2 df,   p=2e-06</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anderson.coxph.female</span> <span class="op">=</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> </span>
<span>      <span class="va">surv</span> <span class="op">~</span> <span class="va">rx</span> <span class="op">+</span> <span class="va">logwbc</span>,</span>
<span>    subset <span class="op">=</span> <span class="va">sex</span> <span class="op">==</span> <span class="st">"female"</span>,</span>
<span>    data <span class="op">=</span> <span class="va">anderson</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">anderson.coxph.female</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = surv ~ rx + logwbc, data = anderson, subset = sex == </span></span>
<span><span class="co">#&gt;     "female")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 22, number of events= 16 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;          coef exp(coef) se(coef)     z Pr(&gt;|z|)  </span></span>
<span><span class="co">#&gt; rxnew  -0.311     0.733    0.564 -0.55    0.581  </span></span>
<span><span class="co">#&gt; logwbc  1.206     3.341    0.503  2.40    0.017 *</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;        exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; rxnew      0.733      1.365     0.243      2.21</span></span>
<span><span class="co">#&gt; logwbc     3.341      0.299     1.245      8.96</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.692  (se = 0.085 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 6.65  on 2 df,   p=0.04</span></span>
<span><span class="co">#&gt; Wald test            = 6.36  on 2 df,   p=0.04</span></span>
<span><span class="co">#&gt; Score (logrank) test = 6.74  on 2 df,   p=0.03</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The coefficients of treatment look different. Are they statistically different?</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="va">anderson.coxph.strat.intxn</span> <span class="op">=</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/strata.html">strata</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">rx</span> <span class="op">+</span> <span class="va">logwbc</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">anderson</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anderson.coxph.strat.intxn</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = surv ~ strata(sex) * (rx + logwbc), data = anderson)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 42, number of events= 30 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                          coef exp(coef) se(coef)     z Pr(&gt;|z|)  </span></span>
<span><span class="co">#&gt; rxnew                  -0.311     0.733    0.564 -0.55    0.581  </span></span>
<span><span class="co">#&gt; logwbc                  1.206     3.341    0.503  2.40    0.017 *</span></span>
<span><span class="co">#&gt; strata(sex)male:rxnew  -1.667     0.189    0.930 -1.79    0.073 .</span></span>
<span><span class="co">#&gt; strata(sex)male:logwbc  0.537     1.710    0.735  0.73    0.465  </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                        exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; rxnew                      0.733      1.365    0.2427      2.21</span></span>
<span><span class="co">#&gt; logwbc                     3.341      0.299    1.2452      8.96</span></span>
<span><span class="co">#&gt; strata(sex)male:rxnew      0.189      5.294    0.0305      1.17</span></span>
<span><span class="co">#&gt; strata(sex)male:logwbc     1.710      0.585    0.4048      7.23</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.797  (se = 0.058 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 35.8  on 4 df,   p=3e-07</span></span>
<span><span class="co">#&gt; Wald test            = 21.7  on 4 df,   p=2e-04</span></span>
<span><span class="co">#&gt; Score (logrank) test = 33.1  on 4 df,   p=1e-06</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span><span class="op">(</span></span>
<span>  <span class="va">anderson.coxph.strat.intxn</span>,</span>
<span>  <span class="va">anderson.coxph.strat</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["loglik"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["Chisq"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["Df"],"name":[3],"type":["int"],"align":["right"]},{"label":["Pr(>|Chi|)"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"-53.8519","2":"NA","3":"NA","4":"NA","_rn_":"1"},{"1":"-55.7348","2":"3.76586","3":"2","4":"0.152144","_rn_":"2"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>We don’t have enough evidence to tell the difference between these two models.</p>
</section><section id="conclusions-1" class="level3" data-number="7.13.5"><h3 data-number="7.13.5" class="anchored" data-anchor-id="conclusions-1">
<span class="header-section-number">7.13.5</span> Conclusions</h3>
<ul>
<li>We chose to use a stratified model because of the apparent non-proportionality of the hazard for the sex variable.</li>
<li>When we fit interactions with the strata variable, we did not get an improved model (via the likelihood ratio test).</li>
<li>So we use the stratifed model with coefficients that are the same across strata.</li>
</ul></section><section id="another-modeling-approach" class="level3" data-number="7.13.6"><h3 data-number="7.13.6" class="anchored" data-anchor-id="another-modeling-approach">
<span class="header-section-number">7.13.6</span> Another Modeling Approach</h3>
<ul>
<li>We used an additive model without interactions and saw that we might need to stratify by sex.</li>
<li>Instead, we could try to improve the model’s functional form - maybe the interaction of treatment and sex is real, and after fitting that we might not need separate hazard functions.</li>
<li>Either approach may work.</li>
</ul>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="va">anderson.coxph.intxn</span> <span class="op">=</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="op">(</span><span class="va">rx</span> <span class="op">+</span> <span class="va">logwbc</span><span class="op">)</span> <span class="op">*</span> <span class="va">sex</span>,</span>
<span>    data <span class="op">=</span> <span class="va">anderson</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anderson.coxph.intxn</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = surv ~ (rx + logwbc) * sex, data = anderson)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 42, number of events= 30 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                   coef exp(coef) se(coef)     z Pr(&gt;|z|)  </span></span>
<span><span class="co">#&gt; rxnew          -0.3748    0.6874   0.5545 -0.68    0.499  </span></span>
<span><span class="co">#&gt; logwbc          1.0637    2.8971   0.4726  2.25    0.024 *</span></span>
<span><span class="co">#&gt; sexmale        -2.8052    0.0605   2.0323 -1.38    0.167  </span></span>
<span><span class="co">#&gt; rxnew:sexmale  -2.1782    0.1132   0.9109 -2.39    0.017 *</span></span>
<span><span class="co">#&gt; logwbc:sexmale  1.2303    3.4223   0.6301  1.95    0.051 .</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; rxnew             0.6874      1.455   0.23185     2.038</span></span>
<span><span class="co">#&gt; logwbc            2.8971      0.345   1.14730     7.315</span></span>
<span><span class="co">#&gt; sexmale           0.0605     16.531   0.00113     3.248</span></span>
<span><span class="co">#&gt; rxnew:sexmale     0.1132      8.830   0.01899     0.675</span></span>
<span><span class="co">#&gt; logwbc:sexmale    3.4223      0.292   0.99539    11.766</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.861  (se = 0.036 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 57  on 5 df,   p=5e-11</span></span>
<span><span class="co">#&gt; Wald test            = 35.6  on 5 df,   p=1e-06</span></span>
<span><span class="co">#&gt; Score (logrank) test = 57.1  on 5 df,   p=5e-11</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/cox.zph.html">cox.zph</a></span><span class="op">(</span><span class="va">anderson.coxph.intxn</span><span class="op">)</span></span>
<span><span class="co">#&gt;            chisq df    p</span></span>
<span><span class="co">#&gt; rx         0.136  1 0.71</span></span>
<span><span class="co">#&gt; logwbc     1.652  1 0.20</span></span>
<span><span class="co">#&gt; sex        1.266  1 0.26</span></span>
<span><span class="co">#&gt; rx:sex     0.149  1 0.70</span></span>
<span><span class="co">#&gt; logwbc:sex 0.102  1 0.75</span></span>
<span><span class="co">#&gt; GLOBAL     3.747  5 0.59</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="time-varying-covariates" class="level2" data-number="7.14"><h2 data-number="7.14" class="anchored" data-anchor-id="time-varying-covariates">
<span class="header-section-number">7.14</span> Time-varying covariates</h2>
<p>(adapted from <span class="citation" data-cites="klein2003survival">Klein and Moeschberger (<a href="references.html#ref-klein2003survival" role="doc-biblioref">2003</a>)</span>, §9.2)</p>
<section id="motivating-example-back-to-the-leukemia-dataset" class="level3" data-number="7.14.1"><h3 data-number="7.14.1" class="anchored" data-anchor-id="motivating-example-back-to-the-leukemia-dataset">
<span class="header-section-number">7.14.1</span> Motivating example: back to the leukemia dataset</h3>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># load the data:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">bmt</span>, package <span class="op">=</span> <span class="st">'KMsurv'</span><span class="op">)</span></span>
<span><span class="va">bmt</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 137 × 22</span></span>
<span><span class="co">#&gt;   group    t1    t2    d1    d2    d3    ta    da    tc    dc    tp    dp    z1</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1     1  2081  2081     0     0     0    67     1   121     1    13     1    26</span></span>
<span><span class="co">#&gt; 2     1  1602  1602     0     0     0  1602     0   139     1    18     1    21</span></span>
<span><span class="co">#&gt; 3     1  1496  1496     0     0     0  1496     0   307     1    12     1    26</span></span>
<span><span class="co">#&gt; 4     1  1462  1462     0     0     0    70     1    95     1    13     1    17</span></span>
<span><span class="co">#&gt; 5     1  1433  1433     0     0     0  1433     0   236     1    12     1    32</span></span>
<span><span class="co">#&gt; # ℹ 132 more rows</span></span>
<span><span class="co">#&gt; # ℹ 9 more variables: z2 &lt;int&gt;, z3 &lt;int&gt;, z4 &lt;int&gt;, z5 &lt;int&gt;, z6 &lt;int&gt;,</span></span>
<span><span class="co">#&gt; #   z7 &lt;int&gt;, z8 &lt;int&gt;, z9 &lt;int&gt;, z10 &lt;int&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This dataset comes from the <span class="citation" data-cites="copelan1991treatment">Copelan et al. (<a href="references.html#ref-copelan1991treatment" role="doc-biblioref">1991</a>)</span> study of allogenic bone marrow transplant therapy for acute myeloid leukemia (AML) and acute lymphoblastic leukemia (ALL).</p>
<section id="outcomes-endpoints" class="level5"><h5 class="anchored" data-anchor-id="outcomes-endpoints">Outcomes (endpoints)</h5>
<ul>
<li>The main endpoint is disease-free survival (<code>t2</code> and <code>d3</code>) for the three risk groups, “ALL”, “AML Low Risk”, and “AML High Risk”.</li>
</ul></section><section id="possible-intermediate-events" class="level5"><h5 class="anchored" data-anchor-id="possible-intermediate-events">Possible intermediate events</h5>
<ul>
<li>graft vs.&nbsp;host disease (<strong>GVHD</strong>), an immunological rejection response to the transplant (bad)</li>
<li>acute (<strong>AGVHD</strong>)</li>
<li>chronic (<strong>CGVHD</strong>)</li>
<li>platelet recovery, a return of platelet count to normal levels (good)</li>
</ul>
<p>One or the other, both in either order, or neither may occur.</p>
</section><section id="covariates" class="level5"><h5 class="anchored" data-anchor-id="covariates">Covariates</h5>
<ul>
<li><p>We are interested in possibly using the covariates <code>z1</code>-<code>z10</code> to adjust for other factors.</p></li>
<li><p>In addition, the time-varying covariates for acute GVHD, chronic GVHD, and platelet recovery may be useful.</p></li>
</ul></section><section id="preprocessing" class="level4"><h4 class="anchored" data-anchor-id="preprocessing">Preprocessing</h4>
<p>We reformat the data before analysis:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># reformat the data:</span></span>
<span><span class="va">bmt1</span> <span class="op">=</span> </span>
<span>  <span class="va">bmt</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="co"># will be used to connect multiple records for the same individual</span></span>
<span>    </span>
<span>    group <span class="op">=</span>  <span class="va">group</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"ALL"</span>,</span>
<span>        <span class="fl">2</span> <span class="op">~</span> <span class="st">"Low Risk AML"</span>,</span>
<span>        <span class="fl">3</span> <span class="op">~</span> <span class="st">"High Risk AML"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ALL"</span>, <span class="st">"Low Risk AML"</span>, <span class="st">"High Risk AML"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    </span>
<span>    `patient age` <span class="op">=</span> <span class="va">z1</span>,</span>
<span>    </span>
<span>    `donor age` <span class="op">=</span> <span class="va">z2</span>,</span>
<span>    </span>
<span>    `patient sex` <span class="op">=</span> <span class="va">z3</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"Female"</span>,</span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"Male"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    `donor sex` <span class="op">=</span> <span class="va">z4</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"Female"</span>,</span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"Male"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    `Patient CMV Status` <span class="op">=</span> <span class="va">z5</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"CMV Negative"</span>,</span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"CMV Positive"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    `Donor CMV Status` <span class="op">=</span> <span class="va">z6</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"CMV Negative"</span>,</span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"CMV Positive"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    `Waiting Time to Transplant` <span class="op">=</span> <span class="va">z7</span>,</span>
<span>    </span>
<span>    FAB <span class="op">=</span> <span class="va">z8</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"Grade 4 Or 5 (AML only)"</span>,</span>
<span>        <span class="fl">0</span> <span class="op">~</span> <span class="st">"Other"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span>ref <span class="op">=</span> <span class="st">"Other"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    hospital <span class="op">=</span> <span class="va">z9</span> <span class="op">|&gt;</span>  <span class="co"># `z9` is hospital</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_match.html">case_match</a></span><span class="op">(</span></span>
<span>        <span class="fl">1</span> <span class="op">~</span> <span class="st">"Ohio State University"</span>,</span>
<span>        <span class="fl">2</span> <span class="op">~</span> <span class="st">"Alferd"</span>,</span>
<span>        <span class="fl">3</span> <span class="op">~</span> <span class="st">"St. Vincent"</span>,</span>
<span>        <span class="fl">4</span> <span class="op">~</span> <span class="st">"Hahnemann"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span>ref <span class="op">=</span> <span class="st">"Ohio State University"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    MTX <span class="op">=</span> <span class="op">(</span><span class="va">z10</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># a prophylatic treatment for GVHD</span></span>
<span>    </span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">z1</span><span class="op">:</span><span class="va">z10</span><span class="op">)</span><span class="op">)</span> <span class="co"># don't need these anymore</span></span>
<span></span>
<span><span class="va">bmt1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">id</span><span class="op">:</span><span class="va">MTX</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 137 × 12</span></span>
<span><span class="co">#&gt;    group    id `patient age` `donor age` `patient sex` `donor sex`</span></span>
<span><span class="co">#&gt;    &lt;fct&gt; &lt;int&gt;         &lt;int&gt;       &lt;int&gt; &lt;chr&gt;         &lt;chr&gt;      </span></span>
<span><span class="co">#&gt;  1 ALL       1            26          33 Male          Female     </span></span>
<span><span class="co">#&gt;  2 ALL       2            21          37 Male          Male       </span></span>
<span><span class="co">#&gt;  3 ALL       3            26          35 Male          Male       </span></span>
<span><span class="co">#&gt;  4 ALL       4            17          21 Female        Male       </span></span>
<span><span class="co">#&gt;  5 ALL       5            32          36 Male          Male       </span></span>
<span><span class="co">#&gt;  6 ALL       6            22          31 Male          Male       </span></span>
<span><span class="co">#&gt;  7 ALL       7            20          17 Male          Female     </span></span>
<span><span class="co">#&gt;  8 ALL       8            22          24 Male          Female     </span></span>
<span><span class="co">#&gt;  9 ALL       9            18          21 Female        Male       </span></span>
<span><span class="co">#&gt; 10 ALL      10            24          40 Male          Male       </span></span>
<span><span class="co">#&gt; # ℹ 127 more rows</span></span>
<span><span class="co">#&gt; # ℹ 6 more variables: `Patient CMV Status` &lt;chr&gt;, `Donor CMV Status` &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   `Waiting Time to Transplant` &lt;int&gt;, FAB &lt;fct&gt;, hospital &lt;fct&gt;, MTX &lt;lgl&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="time-dependent-covariates" class="level3" data-number="7.14.2"><h3 data-number="7.14.2" class="anchored" data-anchor-id="time-dependent-covariates">
<span class="header-section-number">7.14.2</span> Time-Dependent Covariates</h3>
<ul>
<li>A <strong>time-dependent covariate</strong> (“<strong>TDC</strong>”) is a covariate whose value changes during the course of the study.</li>
<li>For variables like age that change in a linear manner with time, we can just use the value at the start.</li>
<li>But it may be plausible that when and if GVHD occurs, the risk of relapse or death increases, and when and if platelet recovery occurs, the risk decreases.</li>
</ul></section><section id="analysis-in-r" class="level3" data-number="7.14.3"><h3 data-number="7.14.3" class="anchored" data-anchor-id="analysis-in-r">
<span class="header-section-number">7.14.3</span> Analysis in R</h3>
<ul>
<li>We form a variable <code>precovery</code> which is = 0 before platelet recovery and is = 1 after platelet recovery, if it occurs.</li>
<li>For each subject where platelet recovery occurs, we set up multiple records (lines in the data frame); for example one from t = 0 to the time of platelet recovery, and one from that time to relapse, recovery, or death.</li>
<li>We do the same for acute GVHD and chronic GVHD.</li>
<li>For each record, the covariates are constant.</li>
</ul>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="va">bmt2</span> <span class="op">=</span> <span class="va">bmt1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co">#set up new long-format data set:</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/tmerge.html">tmerge</a></span><span class="op">(</span><span class="va">bmt1</span>, id <span class="op">=</span> <span class="va">id</span>, tstop <span class="op">=</span> <span class="va">t2</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  </span>
<span>  <span class="co"># the following three steps can be in any order, </span></span>
<span>  <span class="co"># and will still produce the same result:</span></span>
<span>  <span class="co">#add aghvd as tdc:</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/tmerge.html">tmerge</a></span><span class="op">(</span><span class="va">bmt1</span>, id <span class="op">=</span> <span class="va">id</span>, agvhd <span class="op">=</span> <span class="fu">tdc</span><span class="op">(</span><span class="va">ta</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co">#add cghvd as tdc:</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/tmerge.html">tmerge</a></span><span class="op">(</span><span class="va">bmt1</span>, id <span class="op">=</span> <span class="va">id</span>, cgvhd <span class="op">=</span> <span class="fu">tdc</span><span class="op">(</span><span class="va">tc</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co">#add platelet recovery as tdc:</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/tmerge.html">tmerge</a></span><span class="op">(</span><span class="va">bmt1</span>, id <span class="op">=</span> <span class="va">id</span>, precovery <span class="op">=</span> <span class="fu">tdc</span><span class="op">(</span><span class="va">tp</span><span class="op">)</span><span class="op">)</span>   </span>
<span></span>
<span><span class="va">bmt2</span> <span class="op">=</span> <span class="va">bmt2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>status <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">(</span><span class="va">tstop</span> <span class="op">==</span> <span class="va">t2</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">d3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># status only = 1 if at end of t2 and not censored</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s see how we’ve rearranged the first row of the data:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="va">bmt1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">t1</span>, <span class="va">d1</span>, <span class="va">t2</span>, <span class="va">d2</span>, <span class="va">d3</span>, <span class="va">ta</span>, <span class="va">da</span>, <span class="va">tc</span>, <span class="va">dc</span>, <span class="va">tp</span>, <span class="va">dp</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["id"],"name":[1],"type":["int"],"align":["right"]},{"label":["t1"],"name":[2],"type":["int"],"align":["right"]},{"label":["d1"],"name":[3],"type":["int"],"align":["right"]},{"label":["t2"],"name":[4],"type":["int"],"align":["right"]},{"label":["d2"],"name":[5],"type":["int"],"align":["right"]},{"label":["d3"],"name":[6],"type":["int"],"align":["right"]},{"label":["ta"],"name":[7],"type":["int"],"align":["right"]},{"label":["da"],"name":[8],"type":["int"],"align":["right"]},{"label":["tc"],"name":[9],"type":["int"],"align":["right"]},{"label":["dc"],"name":[10],"type":["int"],"align":["right"]},{"label":["tp"],"name":[11],"type":["int"],"align":["right"]},{"label":["dp"],"name":[12],"type":["int"],"align":["right"]}],"data":[{"1":"1","2":"2081","3":"0","4":"2081","5":"0","6":"0","7":"67","8":"1","9":"121","10":"1","11":"13","12":"1"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>The event times for this individual are:</p>
<ul>
<li>
<code>t</code> = 0 time of transplant</li>
<li>
<code>tp</code> = 13 platelet recovery</li>
<li>
<code>ta</code> = 67 acute GVHD onset</li>
<li>
<code>tc</code> = 121 chronic GVHD onset</li>
<li>
<code>t2</code> = 2081 end of study, patient not relapsed or dead</li>
</ul>
<p>After converting the data to long-format, we have:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span></span>
<span>    <span class="va">id</span>,</span>
<span>    <span class="va">tstart</span>,</span>
<span>    <span class="va">tstop</span>,</span>
<span>    <span class="va">agvhd</span>,</span>
<span>    <span class="va">cgvhd</span>,</span>
<span>    <span class="va">precovery</span>,</span>
<span>    <span class="va">status</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["id"],"name":[1],"type":["int"],"align":["right"]},{"label":["tstart"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["tstop"],"name":[3],"type":["int"],"align":["right"]},{"label":["agvhd"],"name":[4],"type":["int"],"align":["right"]},{"label":["cgvhd"],"name":[5],"type":["int"],"align":["right"]},{"label":["precovery"],"name":[6],"type":["int"],"align":["right"]},{"label":["status"],"name":[7],"type":["dbl"],"align":["right"]}],"data":[{"1":"1","2":"0","3":"13","4":"0","5":"0","6":"0","7":"0"},{"1":"1","2":"13","3":"67","4":"0","5":"0","6":"1","7":"0"},{"1":"1","2":"67","3":"121","4":"1","5":"0","6":"1","7":"0"},{"1":"1","2":"121","3":"2081","4":"1","5":"1","6":"1","7":"0"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Note that <code>status</code> could have been <code>1</code> on the last row, indicating that relapse or death occurred; since it is false, the participant must have exited the study without experiencing relapse or death (i.e., they were censored).</p>
</section><section id="event-sequences" class="level3" data-number="7.14.4"><h3 data-number="7.14.4" class="anchored" data-anchor-id="event-sequences">
<span class="header-section-number">7.14.4</span> Event sequences</h3>
<p>Let:</p>
<ul>
<li>A = acute GVHD</li>
<li>C = chronic GVHD</li>
<li>P = platelet recovery</li>
</ul>
<p>Each of the eight possible combinations of A or not-A, with C or not-C, with P or not-P occurs in this data set.</p>
<ul>
<li>A always occurs before C, and P always occurs before C, if both occur.</li>
<li>Thus there are ten event sequences in the data set: None, A, C, P, AC, AP, PA, PC, APC, and PAC.</li>
<li>In general, there could be as many as <span class="math inline">\(1+3+(3)(2)+6=16\)</span> sequences, but our domain knowledge tells us that some are missing: CA, CP, CAP, CPA, PCA, PC, PAC</li>
<li>Different subjects could have 1, 2, 3, or 4 intervals, depending on which of acute GVHD, chronic GVHD, and/or platelet recovery occurred.</li>
<li>The final interval for any subject has <code>status</code> = 1 if the subject relapsed or died at that time; otherwise <code>status</code> = 0.</li>
<li>Any earlier intervals have <code>status</code> = 0.</li>
<li>Even though there might be multiple lines per ID in the dataset, there is never more than one event, so no alterations need be made in the estimation procedures or in the interpretation of the output.</li>
<li>The function <code>tmerge</code> in the <code>survival</code> package eases the process of constructing the new long-format dataset.</li>
</ul></section><section id="model-with-time-fixed-covariates" class="level3" data-number="7.14.5"><h3 data-number="7.14.5" class="anchored" data-anchor-id="model-with-time-fixed-covariates">
<span class="header-section-number">7.14.5</span> Model with Time-Fixed Covariates</h3>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt1</span> <span class="op">=</span> </span>
<span>  <span class="va">bmt1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>surv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">t2</span>,<span class="va">d3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmt_coxph_TF</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">group</span> <span class="op">+</span> <span class="va">`patient age`</span><span class="op">*</span><span class="va">`donor age`</span> <span class="op">+</span> <span class="va">FAB</span>,</span>
<span>  data <span class="op">=</span> <span class="va">bmt1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">bmt_coxph_TF</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = surv ~ group + `patient age` * `donor age` + </span></span>
<span><span class="co">#&gt;     FAB, data = bmt1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 137, number of events= 83 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                                 coef exp(coef)  se(coef)     z Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; groupLow Risk AML          -1.090648  0.335999  0.354279 -3.08  0.00208 ** </span></span>
<span><span class="co">#&gt; groupHigh Risk AML         -0.403905  0.667707  0.362777 -1.11  0.26555    </span></span>
<span><span class="co">#&gt; `patient age`              -0.081639  0.921605  0.036107 -2.26  0.02376 *  </span></span>
<span><span class="co">#&gt; `donor age`                -0.084587  0.918892  0.030097 -2.81  0.00495 ** </span></span>
<span><span class="co">#&gt; FABGrade 4 Or 5 (AML only)  0.837416  2.310388  0.278464  3.01  0.00264 ** </span></span>
<span><span class="co">#&gt; `patient age`:`donor age`   0.003159  1.003164  0.000951  3.32  0.00089 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                            exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; groupLow Risk AML              0.336      2.976     0.168     0.673</span></span>
<span><span class="co">#&gt; groupHigh Risk AML             0.668      1.498     0.328     1.360</span></span>
<span><span class="co">#&gt; `patient age`                  0.922      1.085     0.859     0.989</span></span>
<span><span class="co">#&gt; `donor age`                    0.919      1.088     0.866     0.975</span></span>
<span><span class="co">#&gt; FABGrade 4 Or 5 (AML only)     2.310      0.433     1.339     3.988</span></span>
<span><span class="co">#&gt; `patient age`:`donor age`      1.003      0.997     1.001     1.005</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.665  (se = 0.033 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 32.8  on 6 df,   p=1e-05</span></span>
<span><span class="co">#&gt; Wald test            = 33  on 6 df,   p=1e-05</span></span>
<span><span class="co">#&gt; Score (logrank) test = 35.8  on 6 df,   p=3e-06</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/add1.html">drop1</a></span><span class="op">(</span><span class="va">bmt_coxph_TF</span>, test <span class="op">=</span> <span class="st">"Chisq"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Df"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["AIC"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["LRT"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Pr(>Chi)"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"NA","2":"725.788","3":"NA","4":"NA","_rn_":"<none>"},{"1":"2","2":"734.299","3":"12.51124","4":"0.00191963","_rn_":"group"},{"1":"1","2":"733.004","3":"9.21616","4":"0.00239888","_rn_":"FAB"},{"1":"1","2":"733.302","3":"9.51369","4":"0.00203945","_rn_":"`patient age`:`donor age`"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt1</span><span class="op">$</span><span class="va">mres</span> <span class="op">=</span> </span>
<span>  <span class="va">bmt_coxph_TF</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">`donor age`</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"martingale"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bmt1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">`donor age`</span>, y <span class="op">=</span> <span class="va">mres</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"loess"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'lm'</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Donor age"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Martingale Residuals"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>col<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><figcaption>Martingale residuals for <code>Donor age</code></figcaption><p><a href="proportional-hazards-models_files/figure-html/unnamed-chunk-50-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-29" title="Martingale residuals for Donor age"><img src="proportional-hazards-models_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="672" alt="Martingale residuals for Donor age"></a></p>
</figure>
</div>
</div>
</div>
<p>A more complex functional form for <code>donor age</code> seems warranted; left as an exercise for the reader.</p>
<p>Now we will add the time-varying covariates:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="co"># add counting process formulation of Surv():</span></span>
<span><span class="va">bmt2</span> <span class="op">=</span> </span>
<span>  <span class="va">bmt2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    surv <span class="op">=</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span></span>
<span>        time <span class="op">=</span> <span class="va">tstart</span>,</span>
<span>        time2 <span class="op">=</span> <span class="va">tstop</span>,</span>
<span>        event <span class="op">=</span> <span class="va">status</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"counting"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s see how the data looks for patient 15:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt1</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="fl">15</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">tp</span>, <span class="va">dp</span>, <span class="va">tc</span>,<span class="va">dc</span>, <span class="va">ta</span>, <span class="va">da</span>, <span class="va">FAB</span>, <span class="va">surv</span>, <span class="va">t1</span>, <span class="va">d1</span>, <span class="va">t2</span>, <span class="va">d2</span>, <span class="va">d3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["tp"],"name":[1],"type":["int"],"align":["right"]},{"label":["dp"],"name":[2],"type":["int"],"align":["right"]},{"label":["tc"],"name":[3],"type":["int"],"align":["right"]},{"label":["dc"],"name":[4],"type":["int"],"align":["right"]},{"label":["ta"],"name":[5],"type":["int"],"align":["right"]},{"label":["da"],"name":[6],"type":["int"],"align":["right"]},{"label":["FAB"],"name":[7],"type":["fct"],"align":["left"]},{"label":["surv"],"name":[8],"type":["Surv[,2]"],"align":["right"]},{"label":["t1"],"name":[9],"type":["int"],"align":["right"]},{"label":["d1"],"name":[10],"type":["int"],"align":["right"]},{"label":["t2"],"name":[11],"type":["int"],"align":["right"]},{"label":["d2"],"name":[12],"type":["int"],"align":["right"]},{"label":["d3"],"name":[13],"type":["int"],"align":["right"]}],"data":[{"1":"21","2":"1","3":"220","4":"1","5":"418","6":"0","7":"Other","8":"418","9":"418","10":"1","11":"418","12":"0","13":"1"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt2</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="fl">15</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">agvhd</span>, <span class="va">cgvhd</span>, <span class="va">precovery</span>, <span class="va">surv</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["id"],"name":[1],"type":["int"],"align":["right"]},{"label":["agvhd"],"name":[2],"type":["int"],"align":["right"]},{"label":["cgvhd"],"name":[3],"type":["int"],"align":["right"]},{"label":["precovery"],"name":[4],"type":["int"],"align":["right"]},{"label":["surv"],"name":[5],"type":["Surv[,3]"],"align":["right"]}],"data":[{"1":"15","2":"0","3":"0","4":"0","5":"(  0, 21+]"},{"1":"15","2":"0","3":"0","4":"1","5":"( 21,220+]"},{"1":"15","2":"0","3":"1","4":"1","5":"(220,418]"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section><section id="model-with-time-dependent-covariates" class="level3" data-number="7.14.6"><h3 data-number="7.14.6" class="anchored" data-anchor-id="model-with-time-dependent-covariates">
<span class="header-section-number">7.14.6</span> Model with Time-Dependent Covariates</h3>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt_coxph_TV</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> </span>
<span>    <span class="va">surv</span> <span class="op">~</span> </span>
<span>    <span class="va">group</span> <span class="op">+</span> <span class="va">`patient age`</span><span class="op">*</span><span class="va">`donor age`</span> <span class="op">+</span> <span class="va">FAB</span> <span class="op">+</span> <span class="va">agvhd</span> <span class="op">+</span> <span class="va">cgvhd</span> <span class="op">+</span> <span class="va">precovery</span>,</span>
<span>  data <span class="op">=</span> <span class="va">bmt2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">bmt_coxph_TV</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = surv ~ group + `patient age` * `donor age` + </span></span>
<span><span class="co">#&gt;     FAB + agvhd + cgvhd + precovery, data = bmt2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 341, number of events= 83 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                                 coef exp(coef)  se(coef)     z Pr(&gt;|z|)   </span></span>
<span><span class="co">#&gt; groupLow Risk AML          -1.038514  0.353980  0.358220 -2.90   0.0037 **</span></span>
<span><span class="co">#&gt; groupHigh Risk AML         -0.380481  0.683533  0.374867 -1.01   0.3101   </span></span>
<span><span class="co">#&gt; `patient age`              -0.073351  0.929275  0.035956 -2.04   0.0413 * </span></span>
<span><span class="co">#&gt; `donor age`                -0.076406  0.926440  0.030196 -2.53   0.0114 * </span></span>
<span><span class="co">#&gt; FABGrade 4 Or 5 (AML only)  0.805700  2.238263  0.284273  2.83   0.0046 **</span></span>
<span><span class="co">#&gt; agvhd                       0.150565  1.162491  0.306848  0.49   0.6237   </span></span>
<span><span class="co">#&gt; cgvhd                      -0.116136  0.890354  0.289046 -0.40   0.6878   </span></span>
<span><span class="co">#&gt; precovery                  -0.941123  0.390190  0.347861 -2.71   0.0068 **</span></span>
<span><span class="co">#&gt; `patient age`:`donor age`   0.002895  1.002899  0.000944  3.07   0.0022 **</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                            exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; groupLow Risk AML              0.354      2.825     0.175     0.714</span></span>
<span><span class="co">#&gt; groupHigh Risk AML             0.684      1.463     0.328     1.425</span></span>
<span><span class="co">#&gt; `patient age`                  0.929      1.076     0.866     0.997</span></span>
<span><span class="co">#&gt; `donor age`                    0.926      1.079     0.873     0.983</span></span>
<span><span class="co">#&gt; FABGrade 4 Or 5 (AML only)     2.238      0.447     1.282     3.907</span></span>
<span><span class="co">#&gt; agvhd                          1.162      0.860     0.637     2.121</span></span>
<span><span class="co">#&gt; cgvhd                          0.890      1.123     0.505     1.569</span></span>
<span><span class="co">#&gt; precovery                      0.390      2.563     0.197     0.772</span></span>
<span><span class="co">#&gt; `patient age`:`donor age`      1.003      0.997     1.001     1.005</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.702  (se = 0.028 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 40.3  on 9 df,   p=7e-06</span></span>
<span><span class="co">#&gt; Wald test            = 42.4  on 9 df,   p=3e-06</span></span>
<span><span class="co">#&gt; Score (logrank) test = 47.2  on 9 df,   p=4e-07</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Platelet recovery is highly significant.</p>
<p>Neither acute GVHD (<code>agvhd</code>) nor chronic GVHD (<code>cgvhd</code>) has a statistically significant effect here, nor are they significant in models with the other one removed.</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">bmt_coxph_TV</span>, <span class="va">.</span><span class="op">~</span><span class="va">.</span><span class="op">-</span><span class="va">agvhd</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = surv ~ group + `patient age` + `donor age` + </span></span>
<span><span class="co">#&gt;     FAB + cgvhd + precovery + `patient age`:`donor age`, data = bmt2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 341, number of events= 83 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                                 coef exp(coef)  se(coef)     z Pr(&gt;|z|)   </span></span>
<span><span class="co">#&gt; groupLow Risk AML          -1.049870  0.349983  0.356727 -2.94   0.0032 **</span></span>
<span><span class="co">#&gt; groupHigh Risk AML         -0.417049  0.658988  0.365348 -1.14   0.2537   </span></span>
<span><span class="co">#&gt; `patient age`              -0.070749  0.931696  0.035477 -1.99   0.0461 * </span></span>
<span><span class="co">#&gt; `donor age`                -0.075693  0.927101  0.030075 -2.52   0.0118 * </span></span>
<span><span class="co">#&gt; FABGrade 4 Or 5 (AML only)  0.807035  2.241253  0.283437  2.85   0.0044 **</span></span>
<span><span class="co">#&gt; cgvhd                      -0.095393  0.909015  0.285979 -0.33   0.7387   </span></span>
<span><span class="co">#&gt; precovery                  -0.983653  0.373942  0.338170 -2.91   0.0036 **</span></span>
<span><span class="co">#&gt; `patient age`:`donor age`   0.002859  1.002863  0.000936  3.05   0.0023 **</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                            exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; groupLow Risk AML              0.350      2.857     0.174     0.704</span></span>
<span><span class="co">#&gt; groupHigh Risk AML             0.659      1.517     0.322     1.349</span></span>
<span><span class="co">#&gt; `patient age`                  0.932      1.073     0.869     0.999</span></span>
<span><span class="co">#&gt; `donor age`                    0.927      1.079     0.874     0.983</span></span>
<span><span class="co">#&gt; FABGrade 4 Or 5 (AML only)     2.241      0.446     1.286     3.906</span></span>
<span><span class="co">#&gt; cgvhd                          0.909      1.100     0.519     1.592</span></span>
<span><span class="co">#&gt; precovery                      0.374      2.674     0.193     0.726</span></span>
<span><span class="co">#&gt; `patient age`:`donor age`      1.003      0.997     1.001     1.005</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.701  (se = 0.027 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 40  on 8 df,   p=3e-06</span></span>
<span><span class="co">#&gt; Wald test            = 42.4  on 8 df,   p=1e-06</span></span>
<span><span class="co">#&gt; Score (logrank) test = 47.2  on 8 df,   p=1e-07</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">bmt_coxph_TV</span>, <span class="va">.</span><span class="op">~</span><span class="va">.</span><span class="op">-</span><span class="va">cgvhd</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = surv ~ group + `patient age` + `donor age` + </span></span>
<span><span class="co">#&gt;     FAB + agvhd + precovery + `patient age`:`donor age`, data = bmt2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 341, number of events= 83 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                                 coef exp(coef)  se(coef)     z Pr(&gt;|z|)   </span></span>
<span><span class="co">#&gt; groupLow Risk AML          -1.019638  0.360725  0.355311 -2.87   0.0041 **</span></span>
<span><span class="co">#&gt; groupHigh Risk AML         -0.381356  0.682935  0.374568 -1.02   0.3086   </span></span>
<span><span class="co">#&gt; `patient age`              -0.073189  0.929426  0.035890 -2.04   0.0414 * </span></span>
<span><span class="co">#&gt; `donor age`                -0.076753  0.926118  0.030121 -2.55   0.0108 * </span></span>
<span><span class="co">#&gt; FABGrade 4 Or 5 (AML only)  0.811716  2.251769  0.284012  2.86   0.0043 **</span></span>
<span><span class="co">#&gt; agvhd                       0.131621  1.140676  0.302623  0.43   0.6636   </span></span>
<span><span class="co">#&gt; precovery                  -0.946697  0.388021  0.347265 -2.73   0.0064 **</span></span>
<span><span class="co">#&gt; `patient age`:`donor age`   0.002904  1.002908  0.000943  3.08   0.0021 **</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                            exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; groupLow Risk AML              0.361      2.772     0.180     0.724</span></span>
<span><span class="co">#&gt; groupHigh Risk AML             0.683      1.464     0.328     1.423</span></span>
<span><span class="co">#&gt; `patient age`                  0.929      1.076     0.866     0.997</span></span>
<span><span class="co">#&gt; `donor age`                    0.926      1.080     0.873     0.982</span></span>
<span><span class="co">#&gt; FABGrade 4 Or 5 (AML only)     2.252      0.444     1.291     3.929</span></span>
<span><span class="co">#&gt; agvhd                          1.141      0.877     0.630     2.064</span></span>
<span><span class="co">#&gt; precovery                      0.388      2.577     0.196     0.766</span></span>
<span><span class="co">#&gt; `patient age`:`donor age`      1.003      0.997     1.001     1.005</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.701  (se = 0.027 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 40.1  on 8 df,   p=3e-06</span></span>
<span><span class="co">#&gt; Wald test            = 42.1  on 8 df,   p=1e-06</span></span>
<span><span class="co">#&gt; Score (logrank) test = 47.1  on 8 df,   p=1e-07</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s drop them both:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bmt_coxph_TV2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">bmt_coxph_TV</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">agvhd</span> <span class="op">-</span><span class="va">cgvhd</span><span class="op">)</span></span>
<span><span class="va">bmt_coxph_TV2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = surv ~ group + `patient age` + `donor age` + </span></span>
<span><span class="co">#&gt;     FAB + precovery + `patient age`:`donor age`, data = bmt2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 341, number of events= 83 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                                 coef exp(coef)  se(coef)     z Pr(&gt;|z|)   </span></span>
<span><span class="co">#&gt; groupLow Risk AML          -1.032520  0.356108  0.353202 -2.92   0.0035 **</span></span>
<span><span class="co">#&gt; groupHigh Risk AML         -0.413888  0.661075  0.365209 -1.13   0.2571   </span></span>
<span><span class="co">#&gt; `patient age`              -0.070965  0.931495  0.035453 -2.00   0.0453 * </span></span>
<span><span class="co">#&gt; `donor age`                -0.076052  0.926768  0.030007 -2.53   0.0113 * </span></span>
<span><span class="co">#&gt; FABGrade 4 Or 5 (AML only)  0.811926  2.252242  0.283231  2.87   0.0041 **</span></span>
<span><span class="co">#&gt; precovery                  -0.983505  0.373998  0.337997 -2.91   0.0036 **</span></span>
<span><span class="co">#&gt; `patient age`:`donor age`   0.002872  1.002876  0.000936  3.07   0.0021 **</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                            exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; groupLow Risk AML              0.356      2.808     0.178     0.712</span></span>
<span><span class="co">#&gt; groupHigh Risk AML             0.661      1.513     0.323     1.352</span></span>
<span><span class="co">#&gt; `patient age`                  0.931      1.074     0.869     0.999</span></span>
<span><span class="co">#&gt; `donor age`                    0.927      1.079     0.874     0.983</span></span>
<span><span class="co">#&gt; FABGrade 4 Or 5 (AML only)     2.252      0.444     1.293     3.924</span></span>
<span><span class="co">#&gt; precovery                      0.374      2.674     0.193     0.725</span></span>
<span><span class="co">#&gt; `patient age`:`donor age`      1.003      0.997     1.001     1.005</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.7  (se = 0.027 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 39.9  on 7 df,   p=1e-06</span></span>
<span><span class="co">#&gt; Wald test            = 42.2  on 7 df,   p=5e-07</span></span>
<span><span class="co">#&gt; Score (logrank) test = 47.1  on 7 df,   p=5e-08</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="recurrent-events" class="level2" data-number="7.15"><h2 data-number="7.15" class="anchored" data-anchor-id="recurrent-events">
<span class="header-section-number">7.15</span> Recurrent Events</h2>
<p>(Adapted from <span class="citation" data-cites="kleinbaum2012survival">Kleinbaum and Klein (<a href="references.html#ref-kleinbaum2012survival" role="doc-biblioref">2012</a>)</span>, Ch 8)</p>
<ul>
<li>Sometimes an appropriate analysis requires consideration of recurrent events.</li>
<li>A patient with arthritis may have more than one flareup. The same is true of many recurring-remitting diseases.</li>
<li>In this case, we have more than one line in the data frame, but each line may have an event.</li>
<li>We have to use a “robust” variance estimator to account for correlation of time-to-events within a patient.</li>
</ul>
<section id="bladder-cancer-data-set" class="level3" data-number="7.15.1"><h3 data-number="7.15.1" class="anchored" data-anchor-id="bladder-cancer-data-set">
<span class="header-section-number">7.15.1</span> Bladder Cancer Data Set</h3>
<p>The bladder cancer dataset from <span class="citation" data-cites="kleinbaum2012survival">Kleinbaum and Klein (<a href="references.html#ref-kleinbaum2012survival" role="doc-biblioref">2012</a>)</span> contains recurrent event outcome information for eighty-six cancer patients followed for the recurrence of bladder cancer tumor after transurethral surgical excision (Byar and Green 1980). The exposure of interest is the effect of the drug treatment of thiotepa. Control variables are the initial number and initial size of tumors. The data layout is suitable for a counting processes approach.</p>
<p>This drug is still a possible choice for some patients. Another therapeutic choice is Bacillus Calmette-Guerin (BCG), a live bacterium related to cow tuberculosis.</p>
<section id="data-dictionary" class="level4"><h4 class="anchored" data-anchor-id="data-dictionary">Data dictionary</h4>
<table class="caption-top table">
<caption>Variables in the <code>bladder</code> dataset</caption>
<thead><tr class="header">
<th>Variable</th>
<th>Definition</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>id</code></td>
<td>Patient unique ID</td>
</tr>
<tr class="even">
<td><code>status</code></td>
<td>for each time interval: 1 = recurred, 0 = censored</td>
</tr>
<tr class="odd">
<td><code>interval</code></td>
<td>1 = first recurrence, etc.</td>
</tr>
<tr class="even">
<td><code>intime</code></td>
<td>`<code>tstop - tstart</code> (all times in months)</td>
</tr>
<tr class="odd">
<td><code>tstart</code></td>
<td>start of interval</td>
</tr>
<tr class="even">
<td><code>tstop</code></td>
<td>end of interval</td>
</tr>
<tr class="odd">
<td><code>tx</code></td>
<td>treatment code, 1 = thiotepa</td>
</tr>
<tr class="even">
<td><code>num</code></td>
<td>number of initial tumors</td>
</tr>
<tr class="odd">
<td><code>size</code></td>
<td>size of initial tumors (cm)</td>
</tr>
</tbody>
</table>
<ul>
<li>There are 85 patients and 190 lines in the dataset, meaning that many patients have more than one line.</li>
<li>Patient 1 with 0 observation time was removed.</li>
<li>Of the 85 patients, 47 had at least one recurrence and 38 had none.</li>
<li>18 patients had exactly one recurrence.</li>
<li>There were up to 4 recurrences in a patient.</li>
<li>Of the 190 intervals, 112 terminated with a recurrence and 78 were censored.</li>
</ul></section><section id="different-intervals-for-the-same-patient-are-correlated." class="level4"><h4 class="anchored" data-anchor-id="different-intervals-for-the-same-patient-are-correlated.">Different intervals for the same patient are correlated.</h4>
<ul>
<li><p>Is the effective sample size 47 or 112? This might narrow confidence intervals by as much as a factor of <span class="math inline">\(\sqrt{112/47}=1.54\)</span></p></li>
<li><p>What happens if I have 5 treatment and 5 control values and want to do a t-test and I then duplicate the 10 values as if the sample size was 20? This falsely narrows confidence intervals by a factor of <span class="math inline">\(\sqrt{2}=1.41\)</span>.</p></li>
</ul>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bladder</span> <span class="op">=</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"http://web1.sph.emory.edu/dkleinb/allDatasets"</span>,</span>
<span>    <span class="st">"/surv2datasets/bladder.dta"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://haven.tidyverse.org/reference/read_dta.html">read_dta</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bladder</span> <span class="op">=</span> <span class="va">bladder</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>,<span class="op">]</span>  <span class="co">#remove subject with 0 observation time</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">bladder</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="va">bladder</span> <span class="op">=</span> </span>
<span>  <span class="va">bladder</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    surv <span class="op">=</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span></span>
<span>        time <span class="op">=</span> <span class="va">start</span>,</span>
<span>        time2 <span class="op">=</span> <span class="va">stop</span>,</span>
<span>        event <span class="op">=</span> <span class="va">event</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"counting"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bladder.cox1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span><span class="op">~</span><span class="va">tx</span><span class="op">+</span><span class="va">num</span><span class="op">+</span><span class="va">size</span>,</span>
<span>  data <span class="op">=</span> <span class="va">bladder</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#results with biased variance-covariance matrix:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">bladder.cox1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = surv ~ tx + num + size, data = bladder)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 190, number of events= 112 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         coef exp(coef) se(coef)     z Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; tx   -0.4116    0.6626   0.1999 -2.06  0.03947 *  </span></span>
<span><span class="co">#&gt; num   0.1637    1.1778   0.0478  3.43  0.00061 ***</span></span>
<span><span class="co">#&gt; size -0.0411    0.9598   0.0703 -0.58  0.55897    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; tx       0.663      1.509     0.448      0.98</span></span>
<span><span class="co">#&gt; num      1.178      0.849     1.073      1.29</span></span>
<span><span class="co">#&gt; size     0.960      1.042     0.836      1.10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.624  (se = 0.032 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 14.7  on 3 df,   p=0.002</span></span>
<span><span class="co">#&gt; Wald test            = 15.9  on 3 df,   p=0.001</span></span>
<span><span class="co">#&gt; Score (logrank) test = 16.2  on 3 df,   p=0.001</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The likelihood ratio and score tests assume independence of observations within a cluster. The Wald and robust score tests do not.</p>
</div>
</div>
</section><section id="adding-cluster-id" class="level4"><h4 class="anchored" data-anchor-id="adding-cluster-id">adding <code>cluster = id</code>
</h4>
<p>If we add <code>cluster= id</code> to the call to <code>coxph</code>, the coefficient estimates don’t change, but we get an additional column in the <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> output: <code>robust se</code>:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="va">bladder.cox2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">surv</span> <span class="op">~</span> <span class="va">tx</span> <span class="op">+</span> <span class="va">num</span> <span class="op">+</span> <span class="va">size</span>,</span>
<span>  cluster <span class="op">=</span> <span class="va">id</span>,</span>
<span>  data <span class="op">=</span> <span class="va">bladder</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#unbiased though this reduces power:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">bladder.cox2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = surv ~ tx + num + size, data = bladder, cluster = id)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 190, number of events= 112 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         coef exp(coef) se(coef) robust se     z Pr(&gt;|z|)   </span></span>
<span><span class="co">#&gt; tx   -0.4116    0.6626   0.1999    0.2488 -1.65   0.0980 . </span></span>
<span><span class="co">#&gt; num   0.1637    1.1778   0.0478    0.0584  2.80   0.0051 **</span></span>
<span><span class="co">#&gt; size -0.0411    0.9598   0.0703    0.0742 -0.55   0.5799   </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; tx       0.663      1.509     0.407      1.08</span></span>
<span><span class="co">#&gt; num      1.178      0.849     1.050      1.32</span></span>
<span><span class="co">#&gt; size     0.960      1.042     0.830      1.11</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.624  (se = 0.031 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 14.7  on 3 df,   p=0.002</span></span>
<span><span class="co">#&gt; Wald test            = 11.2  on 3 df,   p=0.01</span></span>
<span><span class="co">#&gt; Score (logrank) test = 16.2  on 3 df,   p=0.001,   Robust = 10.8  p=0.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   (Note: the likelihood ratio and score tests assume independence of</span></span>
<span><span class="co">#&gt;      observations within a cluster, the Wald and robust score tests do not).</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><code>robust se</code> is larger than <code>se</code>, and accounts for the repeated observations from the same individuals:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">bladder.cox2</span><span class="op">$</span><span class="va">naive.var</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;         [,1]    [,2]   [,3]</span></span>
<span><span class="co">#&gt; [1,]  0.0400 -0.0014 0.0000</span></span>
<span><span class="co">#&gt; [2,] -0.0014  0.0023 0.0007</span></span>
<span><span class="co">#&gt; [3,]  0.0000  0.0007 0.0049</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">bladder.cox2</span><span class="op">$</span><span class="va">var</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;         [,1]    [,2]    [,3]</span></span>
<span><span class="co">#&gt; [1,]  0.0619 -0.0026 -0.0004</span></span>
<span><span class="co">#&gt; [2,] -0.0026  0.0034  0.0013</span></span>
<span><span class="co">#&gt; [3,] -0.0004  0.0013  0.0055</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>These are the ratios of correct confidence intervals to naive ones:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">bladder.cox2</span>, <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">naive.var</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.24449 1.22309 1.05576</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We might try dropping the non-significant <code>size</code> variable:</p>
<div class="cell">
<details class="code-fold"><summary>Show R code</summary><div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#remove non-significant size variable:</span></span>
<span><span class="va">bladder.cox3</span> <span class="op">=</span> <span class="va">bladder.cox2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">size</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">bladder.cox3</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = surv ~ tx + num, data = bladder, cluster = id)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   n= 190, number of events= 112 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;        coef exp(coef) se(coef) robust se     z Pr(&gt;|z|)   </span></span>
<span><span class="co">#&gt; tx  -0.4117    0.6625   0.2003    0.2515 -1.64   0.1017   </span></span>
<span><span class="co">#&gt; num  0.1700    1.1853   0.0465    0.0564  3.02   0.0026 **</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     exp(coef) exp(-coef) lower .95 upper .95</span></span>
<span><span class="co">#&gt; tx      0.663      1.509     0.405      1.08</span></span>
<span><span class="co">#&gt; num     1.185      0.844     1.061      1.32</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Concordance= 0.623  (se = 0.031 )</span></span>
<span><span class="co">#&gt; Likelihood ratio test= 14.3  on 2 df,   p=8e-04</span></span>
<span><span class="co">#&gt; Wald test            = 10.2  on 2 df,   p=0.006</span></span>
<span><span class="co">#&gt; Score (logrank) test = 15.8  on 2 df,   p=4e-04,   Robust = 10.6  p=0.005</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   (Note: the likelihood ratio and score tests assume independence of</span></span>
<span><span class="co">#&gt;      observations within a cluster, the Wald and robust score tests do not).</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="hidden">
<p>Ways to check PH assumption:</p>
<ul>
<li>cloglog</li>
<li>schoenfeld residuals</li>
<li>interaction with time</li>
</ul>
</div>
</section></section></section><section id="age-as-the-time-scale" class="level2" data-number="7.16"><h2 data-number="7.16" class="anchored" data-anchor-id="age-as-the-time-scale">
<span class="header-section-number">7.16</span> Age as the time scale</h2>
<p>See <span class="citation" data-cites="canchola2003cox">Canchola et al. (<a href="references.html#ref-canchola2003cox" role="doc-biblioref">2003</a>)</span>.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-canchola2003cox" class="csl-entry" role="listitem">
Canchola, Alison J, Susan L Stewart, Leslie Bernstein, Dee W West, Ronald K Ross, Dennis Deapen, Richard Pinder, et al. 2003. <span>“Cox Regression Using Different Time-Scales.”</span> <em>Western Users of SAS Software</em>. <a href="https://www.lexjansen.com/wuss/2003/DataAnalysis/i-cox_time_scales.pdf">https://www.lexjansen.com/wuss/2003/DataAnalysis/i-cox_time_scales.pdf</a>.
</div>
<div id="ref-copelan1991treatment" class="csl-entry" role="listitem">
Copelan, Edward A, James C Biggs, James M Thompson, Pamela Crilley, Jeff Szer, John P Klein, Neena Kapoor, Belinda R Avalos, Isabel Cunningham, and Kerry Atkinson. 1991. <span>“Treatment for Acute Myelocytic Leukemia with Allogeneic Bone Marrow Transplantation Following Preparation with BuCy2.”</span> <a href="https://doi.org/10.1182/blood.V78.3.838.838">https://doi.org/10.1182/blood.V78.3.838.838</a>.
</div>
<div id="ref-dobson4e" class="csl-entry" role="listitem">
Dobson, Annette J, and Adrian G Barnett. 2018. <em>An Introduction to Generalized Linear Models</em>. 4th ed. CRC press. <a href="https://doi.org/10.1201/9781315182780">https://doi.org/10.1201/9781315182780</a>.
</div>
<div id="ref-grambsch1994proportional" class="csl-entry" role="listitem">
Grambsch, Patricia M, and Terry M Therneau. 1994. <span>“Proportional Hazards Tests and Diagnostics Based on Weighted Residuals.”</span> <em>Biometrika</em> 81 (3): 515–26. <a href="https://doi.org/10.1093/biomet/81.3.515">https://doi.org/10.1093/biomet/81.3.515</a>.
</div>
<div id="ref-klein2003survival" class="csl-entry" role="listitem">
Klein, John P, and Melvin L Moeschberger. 2003. <em>Survival Analysis: Techniques for Censored and Truncated Data</em>. Vol. 1230. Springer. <a href="https://link.springer.com/book/10.1007/b97377">https://link.springer.com/book/10.1007/b97377</a>.
</div>
<div id="ref-kleinbaum2012survival" class="csl-entry" role="listitem">
Kleinbaum, David G, and Mitchel Klein. 2012. <em>Survival Analysis: A Self-Learning Text</em>. 3rd ed. Springer. <a href="https://link.springer.com/book/10.1007/978-1-4419-6646-9">https://link.springer.com/book/10.1007/978-1-4419-6646-9</a>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./intro-to-survival-analysis.html" class="pagination-link" aria-label="Introduction to Survival Analysis">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Introduction to Survival Analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./parametric-survival-models.html" class="pagination-link" aria-label="Parametric survival models">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Parametric survival models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb81" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Proportional Hazards Models</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>{{&lt; include shared-config.qmd &gt;}}</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>{{&lt; include _exr-review-exp-dist.qmd &gt;}}</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="fu">## Understanding proportional hazards models</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>{{&lt; include _sec-understand-coxph.qmd &gt;}}</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a><span class="fu">## Testing the proportional hazards assumption</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>{{&lt; include _sec-test-ph-assumption.qmd &gt;}}</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fitting proportional hazards models to data</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>{{&lt; include _sec_fit-coxph.qmd &gt;}}</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example: Proportional hazards model for the `bmt` data</span></span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>{{&lt; include _sec-exm-coxph-bmt.qmd &gt;}}</span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adjustment for Ties (optional)</span></span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>{{&lt; include _sec_coxph-adjust_ties.qmd &gt;}}</span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>{{&lt; include coxph-model-building.qmd &gt;}}</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
<li class="nav-item">
 Copyright 2024, Douglas Ezra Morrison
  </li>  
</ul>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/d-morrison/rme/edit/main/proportional-hazards-models.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/d-morrison/rme/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li><li><a href="https://github.com/d-morrison/rme/blob/main/proportional-hazards-models.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer><script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>


</body></html>