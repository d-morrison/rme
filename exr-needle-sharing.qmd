```{r}
#| tbl-cap: "Needle-sharing data"
#| label: tbl-needle-data
library(tidyverse)
library(haven)
needles = 
  "inst/extdata/needle_sharing.dta" |> 
  read_dta() |>
  as_tibble() |>
  mutate(
    hivstat =
      hivstat |>
      case_match(
        1 ~ "HIV+",
        0 ~ "HIV-") |> 
      factor() |> 
      relevel(ref = "HIV-"),
    polydrug =
      polydrug |>
      case_match(
        1 ~ "multiple drugs used",
        0 ~ "one drug used") |>
      factor() |>
      relevel(ref = "one drug used"),
    homeless = 
      homeless |> 
      case_match(
        1 ~ "homeless", 
        0 ~ "not homeless") |>
      factor() |>
      relevel(ref = "not homeless"),
    ethn = ethn |> factor() |> relevel(ref = "White"),
    sex = sex |> factor() |> relevel(ref = "M"))
needles
```

---

```{r}
#| fig-cap: "Rates of needle sharing"
#| label: fig-needles
library(ggplot2)

needles |> 
  ggplot(
    aes(
      x = age,
      y = shared_syr,
      shape = sex,
      col = ethn
    )
  ) + 
  geom_point(
    size = 3, 
    alpha = .5) +
  facet_grid(
    cols = vars(sex, polydrug), 
    rows = vars(homeless)) +
  theme(legend.position = "bottom")
```

---

#### Covariate counts

```{r}
#| tbl-cap: "Counts of observations in `needles` dataset by sex, unhoused status, and multiple drug use"
#| label: tbl-count-needles
#| code-fold: show
needles |> 
  dplyr::select(sex, homeless, polydrug) |> 
  summary()
```

---

There's only one individual with `sex = Trans`, 
which unfortunately isn't enough data to analyze.
We will remove that individual:

```{r}
#| label: remove-trans-obs
#| code-summary: 'remove singleton observation with sex == Trans'
needles = needles |> filter(sex != "Trans")

```

---

### Model {.smaller}

```{r}
#| include: false
#| label: needles-pois-model-vittinghoff
glm0 = glm(
  data = needles,
  family = stats::poisson,
  formula = shared_syr ~ homeless
)
```

```{r}
glm1 = 
  needles |> 
  glm(
    offset = logshsyr,
    family = stats::poisson,
    formula = shared_syr ~ age + sex + homeless*polydrug
  )
library(equatiomatic)
equatiomatic::extract_eq(glm1)
```

---

```{r}
#| tbl-cap: "Poisson model for needle-sharing data"
#| label: tbl-needles-pois


library(parameters)
glm1 |> parameters(exponentiate = TRUE) |> 
  print_md()
```

---

```{r}
#| tbl-cap: "fitted Poisson model for needle-sharing data"
#| label: fig-needles-pois
library(sjPlot)
glm1 |> 
  sjPlot::plot_model(
    type = "pred",
    terms = c("age", "sex", "homeless", "polydrug"),
    show.data = TRUE
  ) +
  theme(legend.position = "bottom")
```

