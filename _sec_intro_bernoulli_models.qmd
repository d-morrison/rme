{{< include macros.qmd >}}

## Risk Estimation and Prediction

::: notes
In Epi 203,
you have already seen
methods for modeling binary outcomes
using one covariate that is also binary
(such as exposure/non-exposure).
In this section, we review one-covariate analyses,
with a special focus on risk ratios and odds ratios,
which are important concepts for interpreting logistic regression.
:::

---

:::::{#exm-oc-mi}
### Oral Contraceptive Use and Heart Attack

* Research question:
how does oral contraceptive (OC) use
affect the risk of myocardial infarction (MI; a.k.a. heart attack)?

:::{.notes}
This was an issue when oral contraceptives were first developed,
because the original formulations used
higher concentrations of hormones.
Modern OCs don't have this issue.

@tbl-oc-mi contains simulated data for
an imaginary follow-up (a.k.a. *prospective*) study
in which two groups are identified,
one using OCs and another not using OCs,
and both groups are tracked for three years
to determine how many in each groups have MIs.

:::

:::{#tbl-oc-mi}

```{r}
#| message: false
#| code-fold: true
library(dplyr)
oc_mi <-
  tribble(
    ~OC, ~MI, ~Total,
    "OC use", 13, 5000,
    "No OC use", 7, 10000
  ) |>
  mutate(`No MI` = Total - MI) |>
  relocate(`No MI`, .after = MI)

totals <-
  oc_mi |>
  summarize(across(c(MI, `No MI`, Total), sum)) |>
  mutate(OC = "Total")

tbl_oc_mi <- bind_rows(oc_mi, totals)

tbl_oc_mi |> pander::pander()
```

Simulated data from study of oral contraceptive use and heart attack risk

:::

:::::

---

::::{#exr-probs}

Estimate the probabilities of MI for OC users and non-OC users in @exm-oc-mi.
::::

----

:::{#sol-compute-probs}

```{r, include = FALSE}
#| label: calc-prs
p_MI_OC <- 13 / 5000 # nolint: object_name_linter
p_MI_nOC <- 7 / 10000 # nolint: object_name_linter
```

$$\ph(MI|OC) = \frac{13}{5000} = `r p_MI_OC`$$

$$\ph(MI|\neg OC) = \frac{7}{10000} = `r p_MI_nOC`$$

:::

---

:::{#exr-def-controls}

What does the term "controls" mean in the context of study design?

:::

---

:::{#sol-def-controls}
::::{#def-controls}
##### Two meanings of "controls"

Depending on context, "controls" can mean either:

- individuals who don't experience an *exposure* of interest,
- or individuals who don't experience an *outcome* of interest.

::::
:::

---

:::{#exr-controls-use-cases}
What types of studies do the two definitions of controls correspond to?
:::

---

:::{#sol-controls-use-cases}
:::{#def-cases-retrospective}
##### cases and controls in retrospective studies
In *retrospective case-control studies*,
participants who experience the outcome of interest are called **cases**,
while participants who don't experience that outcome are called **controls**.
:::

:::{#def-cases-prospective}
##### treatment groups and control groups in prospective studies
In *prospective studies*,
the group of participants who experience the treatment or exposure of interest
is called the **treatment group**,
while the participants who receive the baseline or comparison treatment
(for example, clinical trial participants who receive a placebo
or a standard-of-care treatment rather than an experimental treatment)
are called **controls**.

:::
:::

## Comparing probabilities

### Risk differences

::: notes
The simplest comparison of two probabilities, $\pi_1$, and $\pi_2$, is the difference of their values:
:::

:::{#def-RD}
#### Risk difference
The **risk difference** of two probabilities, $\pi_1$, and $\pi_2$, is the difference of their values:
$$\delta(\pi_1,\pi_2) \eqdef \pi_1 - \pi_2$$
:::

---

:::{#exm-RD}

#### Difference in MI risk

In @exm-oc-mi, the maximum likelihood estimate of the difference in MI risk between OC users and OC non-users is:
```{r, include = FALSE}
#| label: compute-risk-diff
rd_OC <- p_MI_OC - p_MI_nOC # nolint: object_name_linter
```

$$
\begin{aligned}
\hat\delta(\pi(OC), \pi(\neg OC))
&= \delta(\hat\pi(OC), \hat\pi(\neg OC))\\
&= \hat\pi(OC) - \hat\pi(\neg OC)\\
&= `r p_MI_OC` - `r p_MI_nOC`\\
&= `r rd_OC`
\end{aligned}
$$

:::

---

:::{#exr-interpret-rr}
#### interpreting risk differences

How can we interpret the preceding relative risk estimate in prose?
:::

---

:::{#sol-interpret-rd}

#### interpreting risk differences

"The difference in risk of MI between OC users and non-users was `r rd_OC`."

or

"The difference in risk of MI between OC users and non-users was `r rd_OC*100`
[percentage points](https://en.wikipedia.org/wiki/Percentage_point)."

:::

::: notes
See the note about working with percentages in the [Appendix](notation.qmd#percent-sign).
:::

---

### Risk ratios

:::{#exr-name-RR}

If $\pi_1$ and $\pi_2$ are two probabilities,
what do we call the following ratio?

$$\rho(\pi_1,\pi_2) = \frac{\pi_1}{\pi_2}$$
:::

---

:::{#sol-exr-name-RR}

:::{#def-RR}
### Relative risk ratios

The ratio of two probabilities $\pi_1$ and $\pi_2$,

$$\rho(\pi_1,\pi_2) = \frac{\pi_1}{\pi_2}$$

is called the:

- **risk ratio**,
- **relative risk ratio**,
- **probability ratio**,
- or **rate ratio**

of $\pi_1$ compared to $\pi_2$.

:::

:::


---

:::{#exr-RR}

:::: notes
Above, we estimated that:
::::

$$\ph(MI|OC) = `r 13/5000`$$

$$\ph(MI|\neg OC) = `r 7/10000`$$

Now, estimate the *relative risk* of MI for OC versus non-OC.

:::

---

:::{#sol-exr-RR}

:::: notes
The *relative risk* of MI for OC versus non-OC is:
::::

```{r}
#| label: compute-risk-ratio
rr <- (13 / 5000) / (7 / 10000)
```

$$
\begin{aligned}
\hat\rho(OC, \neg OC)
&=\frac{\ph(MI|OC)}{\ph(MI|\neg OC)}\\
&= \frac{`r 13/5000`}{`r 7/10000`}\\
&= `r rr`
\end{aligned}
$$

:::

---

:::{#exr-interpret-rr}
How can we interpret the preceding relative risk estimate in prose?
:::

---

:::{#sol-interpret-rr}

:::: notes
We might summarize this result by saying that "the estimated probability of MI among OC users was `r rr` [times as high as]{.underline}, or `r rr - 1` [times higher than]{.underline}, the estimated probability among OC non-users.
::::

:::

---

### Relative risk differences

:::{#def-RRD}

#### Relative risk difference

:::: notes
Sometimes, we divide the risk difference by the comparison probability; the result is called the **relative risk difference**:
::::

$$\xi(\pi_1,\pi_2) \eqdef \frac{\delta(\pi_1,\pi_2)}{\pi_2}$$

:::

---

:::{#thm-rrd-vs-rr}
#### Relative risk difference equals risk ratio minus 1

$$\xi(\pi_1,\pi_2) = \rho(\pi_1,\pi_2) - 1$$
:::

---

::: proof
$$
\begin{aligned}
\xi(\pi_1,\pi_2)
&\eqdef \frac{\delta(\pi_1,\pi_2)}{\pi_2}
\\&= \frac{\pi_1-\pi_2}{\pi_2}
\\&= \frac{\pi_1}{\pi_2} - 1
\\&= \rho(\pi_1,\pi_2) - 1
\end{aligned}
$$
:::

---

### Changing reference groups in risk comparisons

:::: notes
Risk differences, risk ratios, and relative risk differences are defined by two probabilities, plus a choice of which probability is the **baseline** or **reference** probability (i.e., which probability is the subtrahend of the risk difference or the denominator of the risk ratio).
:::

$$\delta(\pi_2,\pi_1) = -\delta(\pi_1, \pi_2)$$

$$\rho(\pi_2,\pi_1) = \inv{\rho(\pi_1,\pi_2)}$$
$$\xi(\pi_2,\pi_1) = \inv{\xi(\pi_1,\pi_2) + 1} - 1$$

:::{#exr-change-ref-group}

Prove the relationships above.

:::

---

:::{#exm-ref}

#### Switching the reference group in a risk ratio

Above, we estimated that the risk ratio of OC versus non-OC is:

$$
\begin{aligned}
\rho(OC, \neg OC)
&= `r (13/5000)/(7/10000)`
\end{aligned}
$$

In comparison, the risk ratio for non-OC versus OC is:

$$
\begin{aligned}
\rho(\neg OC, OC)
&=\frac{\ph(MI|\neg OC)}{\ph(MI|OC)}\\
&= \frac{`r 7/10000`}{`r 13/5000`}\\
&= `r (7/10000)/(13/5000)`\\
&= \frac{1}{\rho(OC, \neg OC)}
\end{aligned}
$$

:::

## Odds and Odds Ratios

{{< include _sec_odds.qmd >}}

## The logit and expit functions

### The logit function

:::{#def-logit}

#### logit function

::: notes
The **logit function**  of a probability $\pi$ is
the natural logarithm of the [odds function](#def-odds) of $\pi$:
:::

$$\logit(\pi) \eqdef \logf{\odds(\pi)}$$

:::

---

::: notes
@fig-logit shows the shape of the $\logit()$ function.
:::

```{r}
#| code-fold: true
#| fig-cap: "The logit function"
#| label: fig-logit

odds <- function(pi) pi / (1 - pi)

logit <- function(p) log(odds(p))

library(ggplot2)
logit_plot <-
  ggplot() +
  geom_function(
    fun = logit,
    arrow = arrow(ends = "both")
  ) +
  xlim(.001, .999) +
  ylab("logit(p)") +
  xlab("p") +
  theme_bw()
print(logit_plot)
```

---


---

:::{#exr-prove-eq-logit}

#### Compose the logit function

Mathematically expand the definition of the logit function.

:::

---

:::{#sol-prove-eq-logit}
#### Compose the logit function

:::{#thm-logit-function}
#### Expanded expression for logit
$$\logit(\pi) = \logf{\frac{\pi}{1-\pi}}$${#eq-logit}

:::

::: proof
Apply @def-logit and then @def-odds (details left to the reader).
:::

:::

---

:::{#thm-deriv-logit}

#### Derivative of logit function

$$\logit'(\pi) = \frac{1}{(\pi)(1-\pi)}$$
:::

---

::: proof

$$
\ba
\logit'(\pi)
   &= \deriv{\pi}\logit(\pi)
\\ &= \deriv{\pi}\logf{\odds(\pi)}
\\ &= \frac{\odds'(\pi)}{\odds(\pi)}
\\ &= \odds'(\pi) \frac{1}{\odds(\pi)}
\\ &= \frac{1}{\sqf{1-\pi}}\frac{1-\pi}{\pi}
\\ &= \frac{1}{(\pi)(1-\pi)}
\ea
$$

:::

---

### The expit function

:::{#def-expit}

#### expit, logistic, inverse-logit

The **expit function** (@fig-expit-plot) of a log-odds $\logodds$, also known as the **inverse-logit function** or **logistic function**, is the inverse-odds of the exponential of $\logodds$:

$$\expit(\logodds) \eqdef \oddsinvf{\expf{\logodds}}$$

:::

```{r}
#| label: fig-expit-plot
#| fig-cap: The expit function
#| code-fold: true
expit <- function(eta) {
  exp(eta) / (1 + exp(eta))
}
library(ggplot2)
expit_plot <-
  ggplot() +
  geom_function(
    fun = expit,
    arrow = arrow(ends = "both")
  ) +
  xlim(-8, 8) +
  ylim(0, 1) +
  ylab(expression(expit(eta))) +
  xlab(expression(eta)) +
  theme_bw()
print(expit_plot)
```

---

:::{#thm-logit-expit}
#### logit and expit are each others' inverses

$$\logitf{\expitf{\logodds}} = \logodds$$

$$\expitf{\logitf{\pi}} = \pi$$

:::

---

:::{.proof}
Left to the reader.
:::

---

:::{#thm-expit}

#### Expressions for expit function

$$
\ba
\expit(\logodds)
   &= \frac{\exp{\logodds}}{1+\exp{\logodds}}
\\ &= \frac{1}{1 + \exp{-\logodds})}
\\ &= (1 + \exp{-\logodds})^{-1}
\ea
$$
:::

---

::: proof
Apply definitions and @lem-invodds-simplified.
Details left to the reader.
:::

---


:::{#lem-one-minus-expit}
$$1-\expitf{\logodds} = \inv{1+\exp{\logodds}}$$
:::

---

::: {.proof}

Using @lem-one-minus-odds-inv:

$$
\ba
1 - \expitf{\logodds} &= 1 - \oddsinvf{\expf{\logodds}}
\\ &= \frac{1}{1+\expf{\logodds}}
\\ &= \inv{1 + \exp{\logodds}}
\ea
$$
:::

---

:::{#lem-deriv-expit}
$$\dexpitf{\logodds} = (\expitf{\logodds}) (1 - \expitf{\logodds})$$
:::

---

::: proof

Using @lem-deriv-invodds:

$$
\ba
\dexpitf{\logodds}
   &= \deriv{\logodds} \expitf{\logodds}
\\ &= \deriv{\logodds} \invoddsf{\expf{\logodds}}
\\ &= \dinvoddsf{\expf{\logodds}}  \deriv{\logodds}\expf{\logodds}
\\ &=  \frac{1}{\sqf{1 + \expf{\logodds}}} \expf{\logodds}
\\ &=  \frac{\expf{\logodds}}{\sqf{1 + \expf{\logodds}}}
\\ &=  \frac{\expf{\logodds}}{1 + \expf{\logodds}} \frac{1}{1 + \expf{\logodds}}
\\ &=  \expitf{\logodds} (1-\expitf{\logodds})
\ea
$$

:::

---

::: proof

Alternatively, we can use @thm-expit:

$$
\ba
\dexpitf{\logodds}
   &= \deriv{\logodds} \expitf{\logodds}
\\ &= \deriv{\logodds} (1 + \exp{-\logodds})^{-1}
\\ &= -(1 + \exp{-\logodds})^{-2} \deriv{\logodds} (1 + \exp{-\logodds})
\\ &= -(1 + \exp{-\logodds})^{-2} (-\exp{-\logodds})
\\ &= (1 + \exp{-\logodds})^{-2} (\exp{-\logodds})
\\ &= (1 + \exp{-\logodds})^{-1} \frac{\exp{-\logodds}}{1 + \exp{-\logodds}}
\\ &= (1 + \exp{-\logodds})^{-1} \frac{1}{1 + \exp{\logodds}}
\\ &= \expitf{\logodds} (1-\expitf{\logodds})
\ea
$$
:::

### Diagram of expit and logit {#sec-expit-logit-diagram}

{{< include _sec_logistic-link-diagram.qmd >}}
